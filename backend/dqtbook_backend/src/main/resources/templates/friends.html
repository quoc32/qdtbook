<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Friends</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    body { background:#f8f9fa; }
    .friend-card:hover { background:#f1f3f5; cursor:pointer; }
    .avatar {
      width:48px;height:48px;border-radius:50%;object-fit:cover;
      background:#dee2e6;display:inline-flex;align-items:center;justify-content:center;
      font-weight:600;color:#495057;
    }
    .status-dot {
      width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;
    }
    .status-online { background:#28a745; }
    .status-offline { background:#adb5bd; }
    .truncate {
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:180px;display:inline-block;
    }
  </style>
</head>
<body>
  <!-- Nhúng fragment navbar -->
  <div th:replace="fragments/navbar :: navbar"></div>

  <!-- Main:BEGIN -->
  <main class="container">
    <!-- Search bar:BEGIN -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text">Search</span>
          <input id="searchInput" class="form-control" placeholder="Search friends..." autocomplete="off">
          <button class="btn btn-outline-secondary" id="clearSearchBtn">&times;</button>
        </div>
      </div>
    </div>
    <!-- Search bar:END -->

    <!-- Main__ -->
    <div class="row g-4">

      <!-- Friends List:BEGIN -->
      <div class="col-lg-7">
        <div class="card shadow-sm">
          <div class="card-header d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">Your Friends</h6>
          <span class="badge bg-primary" id="friendsCount">0</span>
        </div>
        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addFriendModal">
          + Add
        </button>
          </div>
          <ul class="list-group list-group-flush" id="friendsList">
        <!-- Friends injected here -->
          </ul>
          <div class="card-body text-center small text-muted" id="friendsEmptyState" style="display:none;">
        No friends yet. Add someone to get started.
          </div>
        </div>
           
        <!-- Add Friend Modal:BEGIN -->
        <div class="modal fade" id="addFriendModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <form class="modal-content" id="addFriendForm">

              <div class="modal-header">
          <h5 class="modal-title">Thêm bạn bè</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
              </div>

              <div class="modal-body">
          <label class="form-label">Email người dùng</label>
          <input class="form-control" id="addFriendInput" required autocomplete="off" placeholder="nhapemail@example.com" />
          <div class="form-text">Nhập chính xác email của người bạn muốn kết bạn.</div>
          <div class="alert alert-danger py-2 px-3 mt-3 d-none" id="addFriendError"></div>
          <div class="alert alert-success py-2 px-3 mt-3 d-none" id="addFriendSuccess"></div>
              </div>

              <div class="modal-footer">
          <button type="submit" class="btn btn-primary">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="addFriendSpinner"></span>
            Gửi lời mời
          </button>
              </div>

            </form>
          </div>
        </div>

        <script>
          // Ghi đè handler mặc định phía dưới bằng cách chặn propagation
          (function(){
            const form = document.getElementById('addFriendForm');
            const input = document.getElementById('addFriendInput');
            const errEl = document.getElementById('addFriendError');
            const okEl = document.getElementById('addFriendSuccess');
            const spinner = document.getElementById('addFriendSpinner');

            function setState({loading=false,error='',success=''}){
              if (loading) spinner.classList.remove('d-none'); else spinner.classList.add('d-none');
              if (error){
                errEl.textContent = error;
                errEl.classList.remove('d-none');
              } else errEl.classList.add('d-none');
              if (success){
                okEl.textContent = success;
                okEl.classList.remove('d-none');
              } else okEl.classList.add('d-none');
            }

            form.addEventListener('submit', async (e)=>{
              e.preventDefault();
              e.stopImmediatePropagation(); // Ngăn listener cũ (POST /api/friends/requests)
              const email = input.value.trim();
              if(!email){
                setState({error:'Vui lòng nhập email.'});
                return;
              }
              setState({loading:true});
              try {
                const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                const senderId = auth?.user_id;
                if(!senderId){
                  throw new Error('Không xác định được người dùng hiện tại.');
                }

                // 1. Tìm user theo email
                const findRes = await fetch(`/api/users/find/by-email?email=${encodeURIComponent(email)}`, {
                  method:'GET',
                  credentials:'include'
                });
                if(!findRes.ok){
                  throw new Error('Không tìm thấy email này.');
                }
                const userData = await findRes.json();
                const receiverId = userData?.id;
                if(!receiverId){
                  throw new Error('Phản hồi không hợp lệ.');
                }
                if(Number(receiverId) === Number(senderId)){
                  throw new Error('Không thể tự kết bạn với chính mình.');
                }

                // 2. Gửi request kết bạn
                const reqRes = await fetch('/api/friends/request', {
                  method:'POST',
                  credentials:'include',
                  headers:{'Content-Type':'application/json'},
                  body: JSON.stringify({
                    sender_id: Number(senderId),
                    receiver_id: Number(receiverId)
                  })
                });
                if(!reqRes.ok){
                  let msg = 'Gửi lời mời thất bại.';
                  try { const j = await reqRes.json(); if(j.message) msg = j.message; } catch {}
                  throw new Error(msg);
                }

                setState({success:'Đã gửi lời mời kết bạn.'});
                input.value = '';
                setTimeout(()=>{
                  setState({});
                  const modal = bootstrap.Modal.getInstance(document.getElementById('addFriendModal'));
                  modal && modal.hide();
                  document.dispatchEvent(new Event('friends:refresh'));
                }, 1000);

              } catch(err){
              setState({error: err.message || 'Lỗi không xác định.'});
              } finally {
                setState({
                  loading:false,
                  error: !errEl.classList.contains('d-none') ? errEl.textContent : '',
                  success: !okEl.classList.contains('d-none') ? okEl.textContent : ''
                });
              }
            }, {capture:true}); // capture để đảm bảo chạy trước nếu có

          })();
        </script>
        <!-- Add Friend Modal:END -->

        <script>
          (function () {
            const friendsListEl = document.getElementById('friendsList');
            const friendsCountEl = document.getElementById('friendsCount');
            const friendsEmptyEl = document.getElementById('friendsEmptyState');

            const addFriendForm = document.getElementById('addFriendForm');
            const addFriendInput = document.getElementById('addFriendInput');
            const addFriendError = document.getElementById('addFriendError');
            const addFriendSuccess = document.getElementById('addFriendSuccess');
            const addFriendSpinner = document.getElementById('addFriendSpinner');

            function setAddFriendState({ loading = false, error = '', success = '' }) {
              if (loading) addFriendSpinner.classList.remove('d-none'); else addFriendSpinner.classList.add('d-none');
              if (error) {
                addFriendError.textContent = error;
                addFriendError.classList.remove('d-none');
              } else addFriendError.classList.add('d-none');
              if (success) {
                addFriendSuccess.textContent = success;
                addFriendSuccess.classList.remove('d-none');
              } else addFriendSuccess.classList.add('d-none');
            }

            // Khi trang tải, lấy danh sách bạn bè, gọi renderFriends với array bạn bè
            async function fetchFriends() {
              try {
                const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                const user_id = auth?.user_id;
                const res = await fetch(`/api/friends/${user_id}`, { credentials: 'include' });
                if (!res.ok) throw new Error('Failed to load friends');
                const data = await res.json();
                let friendsArr = Array.isArray(data) ? data : (data.friends || []);
                // Exclude entries whose status is pending (case-insensitive)
                friendsArr = friendsArr.filter(f => (f.status || f.friend_status || '').toLowerCase() !== 'pending');
                renderFriends(friendsArr);
              } catch (e) {
                friendsListEl.innerHTML = '<li class="list-group-item text-danger small">Error loading friends.</li>';
                friendsCountEl.textContent = '0';
              }
            }

            function renderFriends(friends) {
              friendsListEl.innerHTML = '';
              if (!friends.length) {
              friendsEmptyEl.style.display = '';
              friendsCountEl.textContent = '0';
              return;
              }
              friendsEmptyEl.style.display = 'none';
              friendsCountEl.textContent = friends.length;
              const frag = document.createDocumentFragment();
              friends.forEach(f => {
              const li = document.createElement('li');
              li.className = 'list-group-item friend-card d-flex align-items-center justify-content-between';
              li.dataset.id = f.id;
              const fullName = (f.friend_info?.full_name || f.username || 'Unknown').trim();
              const email = f.friend_info?.email || 'Unknown';
              const avatarUrl = f.friend_info?.avatar_url || f.friend_info?.avatarUrl;
              const initials = fullName.charAt(0).toUpperCase();
              const avatarHtml = avatarUrl
                ? `<img src="${escapeHtml(avatarUrl)}" class="avatar" alt="${escapeHtml(fullName)}">`
                : `<div class="avatar">${escapeHtml(initials)}</div>`;
                li.innerHTML = `
                <div class="d-flex align-items-center gap-3">
                  ${avatarHtml}
                  <div>
                  <div class="fw-semibold">${escapeHtml(fullName)}</div>
                  <div class="small text-muted truncate">${escapeHtml(email)}</div>
                  </div>
                </div>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                  Tùy chọn
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item view-profile-btn" href="#" data-id="${escapeHtml(f.id)}">Xem trang cá nhân</a></li>
                  <li><a class="dropdown-item remove-friend-btn text-danger" href="#">Hủy kết bạn</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item block-friend-btn text-warning" href="#" data-id="${escapeHtml(f.id)}">Block</a></li>
                  </ul>
                </div>
              `;
              frag.appendChild(li);
              });
              friendsListEl.appendChild(frag);
            }

            function escapeHtml(str) {
              return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            }

            addFriendForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const value = addFriendInput.value.trim();
              if (!value) return setAddFriendState({ error: 'Value required.' });
              setAddFriendState({ loading: true });
              try {
                const res = await fetch('/api/friends/requests', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ identifier: value })
                });
                if (!res.ok) {
              let msg = 'Request failed';
              try { const j = await res.json(); if (j.message) msg = j.message; } catch {}
              throw new Error(msg);
                }
                setAddFriendState({ success: 'Request sent.' });
                addFriendInput.value = '';
                setTimeout(() => {
              setAddFriendState({});
              const modal = bootstrap.Modal.getInstance(document.getElementById('addFriendModal'));
              modal && modal.hide();
                }, 1000);
              } catch (err) {
                setAddFriendState({ error: err.message || 'Error.' });
              } finally {
                setAddFriendState({ loading: false, error: addFriendError.textContent, success: addFriendSuccess.textContent });
              }
            });

            friendsListEl.addEventListener('click', (e) => {
              const btn = e.target.closest('.remove-friend-btn');
              if (!btn) return;
              const li = btn.closest('li');
              const id = li?.dataset.id;
              if (!id) return;
              const name = li.querySelector('.fw-semibold')?.textContent || '';
              const modalEl = document.getElementById('removeFriendModal');
              if (!modalEl) return;
              modalEl.querySelector('#removeFriendId').value = id;
              modalEl.querySelector('#removeFriendName').textContent = name;
              new bootstrap.Modal(modalEl).show();
            });

            document.addEventListener('friends:refresh', fetchFriends);

            fetchFriends();
          })();
        </script>

      </div>
      <!-- Friends List:END -->

      <!-- Requests / Actions -->
      <div class="col-lg-5">
        <!-- Incoming requests:BEGIN -->
        <div class="card shadow-sm mb-4">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Incoming Requests (Pending)</h6>
            <span class="badge bg-warning text-dark" id="incomingCount">0</span>
          </div>
          <ul class="list-group list-group-flush" id="incomingList"></ul>
          <div class="card-body text-center small text-muted" id="incomingEmpty" style="display:none;">
            No incoming requests.
          </div>
        </div>

        <script>
          (function () {
            const incomingListEl = document.getElementById('incomingList');
            const incomingCountEl = document.getElementById('incomingCount');
            const incomingEmptyEl = document.getElementById('incomingEmpty');

            function escapeHtml(str) {
              return String(str || '')
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;');
            }

            async function fetchIncoming() {
              try {
                const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                const user_id = auth?.user_id;
                if (!user_id) return;
                // Reuse friends endpoint then filter pending (status = pending)
                const res = await fetch(`/api/friends/${user_id}`, { credentials: 'include' });
                if (!res.ok) throw new Error();
                const data = await res.json();
                let arr = Array.isArray(data) ? data : (data.friends || []);
                arr = arr.filter(f => {
                  const status = (f.status || f.friend_status || '').toLowerCase();
                  console.log(f.sender_id, user_id, status);
                  return status === 'pending' && Number(f.sender_id || f.senderId) !== Number(user_id);
                });
                renderIncoming(arr);
              } catch {
                incomingListEl.innerHTML = '<li class="list-group-item text-danger small">Error loading.</li>';
                incomingCountEl.textContent = '0';
              }
            }

            function renderIncoming(requests) {
              incomingListEl.innerHTML = '';
              if (!requests.length) {
                incomingEmptyEl.style.display = '';
                incomingCountEl.textContent = '0';
                return;
              }
              incomingEmptyEl.style.display = 'none';
              incomingCountEl.textContent = requests.length;
              const frag = document.createDocumentFragment();
              requests.forEach(r => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex align-items-center justify-content-between';
                li.dataset.id = r.sender_id || r.id;
                const fullName = (r.friend_info?.full_name || r.username || 'Unknown').trim();
                const email = r.friend_info?.email || '';
                const avatarUrl = r.friend_info?.avatar_url || r.friend_info?.avatarUrl;
                const initials = fullName.charAt(0).toUpperCase();
                const avatarHtml = avatarUrl
                  ? `<img src="${escapeHtml(avatarUrl)}" class="avatar" alt="${escapeHtml(fullName)}">`
                  : `<div class="avatar">${escapeHtml(initials)}</div>`;
                li.innerHTML = `
                  <div class="d-flex align-items-center gap-3">
                    ${avatarHtml}
                    <div>
                      <div class="fw-semibold">${escapeHtml(fullName)}</div>
                      <div class="small text-muted truncate">${escapeHtml(email)}</div>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary accept-btn">Accept</button>
                    <button class="btn btn-sm btn-outline-danger decline-btn">Decline</button>
                  </div>
                `;
          frag.appendChild(li);
              });
              incomingListEl.appendChild(frag);
            }

            async function handleAction(id, action) {
              if (!id) return;
              const li = document.querySelector(`#incomingList li[data-id="${id}"]`);
              const auth = JSON.parse(localStorage.getItem('auth')||'{}');
              const currentUserId = auth?.user_id;
              // Try to read explicit data attributes if they exist; fallback assumptions
              const sender_id = currentUserId;     // backend should really provide sender_id
              const receiver_id = li?.dataset.receiverId || id; // backend should really provide receiver_id
              const url = action === 'accept' ? '/api/friends/accept' : '/api/friends/refuse';
              try {
              const res = await fetch(url, {
                method: 'PUT',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                sender_id: Number(sender_id),
                receiver_id: Number(receiver_id)
                })
              });
              if (!res.ok) throw new Error('Failed');
              fetchIncoming();
              document.dispatchEvent(new Event('friends:refresh'));
              showTempToast(`${action === 'accept' ? 'Accepted' : 'Declined'} successfully`, 'success');
              } catch (e) {
              showTempToast(`${action === 'accept' ? 'Accept' : 'Decline'} failed`, 'danger');
              }
            }

            function showTempToast(msg, type='info') {
              const container = document.getElementById('toastContainer');
              if (!container) return;
              const id = 't' + Date.now();
              const el = document.createElement('div');
              el.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
              el.role = 'alert';
              el.innerHTML = `
                <div class="d-flex">
                  <div class="toast-body">${escapeHtml(msg)}</div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
              `;
              container.appendChild(el);
              setTimeout(()=> el.remove(), 4000);
            }

            incomingListEl.addEventListener('click', (e) => {
              const li = e.target.closest('li');
              if (!li) return;
              const id = li.dataset.id;
              if (e.target.closest('.accept-btn')) {
                disableRow(li, true);
                handleAction(id, 'accept').finally(()=> disableRow(li, false));
              } else if (e.target.closest('.decline-btn')) {
                disableRow(li, true);
                handleAction(id, 'decline').finally(()=> disableRow(li, false));
              }
            });

            function disableRow(li, state) {
              li.querySelectorAll('button').forEach(b => {
                b.disabled = state;
                if (state) b.dataset.originalText = b.textContent;
                b.textContent = state ? '...' : b.dataset.originalText || b.textContent;
              });
            }

            document.addEventListener('friends:refresh', fetchIncoming);
            fetchIncoming();
          })();
        </script>
        <!-- Incoming requests:END -->

        <!-- Outgoing requests:BEGIN -->
        <div class="card shadow-sm">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Outgoing Requests (Pending)</h6>
            <span class="badge bg-info text-dark" id="outgoingCount">0</span>
          </div>
          <ul class="list-group list-group-flush" id="outgoingList"></ul>
          <div class="card-body text-center small text-muted" id="outgoingEmpty" style="display:none;">
            No pending outgoing requests.
          </div>
        </div>

        <script>
          (function(){
            const outgoingListEl = document.getElementById('outgoingList');
            const outgoingCountEl = document.getElementById('outgoingCount');
            const outgoingEmptyEl = document.getElementById('outgoingEmpty');

            function escapeHtml(str){
              return String(str||'')
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
            }

            function showTempToast(msg,type='info'){
              const container = document.getElementById('toastContainer');
              if(!container) return;
              const el = document.createElement('div');
              el.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
              el.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${escapeHtml(msg)}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>`;
              container.appendChild(el);
              setTimeout(()=> el.remove(),4000);
            }

            async function fetchOutgoing(){
              try{
          const auth = JSON.parse(localStorage.getItem('auth')||'{}');
          const user_id = auth?.user_id;
          if(!user_id){
            renderOutgoing([]);
            return;
          }
          const res = await fetch(`/api/friends/${user_id}`, { credentials:'include' });
          if(!res.ok) throw new Error();
          const data = await res.json();
          let arr = Array.isArray(data) ? data : (data.friends||[]);
          // Pending where current user is sender
          arr = arr.filter(r => {
            const status = (r.status || r.friend_status || '').toLowerCase();
            return status === 'pending' && Number(r.sender_id || r.senderId) === Number(user_id);
          });
          renderOutgoing(arr);
              }catch{
          outgoingListEl.innerHTML = '<li class="list-group-item text-danger small">Error loading.</li>';
          outgoingEmptyEl.style.display='none';
          outgoingCountEl.textContent='0';
              }
            }

            function renderOutgoing(list){
              outgoingListEl.innerHTML='';
              if(!list.length){
          outgoingEmptyEl.style.display='';
          outgoingCountEl.textContent='0';
          return;
              }
              outgoingEmptyEl.style.display='none';
              outgoingCountEl.textContent = list.length;
              const frag = document.createDocumentFragment();
              list.forEach(r=>{
          const li = document.createElement('li');
          li.className='list-group-item d-flex align-items-center justify-content-between';
          // Receiver (the person we sent to)
          const fullName = (r.friend_info?.full_name || r.username || 'Unknown').trim();
          const email = r.friend_info?.email || '';
          const avatarUrl = r.friend_info?.avatar_url || r.friend_info?.avatarUrl;
          const initials = fullName.charAt(0).toUpperCase();
          li.dataset.receiverId = r.receiver_id || r.receiverId || r.friend_info?.id || r.id;
          const avatarHtml = avatarUrl
            ? `<img src="${escapeHtml(avatarUrl)}" class="avatar" alt="${escapeHtml(fullName)}">`
            : `<div class="avatar">${escapeHtml(initials)}</div>`;
          li.innerHTML = `
            <div class="d-flex align-items-center gap-3">
              ${avatarHtml}
              <div>
                <div class="fw-semibold">${escapeHtml(fullName)}</div>
                <div class="small text-muted truncate">${escapeHtml(email)}</div>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-danger cancel-btn">Hủy</button>
            </div>
          `;
          frag.appendChild(li);
              });
              outgoingListEl.appendChild(frag);
            }

            async function cancelRequest(li){
              if(!li) return;
              const auth = JSON.parse(localStorage.getItem('auth')||'{}');
              const sender_id = auth?.user_id;
              const receiver_id = li.dataset.receiverId;
              if(!sender_id || !receiver_id) return;
              const btn = li.querySelector('.cancel-btn');
              btn.disabled = true;
              const original = btn.textContent;
              btn.textContent='...';
              try{
          // Using same refuse endpoint to cancel our pending request
          const res = await fetch('/api/friends/refuse', {
            method:'PUT',
            credentials:'include',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              sender_id: Number(sender_id),
              receiver_id: Number(receiver_id)
            })
          });
          if(!res.ok) throw new Error('Cancel failed');
          showTempToast('Đã hủy lời mời','success');
          fetchOutgoing();
          document.dispatchEvent(new Event('friends:refresh'));
              }catch(e){
          showTempToast(e.message || 'Hủy thất bại','danger');
          btn.disabled=false;
          btn.textContent=original;
              }
            }

            outgoingListEl.addEventListener('click', e=>{
              const btn = e.target.closest('.cancel-btn');
              if(!btn) return;
              const li = btn.closest('li');
              cancelRequest(li);
            });

            document.addEventListener('friends:refresh', fetchOutgoing);
            fetchOutgoing();
          })();
        </script>
        <!-- Outgoing requests:END -->

      </div>

    </div>

    <!-- Suggested Friends:BEGIN -->
    <div class="row mt-5">
      <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">Có thể bạn quen</h6>
          <span class="badge bg-secondary" id="suggestionsCount">0</span>
        </div>
        <div class="d-flex gap-2">
          <input id="suggestionsSearch" class="form-control form-control-sm" style="max-width:180px" placeholder="Tìm...">
          <button class="btn btn-sm btn-outline-primary" id="refreshSuggestionsBtn">Làm mới</button>
        </div>
        </div>
        <ul class="list-group list-group-flush" id="suggestionsList"></ul>
        <div class="card-body text-center small text-muted" id="suggestionsEmpty" style="display:none;">
        Chưa có gợi ý nào.
        </div>
      </div>
      </div>
    </div>

    <script>
      (function(){
      const listEl = document.getElementById('suggestionsList');
      const emptyEl = document.getElementById('suggestionsEmpty');
      const countEl = document.getElementById('suggestionsCount');
      const refreshBtn = document.getElementById('refreshSuggestionsBtn');
      const searchInput = document.getElementById('suggestionsSearch');

      let rawSuggestions = [];

      function escapeHtml(str){
        return String(str||'')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
      }

      function showToast(msg,type='info'){
        const container = document.getElementById('toastContainer');
        if(!container) return;
        const el = document.createElement('div');
        el.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
        el.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${escapeHtml(msg)}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
        container.appendChild(el);
        setTimeout(()=> el.remove(),4000);
      }

      async function fetchSuggestions(){
        toggleLoading(true);
        try {
        const auth = JSON.parse(localStorage.getItem('auth')||'{}');
        const user_id = auth?.user_id;
        if(!user_id){
          render([]);
          return;
        }
        // Try primary endpoint
        let res = await fetch(`/api/friends/suggestions?userId=${encodeURIComponent(user_id)}`, { credentials:'include' });
        if(!res.ok){
          // fallback endpoint
          res = await fetch(`/api/users/suggestions?userId=${encodeURIComponent(user_id)}`, { credentials:'include' });
        }
        if(!res.ok) throw new Error();
        const data = await res.json();
        rawSuggestions = Array.isArray(data) ? data : (data.suggestions || data.users || []);
        // Remove already-friends or pending if backend marks them
        rawSuggestions = rawSuggestions.filter(s => {
          const status = (s.status || s.friend_status || '').toLowerCase();
          return status !== 'friend' && status !== 'pending';
        });
        applyFilter();
        } catch {
        listEl.innerHTML = '<li class="list-group-item text-danger small">Lỗi tải gợi ý.</li>';
        emptyEl.style.display='none';
        countEl.textContent = '0';
        } finally {
        toggleLoading(false);
        }
      }

      function applyFilter(){
        const q = searchInput.value.trim().toLowerCase();
        const filtered = !q ? rawSuggestions :
        rawSuggestions.filter(s => {
          const name = (s.full_name || s.fullName || s.username || '').toLowerCase();
          const email = (s.email||'').toLowerCase();
          return name.includes(q) || email.includes(q);
        });
        render(filtered);
      }

      function render(arr){
        listEl.innerHTML = '';
        if(!arr.length){
        emptyEl.style.display = '';
        countEl.textContent = '0';
        return;
        }
        emptyEl.style.display = 'none';
        countEl.textContent = arr.length;
        const frag = document.createDocumentFragment();
        arr.forEach(s => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center justify-content-between';
        li.dataset.identifier = s.username || s.email || s.id;
        const fullName = (s.full_name || s.fullName || s.username || 'Không rõ').trim();
        const email = s.email || '';
        const avatarUrl = s.avatar_url || s.avatarUrl;
        const initials = fullName.charAt(0).toUpperCase();
        const avatarHtml = avatarUrl
          ? `<img src="${escapeHtml(avatarUrl)}" class="avatar" alt="${escapeHtml(fullName)}">`
          : `<div class="avatar">${escapeHtml(initials)}</div>`;
        li.innerHTML = `
          <div class="d-flex align-items-center gap-3">
          ${avatarHtml}
          <div>
            <div class="fw-semibold">${escapeHtml(fullName)}</div>
            <div class="small text-muted truncate">${escapeHtml(email)}</div>
          </div>
          </div>
          <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary add-suggest-btn">Kết bạn</button>
          </div>
        `;
        frag.appendChild(li);
        });
        listEl.appendChild(frag);
      }

      async function sendRequest(li){
        const btn = li.querySelector('.add-suggest-btn');
        if(!btn) return;
        btn.disabled = true;
        const original = btn.textContent;
        btn.textContent = '...';
        try {
        const identifier = li.dataset.identifier;
        const res = await fetch('/api/friends/requests', {
          method:'POST',
          credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ identifier })
        });
        if(!res.ok){
          let msg='Gửi thất bại';
          try{ const j=await res.json(); if(j.message) msg=j.message; }catch{}
          throw new Error(msg);
        }
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        btn.textContent = 'Đã gửi';
        showToast('Đã gửi lời mời kết bạn','success');
        document.dispatchEvent(new Event('friends:refresh'));
        } catch(e){
        btn.disabled = false;
        btn.textContent = original;
        showToast(e.message || 'Lỗi gửi yêu cầu','danger');
        }
      }

      function toggleLoading(state){
        refreshBtn.disabled = state;
        refreshBtn.textContent = state ? 'Đang tải...' : 'Làm mới';
      }

      listEl.addEventListener('click', e=>{
        const btn = e.target.closest('.add-suggest-btn');
        if(!btn) return;
        const li = btn.closest('li');
        sendRequest(li);
      });

      refreshBtn.addEventListener('click', fetchSuggestions);
      searchInput.addEventListener('input', applyFilter);
      document.addEventListener('friends:refresh', fetchSuggestions);

      fetchSuggestions();
      })();
    </script>
    <!-- Suggested Friends:END -->

  </main>
  <!-- Main:END -->

  <!-- Remove Friend Modal:BEGIN -->
  <div class="modal fade" id="removeFriendModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Remove Friend</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to remove
          <strong id="removeFriendName"></strong> from your friends list?
          <input type="hidden" id="removeFriendId">
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" id="confirmRemoveBtn">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="removeFriendSpinner"></span>
            Remove
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Remove Friend Modal:END -->

  <!-- Toasts -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="toastContainer"></div>
  </div>

  <!-- Bootstrap script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>

</body>
</html>