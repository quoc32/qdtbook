<!-- fragments.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8">
    <title>QDTBook - Home</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <style>
      body { background:#f0f2f5; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
      .navbar-brand { font-weight:700; color:#1365ff !important; }
      .search-box { background:#f0f2f5; border:none; border-radius:20px; padding:6px 14px; width:230px; }
      .search-box:focus { outline:0; box-shadow:none; background:#e4e6eb; }
      .sidebar-sticky { position:sticky; top:70px; }
      .story-card { height:160px; border-radius:12px; background:#fff; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; font-weight:600; color:#555; }
      .composer, .post-card { background:#fff; border-radius:8px; border:1px solid #ddd; }
      .composer textarea { resize:none; border:none; box-shadow:none; }
      .composer textarea:focus { outline:0; }
      .btn-primary { background:#1b74e4; border-color:#1b74e4; }
      .btn-primary:hover { background:#155ec0; }
      .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; }
      .post-img { border-radius:8px; max-height:480px; object-fit:cover; width:100%; }
      .action-btn { background:transparent; border:none; padding:6px 8px; border-radius:6px; font-weight:500; color:#555; }
      .action-btn:hover { background:#f0f2f5; }
      .right-card { background:#fff; border:1px solid #ddd; border-radius:8px; }
      @media (max-width: 992px){
          .left-col, .right-col { display:none; }
          .search-box { width:140px; }
      }
    </style>
  </head>
  <body>

    <!-- Post Composer Fragment -->
    <div th:fragment="postComposer" class="composer neo-composer p-3 mb-3" data-bs-toggle="modal" data-bs-target="#createPostModal">
        <div class="d-flex align-items-start gap-2 mb-3">
            <div class="avatar-wrap">
                <img id="postComposerUserAvatar" class="avatar" src="" alt="User">
                <script>
                    (function(){
                        try{
                            const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                            const url = auth?.avatar_url || auth?.avatar;
                            if(url){
                                const img = document.getElementById('postComposerUserAvatar');
                                if(img) img.src = url;
                            }
                        }catch(_){}
                    })();
                </script>
                <span class="glow-ring"></span>
            </div>
            <textarea class="form-control composer-input"
                        rows="2"
                        placeholder="Chia sẻ điều bạn đang nghĩ..."
                        readonly></textarea>
        </div>
        <div class="cp-actions d-flex flex-wrap gap-2">
            <button type="button" class="cp-btn" data-bs-toggle="modal" data-bs-target="#createPostModal">
                <span class="ico img"><i class="bi bi-image"></i></span>
                Ảnh
            </button>
            <button type="button" class="cp-btn" data-bs-toggle="modal" data-bs-target="#createPostModal">
                <span class="ico vid"><i class="bi bi-camera-reels"></i></span>
                Video
            </button>
            <button type="button" class="cp-btn" data-bs-toggle="modal" data-bs-target="#createPostModal">
                <span class="ico more"><i class="bi bi-stars"></i></span>
                Khác
            </button>
        </div>
        
    <style>
        .neo-composer{
            position:relative;
            background:
                linear-gradient(155deg,#ffffff,#f2f6fb 55%,#e6eef8);
            border:1px solid rgba(120,150,190,.35);
            border-radius:20px;
            box-shadow:
                0 4px 10px -4px rgba(30,70,140,.18),
                0 2px 4px -2px rgba(30,70,140,.15),
                inset 0 1px 0 rgba(255,255,255,.9);
            cursor:pointer;
            transition:.45s cubic-bezier(.6,.2,.2,1);
            overflow:hidden;
        }
        .neo-composer:before,
        .neo-composer:after{
            content:"";
            position:absolute;
            inset:0;
            border-radius:inherit;
            pointer-events:none;
            opacity:.55;
            mix-blend-mode:overlay;
            background:
                radial-gradient(circle at 18% 15%,rgba(255,255,255,.9),transparent 60%),
                radial-gradient(circle at 85% 85%,rgba(255,255,255,.55),transparent 70%);
            animation:ccGlow 9s linear infinite;
        }
        .neo-composer:after{
            background:
                radial-gradient(circle at 82% 25%,rgba(27,116,228,.20),transparent 55%),
                radial-gradient(circle at 25% 80%,rgba(90,162,255,.15),transparent 60%);
            opacity:.35;
            filter:blur(2px);
            animation:ccGlow2 11s linear infinite;
        }
        @keyframes ccGlow{to{transform:rotate(360deg)}}
        @keyframes ccGlow2{to{transform:rotate(-360deg)}}
        .neo-composer:hover{
            box-shadow:
                0 10px 32px -10px rgba(30,70,140,.35),
                0 4px 14px -4px rgba(30,70,140,.25),
                inset 0 1px 0 rgba(255,255,255,.9);
            transform:translateY(-3px);
        }
        .neo-composer:active{transform:translateY(-1px) scale(.98);}

        .avatar-wrap{
            position:relative;
            width:46px;height:46px;
            flex-shrink:0;
        }
        .avatar-wrap .avatar{
            width:100%;height:100%;
            border-radius:16px;
            object-fit:cover;
            display:block;
            box-shadow:0 4px 10px -4px rgba(0,0,0,.35);
        }
        .avatar-wrap .glow-ring{
            position:absolute;inset:-2px;
            border-radius:18px;
            background:conic-gradient(from 0deg,#1b74e4 0 260deg,rgba(0,0,0,0) 260deg 360deg);
            mask:radial-gradient(circle at 50% 50%,transparent 63%,#000 65%);
            animation:spinRingC 10s linear infinite;
            opacity:.5;
        }
        @keyframes spinRingC{to{transform:rotate(360deg)}}

        .composer-input{
            border:0;
            border-radius:16px;
            resize:none;
            background:#f0f4f9;
            font-size:.95rem;
            padding:10px 14px;
            line-height:1.35;
            box-shadow:inset 0 1px 2px rgba(0,0,0,.05);
            transition:.25s;
            cursor:pointer;
        }
        .composer-input:hover{background:#e8eef5;}
        .composer-input:focus{outline:0;}

        .cp-actions{
            position:relative;
            z-index:2;
        }
        .cp-btn{
            --grad:linear-gradient(135deg,#f2f7ff,#e5eefb);
            position:relative;
            flex:1 1 120px;
            border:1px solid rgba(120,150,190,.35);
            background:var(--grad);
            color:#2a3542;
            font-weight:600;
            font-size:.8rem;
            letter-spacing:.3px;
            padding:10px 12px;
            border-radius:14px;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            text-transform:uppercase;
            box-shadow:
                0 3px 8px -4px rgba(30,70,140,.35),
                inset 0 1px 0 rgba(255,255,255,.9);
            overflow:hidden;
            transition:.45s cubic-bezier(.6,.2,.2,1);
        }
        .cp-btn .ico{
            width:28px;height:28px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            border-radius:10px;
            font-size:1.05rem;
            background:#fff;
            color:#1b74e4;
            box-shadow:0 2px 6px -2px rgba(30,70,140,.35), inset 0 1px 0 rgba(255,255,255,.9);
            position:relative;
            transition:.4s;
        }
        .cp-btn .ico.img{color:#1b74e4;}
        .cp-btn .ico.vid{color:#e05d1d;}
        .cp-btn .ico.more{color:#6a35bb;}
        .cp-btn:before{
            content:"";
            position:absolute;inset:0;
            background:radial-gradient(circle at 30% 20%,rgba(255,255,255,.9),transparent 70%);
            opacity:0;transition:.5s;
        }
        .cp-btn:hover{
            transform:translateY(-4px);
            box-shadow:
                0 10px 26px -8px rgba(30,70,140,.4),
                inset 0 1px 0 rgba(255,255,255,.9);
            border-color:rgba(27,116,228,.5);
        }
        .cp-btn:hover .ico{
            transform:rotate(10deg) scale(1.08);
            background:linear-gradient(135deg,#ffffff,#f0f6ff);
        }
        .cp-btn:hover:before{opacity:.6;}
        .cp-btn:active{transform:translateY(-1px) scale(.97);}

        @media (max-width: 576px){
            .neo-composer{padding:1rem 1rem .85rem;}
            .cp-btn{flex:1 1 100%;font-size:.75rem;}
            .cp-btn .ico{width:26px;height:26px;font-size:.95rem;}
        }
        @media (prefers-color-scheme:dark){
            .neo-composer{
                background:linear-gradient(155deg,#222a34,#1a212b 60%,#151b24);
                border-color:rgba(140,170,210,.25);
            }
            .composer-input{background:#2a313b;color:#e2e9f2;}
            .composer-input:hover{background:#323a45;}
            .cp-btn{
                --grad:linear-gradient(135deg,#2b3440,#242c36);
                color:#d3dbe6;
                border-color:rgba(140,170,210,.25);
            }
            .cp-btn .ico{background:#2f3843;color:#7eb6ff;}
            .cp-btn:hover{border-color:rgba(126,182,255,.55);}
        }
    </style>

    </div>

    
    <!-- Modal tạo bài viết:BEGIN -->
    <div th:fragment="postComposerModal">
    <div class="modal fade" id="createPostModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="createPostForm">
                    <div class="modal-header">
                        <h5 class="modal-title fw-semibold">Tạo bài viết</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex mb-3">
                            <img id="postComposerModalUserAvatar" class="avatar me-2" src="/img/image1.png" alt="">
                            <script>
                                (function(){
                                    try{
                                        const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                                        const url = auth?.avatar_url || auth?.avatar;
                                        if(url){
                                            const img = document.getElementById('postComposerModalUserAvatar');
                                            if(img) img.src = url;
                                        }
                                    }catch(_){}
                                })();
                            </script>
                            <div>
                                <div class="fw-semibold">Người dùng</div>
                                <script>
                                    (function(){
                                        try{
                                            const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                                            const name = auth?.full_name || auth?.username || 'Người dùng';
                                            const el = document.querySelector('#createPostModal .modal-body .fw-semibold');
                                            if(el) el.textContent = name;
                                        }catch(_){}
                                    })();
                                </script>
                                <select class="form-select form-select-sm mt-1" style="width:auto;">
                                    <option value="public">Công khai</option>
                                    <option value="friends">Bạn bè</option>
                                    <option value="private">Chỉ mình tôi</option>
                                </select>
                            </div>
                        </div>

            <textarea class="form-control border-0 fs-5"
                id="postContent"
                rows="5"
                placeholder="Bạn đang nghĩ gì?"
                style="resize:none;"></textarea>

                        <div id="previewArea" class="mt-3 d-none">
                            <div class="d-flex flex-wrap gap-2" id="previewList"></div>
                        </div>

                        <input type="file" id="mediaInput" class="d-none" multiple accept="image/*,video/*">

                        <div id="mediaControls" class="border rounded mt-3 p-2 d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-pick="image">Ảnh</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-pick="video">Video</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-pick="pdf">PDF</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" disabled>Gắn thẻ</button>
                        </div>

                        <div class="mt-3 d-none" id="uploadProgressWrap">
                            <div class="small mb-1" id="uploadStatus">Đang tải lên...</div>
                            <div class="progress" style="height:6px;">
                                <div class="progress-bar" id="uploadBar" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <span class="text-muted small me-auto" id="fileCounter"></span>
                        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Hủy</button>
                        <button class="btn btn-primary" type="submit" disabled id="submitPostBtn">Đăng</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        // Clear upload status when modal closes
        document.getElementById('createPostModal')?.addEventListener('hidden.bs.modal', () => {
            const status = document.getElementById('uploadStatus');
            const wrap   = document.getElementById('uploadProgressWrap');
            const bar    = document.getElementById('uploadBar');
            if (status) status.textContent = '';
            if (bar) bar.style.width = '0%';
            if (wrap) wrap.classList.add('d-none');
        });
        (function(){
        // Elements
        const modalEl      = document.getElementById('createPostModal');
        const form         = document.getElementById('createPostForm');
        const contentEl    = document.getElementById('postContent');
        const submitBtn    = document.getElementById('submitPostBtn');
        const mediaInput   = document.getElementById('mediaInput');
        const pickButtons  = document.querySelectorAll('[data-pick]');
        const previewArea  = document.getElementById('previewArea');
        const previewList  = document.getElementById('previewList');
        const fileCounter  = document.getElementById('fileCounter');
        const uploadWrap   = document.getElementById('uploadProgressWrap');
        const uploadBar    = document.getElementById('uploadBar');
        const uploadStatus = document.getElementById('uploadStatus');

        // State
        const MAX_FILES = 10;
        let files = [];              // File[]
        let objectURLs = [];         // revoke on cleanup
        let uploading = false;
        // Edit mode state (hoist early so helpers can reference)
        let editMode = false;
        let editingPostId = null;
        let editingPostType = 'normal';
        let editingStatus = 'pending';

        // Helpers
        function revokeAll(){
            objectURLs.forEach(URL.revokeObjectURL);
            objectURLs = [];
        }

        function canSubmit(){
            // In edit mode, always allow saving (even when only visibility/status changes)
            if (editMode) return true;
            return (contentEl.value.trim().length > 0) || files.length > 0;
        }

        function updateSubmitState(){
            submitBtn.disabled = !canSubmit() || uploading;
        }

        function updatePreview(){
            previewList.innerHTML = '';
            revokeAll();
            if(files.length === 0){
            previewArea.classList.add('d-none');
            fileCounter.textContent = '';
            return;
            }
            previewArea.classList.remove('d-none');
            fileCounter.textContent = files.length + ' tệp đã chọn';
            files.forEach((f, idx)=>{
            const url = URL.createObjectURL(f);
            objectURLs.push(url);
            const box = document.createElement('div');
            box.className = 'media-thumb';
            let inner = '';
            if(f.type.startsWith('image/')){
                inner = `<img src="${url}" alt="">`;
            }else if(f.type.startsWith('video/')){
                inner = `<video src="${url}" muted></video>`;
            }else if(f.type === 'application/pdf'){
                inner = `<div class="d-flex flex-column align-items-center text-center p-2 w-100">
                      <span class="badge text-bg-danger mb-1">PDF</span>
                      <span class="small text-truncate w-100" title="${f.name}">${f.name}</span>
                     </div>`;
            }else{
                inner = `<span class="small text-truncate px-1" title="${f.name}">${f.name}</span>`;
            }
            box.innerHTML = inner + `<button type="button" class="media-remove" data-rm="${idx}" aria-label="Xóa">&times;</button>`;
            previewList.appendChild(box);
            });
        }

        // Events: remove media
        previewList.addEventListener('click', e=>{
            const btn = e.target.closest('[data-rm]');
            if(!btn) return;
            const i = +btn.dataset.rm;
            files.splice(i,1);
            updatePreview();
            updateSubmitState();
        });

        // Pick buttons
        pickButtons.forEach(btn=>{
            btn.addEventListener('click', ()=>{
            const type = btn.dataset.pick;
            if(type === 'image')      mediaInput.accept = 'image/*';
            else if(type === 'video') mediaInput.accept = 'video/*';
            else if(type === 'pdf')   mediaInput.accept = 'application/pdf';
            else                      mediaInput.accept = 'image/*,video/*,application/pdf';
            mediaInput.click();
            });
        });

        // File selection
        mediaInput.addEventListener('change', ()=>{
            const selected = Array.from(mediaInput.files);
            for(const f of selected){
            if(files.length >= MAX_FILES) break;
            if(/^(image|video)\//.test(f.type) || f.type === 'application/pdf'){
                files.push(f);
            }
            }
            mediaInput.value = '';
            updatePreview();
            updateSubmitState();
        });

        // Text input
        contentEl.addEventListener('input', updateSubmitState);

        // Modal focus
        modalEl.addEventListener('shown.bs.modal', ()=> contentEl.focus());
        modalEl.addEventListener('hidden.bs.modal', ()=>{
            // Reset when closed (only if not uploading)
            if(uploading) return;
            form.reset();
            files = [];
            updatePreview();
            updateSubmitState();
            // Re-enable media UI in case we disabled it for share-edit
            try{ mediaInput.disabled = false; pickButtons.forEach(b=>b.disabled = false); const mc = document.getElementById('mediaControls'); if(mc) mc.classList.remove('d-none'); }catch(_){ }
        });

        // Upload (media first) Quốc 1
        async function uploadFiles() {
            // No files -> nothing to upload
            if(files.length === 0) return [];

            // Prepare FormData
            const fd = new FormData();
            files.forEach(f => fd.append('files', f, f.name));

            // UI setup
            uploadWrap.classList.remove('d-none');
            uploadBar.style.width = '0%';
            uploadStatus.textContent = 'Đang tải lên...';

            // Simulated progress (since fetch upload progress not exposed)
            let fakeProgress = 0;
            const tick = () => {
            if(fakeProgress < 95){
                fakeProgress = Math.min(95, fakeProgress + (8 + Math.random()*12));
                uploadBar.style.width = fakeProgress + '%';
            }
            };
            const intervalId = setInterval(tick, 300);

            try{
            const res = await fetch('http://localhost:8080/api/media/upload', {
                method: 'POST',
                body: fd,
                credentials: 'include'
            });

            clearInterval(intervalId);

            if(!res.ok){
                uploadStatus.textContent = 'Lỗi tải lên';
                throw new Error('Upload failed: ' + res.status);
            }

            uploadBar.style.width = '100%';
            uploadStatus.textContent = 'Tải lên xong';

            // Expecting: { "urls": [ ... ] }
            let data;
            try{
                data = await res.json();
            }catch(err){
                throw new Error('Invalid JSON response');
            }

            const urls = Array.isArray(data?.urls) ? data.urls : [];
            return urls; // Return plain array of URLs
            }catch(err){
            clearInterval(intervalId);
            uploadStatus.textContent = 'Lỗi mạng';
            throw err;
            }
        }
        // Create post
        async function createPost(uploadedUrls){
            // Map returned URLs to media objects paired with original file types
            const mediaArray = (Array.isArray(uploadedUrls) ? uploadedUrls : [])
            .filter(Boolean)
            .map((url, idx) => {
                console.log('Mapping media URL:', url);
                const f = files[idx];
                let media_type = 'image';
                if (f?.type?.startsWith('video/')) media_type = 'video';
                else if (f?.type === 'application/pdf') media_type = 'pdf';
                else if (f?.type?.startsWith('image/')) media_type = 'image';
                return {
                media_type,
                media_url: "http://localhost:8080" + url
                };
            });

            const payload = {
            author_id: (Number(JSON.parse(localStorage.getItem('auth')).user_id) || null), // from localStorage
            content: contentEl.value.trim(),
            visibility: (function(){ // map select -> public|friends|private
                try{
                const sel = document.querySelector('#createPostModal select.form-select');
                const raw = (sel ? (sel.value || sel.options[sel.selectedIndex]?.text || '') : '')
                    .toLocaleLowerCase('vi').trim();
                if (raw === 'public' || raw === 'friends' || raw === 'private') return raw;
                if (raw.includes('công khai')) return 'public';
                if (raw.includes('bạn bè')) return 'friends';
                if (raw.includes('chỉ mình tôi')) return 'private';
                return 'public';
                }catch(_){ return 'public'; }
            })(), // Quốc 2
            post_type: 'normal',
            status: 'pending',
            media: mediaArray
            };

            try{
            const res = await fetch('http://localhost:8080/api/posts', {
                method:'POST',
                headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify(payload),
                credentials:'include'
            });
            if(!res.ok) throw new Error('Post create failed: '+res.status);
            return await res.json().catch(()=>({}));
            }catch(err){
            console.error(err);
            throw err;
            }
        }

        // Flags for share-edit mode
        window.editingShare = false;
        window.editingShareId = null;
        window.editingSharePostId = null;

        // Expose function to open modal in edit mode with existing post data
        window.openEditPost = function(post){
            try{
            editMode = true;
            editingPostId = post.id || post.ID || post.postId || null;
            // Preserve type & status of the post being edited
            editingPostType = (post.post_type || post.postType || post.type || 'normal');
            editingStatus   = (post.status || 'pending');
            // Prefill content
            contentEl.value = post.content || '';
            // Prefill visibility select
            try{
                const sel = document.querySelector('#createPostModal select.form-select');
                if(sel){
                const vis = (post.visibility || '').toLowerCase();
                if(vis === 'public' || vis === 'friends' || vis === 'private') sel.value = vis;
                }
            }catch(_){ }
            // Prefill media previews if provided (post.medias or post.medias)
            files = [];
            revokeAll();
            previewList.innerHTML = '';
            if(Array.isArray(post.media) && post.media.length>0){
                post.media.forEach((m, idx)=>{
                const url = m.media_url || m.mediaUrl || m.url;
                if(!url) return;
                const isPdf = (m.media_type === 'pdf' || /\.pdf(\?|#|$)/i.test(url));
                const box = document.createElement('div');
                box.className = 'media-thumb';
                box.innerHTML = isPdf
                    ? `<div class="d-flex flex-column align-items-center text-center p-2 w-100">
                     <span class="badge text-bg-danger mb-1">PDF</span>
                     <span class="small text-truncate w-100" title="${url}">${(url||'').split('/').pop()}</span>
                       </div>`
                    : `<img src="${url}" alt="">`;
                box.innerHTML += `<button type="button" class="media-remove" data-rm-existing="${idx}" aria-label="Xóa">&times;</button>`;
                previewList.appendChild(box);
                });
                previewArea.classList.remove('d-none');
            }
            // Set submit button text
            submitBtn.textContent = 'Lưu thay đổi';
            const inst = new bootstrap.Modal(modalEl);
            inst.show();
            // Ensure button state reflects edit mode
            updateSubmitState();
            }catch(err){
            console.error(err);
            alert('Không thể mở chế độ sửa bài.');
            }
        };

        // Expose function to open composer modal in share-edit mode
        window.openEditShare = function(opts){
            try{
            // opts: { postId, shareId, sharedText, visibility }
            window.editingShare = true;
            window.editingShareId = opts.shareId || null;
            window.editingSharePostId = opts.postId || null;
            editMode = true;
            editingPostId = opts.postId || null;
            editingPostType = 'normal';
            editingStatus = 'pending';
            contentEl.value = opts.sharedText || '';
            try{
                const setSel = (vis)=>{
                const sel = document.querySelector('#createPostModal select.form-select');
                if(sel){ try{ sel.value = vis || 'public'; }catch(_){ /* ignore */ } }
                };
                setSel(opts.visibility);
                requestAnimationFrame(()=> setSel(opts.visibility));
            }catch(_){ }
            files = [];
            revokeAll();
            previewList.innerHTML = '';
            // Disable media UI for share-edit mode
            try{ previewArea.classList.add('d-none'); fileCounter.textContent = ''; mediaInput.disabled = true; pickButtons.forEach(b=>b.disabled = true); const mc = document.getElementById('mediaControls'); if(mc) mc.classList.add('d-none'); }catch(_){ }
            submitBtn.textContent = 'Lưu thay đổi';
            const inst = new bootstrap.Modal(modalEl);
            inst.show();
            updateSubmitState();
            }catch(e){ console.error('openEditShare (composer) error:', e); throw e; }
        };

        form.addEventListener('submit', async e=>{
            e.preventDefault();
            if(uploading || !canSubmit()) return;
            uploading = true;
            updateSubmitState();

            try{
            // If editing a share, we do not upload media — share-edit only updates text/visibility
            let uploadedUrls = [];
            if(!window.editingShare){
                uploadedUrls = await uploadFiles(); // array of URLs
            }
                if(window.editingShare){
                
                // Edit share: send shared_text and visibility to share API
                try{
                    const payload = {
                    shared_text: contentEl.value.trim(),
                    visibility: (function(){ try{ const sel = document.querySelector('#createPostModal select.form-select'); const raw = (sel ? (sel.value || sel.options[sel.selectedIndex]?.text || '') : '').toLocaleLowerCase('vi').trim(); if (raw === 'public' || raw === 'friends' || raw === 'private') return raw; if (raw.includes('công khai')) return 'public'; if (raw.includes('bạn bè')) return 'friends'; if (raw.includes('chỉ mình tôi')) return 'private'; return 'public'; }catch(_){ return 'public'; } })()
                    };
                    const shareId = window.editingShareId;
                    const postId = window.editingSharePostId || editingPostId;
                    const res = await fetch('/api/posts/' + encodeURIComponent(postId) + '/shares/' + encodeURIComponent(shareId), {
                    method: 'PUT',
                    headers: { 'Content-Type':'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                    });
                    if(!res.ok) throw new Error('Update share failed: '+res.status);
                    // Update DOM for the share: visibility label, dataset, time, and shared text
                    try{
                    const payloadVisibility = payload && payload.visibility ? payload.visibility : null;
                    const payloadText = payload && typeof payload.shared_text !== 'undefined' ? payload.shared_text : null;
                    const shareIdLocal = shareId;
                    const rootArticle = document.querySelector('article[data-share-id="'+String(shareIdLocal)+'"]') || document.querySelector('article.post-card[data-share-id="'+String(shareIdLocal)+'"]');
                    if(rootArticle){
                        if(payloadVisibility) {
                        rootArticle.dataset.visibility = payloadVisibility;
                        const visEl = rootArticle.querySelector('.pc-visibility');
                        if(visEl){
                            const map = { public: 'Công khai', friends: 'Bạn bè', private: 'Cá nhân' };
                            visEl.textContent = map[payloadVisibility] || payloadVisibility;
                        }
                        }
                        if(payloadText !== null){
                        const contentElLocal = rootArticle.querySelector('.post-content'); if(contentElLocal) contentElLocal.textContent = payloadText;
                        }
                        const timeElLocal = rootArticle.querySelector('.post-time');
                        try{
                        if(timeElLocal){
                            if(typeof formatRelativeTime === 'function'){
                            const nowIso = new Date().toISOString();
                            timeElLocal.textContent = formatRelativeTime(nowIso) + ' • Đã chỉnh sửa';
                            timeElLocal.setAttribute('datetime', nowIso);
                            } else {
                            timeElLocal.textContent = 'Vừa xong • Đã chỉnh sửa';
                            }
                        }
                        }catch(_){ }
                    }
                    }catch(e){ console.error('Failed update share DOM after PUT', e); }
                    // clear share flags
                    window.editingShare = false; window.editingShareId = null; window.editingSharePostId = null;
                    try{ bootstrap.Modal.getOrCreateInstance(modalEl).hide(); }catch(_){ }
                    try{ showToast && showToast('Cập nhật chia sẻ thành công', 'success'); }catch(_){ }
                }catch(err){ console.error(err); throw err; }
                } else if(editMode && editingPostId){
                // Update existing post via PUT
                const mediaArray = (Array.isArray(uploadedUrls) ? uploadedUrls : [])
                .filter(Boolean)
                .map((url, idx) => {
                    const f = files[idx];
                    let media_type = 'image';
                    if (f?.type?.startsWith('video/')) media_type = 'video';
                    else if (f?.type === 'application/pdf') media_type = 'pdf';
                    else if (f?.type?.startsWith('image/')) media_type = 'image';
                    return {
                    media_type,
                    media_url: url
                    };
                });

                const payload = {
                content: contentEl.value.trim(),
                visibility: (function(){ try{ const sel = document.querySelector('#createPostModal select.form-select'); const raw = (sel ? (sel.value || sel.options[sel.selectedIndex]?.text || '') : '').toLocaleLowerCase('vi').trim(); if (raw === 'public' || raw === 'friends' || raw === 'private') return raw; if (raw.includes('công khai')) return 'public'; if (raw.includes('bạn bè')) return 'friends'; if (raw.includes('chỉ mình tôi')) return 'private'; return 'public'; }catch(_){ return 'public'; } })(),
                post_type: editingPostType || 'normal',
                status: editingStatus || 'pending',
                media: mediaArray
                };

                // If no new uploads selected, omit media to preserve existing media on server
                if (mediaArray.length === 0) {
                delete payload.media;
                }

                try{
                const res = await fetch('http://localhost:8080/api/posts/' + encodeURIComponent(editingPostId), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });
                if(!res.ok) throw new Error('Update failed: '+res.status);
                }catch(err){
                console.error(err);
                throw err;
                }
            }else{
                await createPost(uploadedUrls);
            }
            // Reset
            files = [];
            revokeAll();
            updatePreview();
            form.reset();
            contentEl.value = '';
            setTimeout(()=>{
                uploadWrap.classList.add('d-none');
                uploadBar.style.width='0%';
            }, 350);
            const inst = bootstrap.Modal.getInstance(modalEl);
            if(inst) inst.hide();
            // clear edit mode
            editMode = false;
            editingPostId = null;
            editingPostType = 'normal';
            editingStatus = 'pending';
            submitBtn.textContent = 'Đăng';
            }catch(err){
            // keep previews for retry
            }finally{
            uploading = false;
            updateSubmitState();
            setTimeout(() => {
                const modal = document.getElementById('createPostModal');
                if (modal && !modal.classList.contains('show')) {
                window.location.reload();
                }
            }, 450);
            }
        });

        // Initial
        updateSubmitState();
        })();
    </script>
    <style>
        .media-thumb{
            position:relative;
            width:110px;
            height:110px;
            border:1px solid #ddd;
            border-radius:8px;
            overflow:hidden;
            background:#f8f9fa;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:12px;
        }
        .media-thumb img,
        .media-thumb video{
            width:100%;
            height:100%;
            object-fit:cover;
        }
        .media-remove{
            position:absolute;
            top:2px;
            right:2px;
            width:22px;
            height:22px;
            border:0;
            border-radius:50%;
            background:rgba(0,0,0,.55);
            color:#fff;
            font-size:14px;
            line-height:1;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
        }
        .media-remove:hover{background:rgba(0,0,0,.75);}
    </style>
    </div>
    <!-- Modal tạo bài viết:END -->


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
