<!-- fragments.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8">
    <title>QDTBook - Home</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <style>
      body { background:#f0f2f5; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
      .navbar-brand { font-weight:700; color:#1365ff !important; }
      .search-box { background:#f0f2f5; border:none; border-radius:20px; padding:6px 14px; width:230px; }
      .search-box:focus { outline:0; box-shadow:none; background:#e4e6eb; }
      .sidebar-sticky { position:sticky; top:70px; }
      .story-card { height:160px; border-radius:12px; background:#fff; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; font-weight:600; color:#555; }
      .composer, .post-card { background:#fff; border-radius:8px; border:1px solid #ddd; }
      .composer textarea { resize:none; border:none; box-shadow:none; }
      .composer textarea:focus { outline:0; }
      .btn-primary { background:#1b74e4; border-color:#1b74e4; }
      .btn-primary:hover { background:#155ec0; }
      .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; }
      .post-img { border-radius:8px; max-height:480px; object-fit:cover; width:100%; }
      .action-btn { background:transparent; border:none; padding:6px 8px; border-radius:6px; font-weight:500; color:#555; }
      .action-btn:hover { background:#f0f2f5; }
      .right-card { background:#fff; border:1px solid #ddd; border-radius:8px; }
      @media (max-width: 992px){
          .left-col, .right-col { display:none; }
          .search-box { width:140px; }
      }
    </style>
  </head>
  <body>

    <div th:fragment="postSegment(fetchUrl, isSelfProfile)">
        <!-- Khai b√°o bi·∫øn Thymeleaf cho JavaScript -->
        <p th:text="${fetchUrl}" id="fetchUrl_id" style="display: none;"></p>
        <p th:text="${isSelfProfile}" id="isSelfProfile_id" hidden></p>
        <script th:inline="javascript">
            /*<![CDATA[*/
            const fetchUrl = document.getElementById('fetchUrl_id').textContent;
            /*]]>*/
            var isSelfProfile = (function(){
                const el = document.getElementById('isSelfProfile_id');
                if(!el) return 'false';
                const val = el.textContent.trim().toLowerCase();
                return val === 'true' || val === '1';
            })();
        </script>

      <!-- Post Segment:BEGIN -->
      <div id="postList" class="post-feed"></div>

      <template id="postCardTemplate">
          <article class="post-card" data-post-id="">
              <div class="pc-head">
                  <div class="pc-author">
                      <div class="pc-av-wrap">
                            <img class="pc-avatar" src="/img/image1.png" alt="">
                      </div>
                      <div class="pc-author-text">
                          <div class="pc-name">·∫®n danh</div>
                          <div class="pc-meta">
                              <time class="post-time"></time>
                              <span class="pc-dot"></span>
                              <span class="pc-visibility">B·∫°n b√®</span>
                          </div>
                      </div>
                  </div>
    <button class="pc-menu" type="button" aria-label="Menu"
      onclick="(function(btn){
        var article = btn.closest('article');
        var m = article ? article.querySelector('.pc-more-modal') : null;
        if(!m){ return; }
        var modal = bootstrap.Modal.getOrCreateInstance(m) || bootstrap.Modal.getOrCreateInstance(m);
        m.addEventListener('shown.bs.modal', function onShown(){
          try{
            var isShare = !!(article && article.dataset && article.dataset.shareId);
            var items = m.querySelectorAll('.list-group .list-group-item-action');
            if(items && items.length >= 2){
              var deleteBtn = items[0];
              var editBtn = items[1];
              // Save original labels once
              if(!m.dataset.origDelete) m.dataset.origDelete = (deleteBtn.textContent || '').trim();
              if(!m.dataset.origEdit) m.dataset.origEdit = (editBtn.textContent || '').trim();
              if(isShare){
                // If this fragment is rendered on the user's own profile (isSelfProfile === true),
                // keep share-specific labels for edit/delete. Otherwise (feed/homepage),
                // show report/close to match homepage semantics.
                if(typeof isSelfProfile !== 'undefined' && isSelfProfile){
                  deleteBtn.textContent = 'X√≥a b√†i chia s·∫ª';
                  editBtn.textContent = 'S·ª≠a b√†i chia s·∫ª';
                  if(items.length >= 3) items[2].style.display = '';
                  if(items.length >= 4) items[3].style.display = '';
                } else {
                  deleteBtn.textContent = 'B√°o c√°o';
                  editBtn.textContent = 'ƒê√≥ng';
                  if(items.length >= 3) items[2].style.display = 'none';
                  if(items.length >= 4) items[3].style.display = 'none';
                }
              } else {
                deleteBtn.textContent = m.dataset.origDelete || deleteBtn.textContent;
                editBtn.textContent = m.dataset.origEdit || editBtn.textContent;
                if(items.length >= 3) items[2].style.display = '';
                if(items.length >= 4) items[3].style.display = '';
              }
            }
          }catch(e){ /* ignore */ }
          m.removeEventListener('shown.bs.modal', onShown);
        });
        modal.show();
      })(this)">
                  <i class="bi bi-three-dots"></i>
                </button>

                <!-- Modal t√πy ch·ªçn b√†i Post:BEGIN -->
                <div class="modal fade pc-more-modal" tabindex="-1" aria-hidden="true" role="dialog">
                  <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content">
                      <div class="modal-header">
                    <h5 class="modal-title">T√πy ch·ªçn b√†i vi·∫øt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                      </div>
                      <div class="modal-body">
                    <div class="list-group list-group-flush">

      <button type="button" class="list-group-item list-group-item-action"
        th:if="${canDeletePost}"
        onclick="(function(btn){
                (async function(){
                  try{
                  const isSelf = isSelfProfile;
                  if(!isSelf){ alert('Ch·ªâ c√≥ th·ªÉ x√≥a b√†i vi·∫øt tr√™n trang c√° nh√¢n c·ªßa b·∫°n.'); return; }
                  const article = btn.closest('article'); if(!article) return;
                  const postId = article.dataset.postId;
                  const shareId = article.dataset.shareId;
                  if(!postId){ alert('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c b√†i vi·∫øt ƒë·ªÉ x√≥a.'); return; }

                  if(shareId){
                    console.log('[delete-share] clicked', { postId, shareId });
                    // Close the options modal first, then open the confirm modal after it's fully hidden
                    try{
                      const currentModal = btn.closest('.pc-more-modal');
                      if(currentModal){
                        const inst = bootstrap.Modal.getOrCreateInstance(currentModal);
                        let opened = false;
                        const onHidden = function(){
                          currentModal.removeEventListener('hidden.bs.modal', onHidden);
                          if(window.openConfirmDeleteShare && typeof window.openConfirmDeleteShare === 'function'){
                            opened = true;
                            window.openConfirmDeleteShare(article, postId, shareId);
                          } else {
                            console.error('openConfirmDeleteShare not available; aborting delete-share action');
                          }
                        };
                        currentModal.addEventListener('hidden.bs.modal', onHidden);
                        inst.hide();
                        // Fallback: if hidden event doesn't fire within 400ms, try opening anyway
                        setTimeout(function(){
                          if(!opened){
                            currentModal.removeEventListener('hidden.bs.modal', onHidden);
                            if(window.openConfirmDeleteShare && typeof window.openConfirmDeleteShare === 'function'){
                              console.warn('[delete-share] hidden event timeout fallback');
                              window.openConfirmDeleteShare(article, postId, shareId);
                            }
                          }
                        }, 400);
                        return;
                      }
                    }catch(_){ }
                    // Fallback if no modal instance found
                    if(window.openConfirmDeleteShare && typeof window.openConfirmDeleteShare === 'function'){
                      window.openConfirmDeleteShare(article, postId, shareId);
                      return;
                    }
                    console.error('openConfirmDeleteShare not available; aborting delete-share action');
                    return;
                  } else {
                    console.log('[delete-post] clicked', { postId });
                    // Close the options modal first, then open the confirm modal after it's fully hidden
                    try{
                      const currentModal = btn.closest('.pc-more-modal');
                      if(currentModal){
                        const inst = bootstrap.Modal.getOrCreateInstance(currentModal);
                        let opened = false;
                        const onHidden = function(){
                          currentModal.removeEventListener('hidden.bs.modal', onHidden);
                          if(window.openConfirmDeletePost && typeof window.openConfirmDeletePost === 'function'){
                            opened = true;
                            window.openConfirmDeletePost(article, postId);
                          } else {
                            console.error('openConfirmDeletePost not available; aborting delete-post action');
                          }
                        };
                        currentModal.addEventListener('hidden.bs.modal', onHidden);
                        inst.hide();
                        // Fallback: if hidden event doesn't fire within 400ms, try opening anyway
                        setTimeout(function(){
                          if(!opened){
                            currentModal.removeEventListener('hidden.bs.modal', onHidden);
                            if(window.openConfirmDeletePost && typeof window.openConfirmDeletePost === 'function'){
                              console.warn('[delete-post] hidden event timeout fallback');
                              window.openConfirmDeletePost(article, postId);
                            }
                          }
                        }, 400);
                        return;
                      }
                    }catch(_){ }
                    // Fallback if no modal instance found
                    if(window.openConfirmDeletePost && typeof window.openConfirmDeletePost === 'function'){
                      window.openConfirmDeletePost(article, postId);
                      return;
                    }
                    console.error('openConfirmDeletePost not available; aborting delete-post action');
                    return;
                  }
                  }catch(err){ console.error(err); alert('ƒê√£ x·∫£y ra l·ªói khi x√≥a.'); }
                })();
              })(this);"
            >X√≥a b√†i vi·∫øt</button>
            <!-- Edit post button: render only on own profile -->
            <button type="button" class="list-group-item list-group-item-action" th:if="${isSelfProfile}"
              onclick="(function(btn){
                (async function(){
                  try{
                    const isSelf = isSelfProfile;
                    if(!isSelf){ alert('Ch·ªâ c√≥ th·ªÉ s·ª≠a b√†i vi·∫øt tr√™n trang c√° nh√¢n c·ªßa b·∫°n.'); return; }
                    // Close the 'T√πy ch·ªçn b√†i vi·∫øt' modal immediately
                    try{ const currentModal = btn.closest('.pc-more-modal'); if(currentModal){ bootstrap.Modal.getOrCreateInstance(currentModal).hide(); } }catch(e){}
                    const article = btn.closest('article'); if(!article) return;
                    const postId = article.dataset.postId; const shareId = article.dataset.shareId;
                    if(!postId){ alert('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c b√†i vi·∫øt ƒë·ªÉ s·ª≠a.'); return; }

                    if(shareId){
                      // Open share-edit UI. Prefer the composer-based editor (openEditShare) if available,
                      // otherwise fall back to the inline modal helper (openEditShareModal).
                      try{
                        const currentTextEl = article.querySelector('.post-content');
                        const currentText = currentTextEl ? currentTextEl.textContent.trim() : '';
                        const vis = article.dataset.visibility || 'public';
                        if(window.openEditShare && typeof window.openEditShare === 'function'){
                          // composer-based editor (recommended)
                          window.openEditShare({ postId: postId, shareId: shareId, sharedText: currentText, visibility: vis });
                        } else if(window.openEditShareModal && typeof window.openEditShareModal === 'function'){
                          // legacy modal-based helper
                          window.openEditShareModal({ postId: postId, shareId: shareId, sharedText: currentText, visibility: vis, articleEl: article });
                        } else {
                          console.error('No share edit entrypoint found', { openEditShare: !!window.openEditShare, openEditShareModal: !!window.openEditShareModal });
                          alert('Kh√¥ng th·ªÉ m·ªü giao di·ªán s·ª≠a share: ch·ª©c nƒÉng ch∆∞a s·∫µn s√†ng. Ki·ªÉm tra console ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.');
                        }
                      }catch(e){ console.error(e); alert('Kh√¥ng th·ªÉ m·ªü giao di·ªán s·ª≠a share.'); }
                    } else {
                      // edit post: existing behaviour (fetch post and open composer)
                      try{
                        const r = await fetch('/api/posts/' + encodeURIComponent(postId), { credentials: 'include' });
                        if(!r.ok) throw new Error('Failed to fetch post');
                        const post = await r.json();
                        if(window.openEditPost && typeof window.openEditPost === 'function'){ window.openEditPost(post); }
                        else { alert('Ch·ª©c nƒÉng s·ª≠a b√†i hi·ªán kh√¥ng kh·∫£ d·ª•ng.'); }
                      }catch(err){ console.error(err); alert('Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu b√†i vi·∫øt ƒë·ªÉ s·ª≠a.'); }
                    }
                  }catch(e){ console.error(e); }
                })();
              })(this);"
            >S·ª≠a b√†i vi·∫øt</button>
                        <!-- Script x·ª≠ l√Ω x√≥a b√†i vi·∫øt -->
                        <script>
                            
                        </script>

            <button type="button" class="list-group-item list-group-item-action" onclick="(function(btn){
                try{
                  const article = btn.closest('article'); if(!article) return;
                  const postId = article.dataset.postId; if(!postId) return;
                  // close the 'T√πy ch·ªçn b√†i vi·∫øt' modal immediately so the report modal can show
                  try{ const currentModal = btn.closest('.pc-more-modal'); if(currentModal){ bootstrap.Modal.getOrCreateInstance(currentModal).hide(); } }catch(_){ }
                  var modal = document.getElementById('qdt_report_modal');
                  if(modal){
                    modal.dataset.targetType = 'post';
                    modal.dataset.targetId = String(postId);
                    var ta = modal.querySelector('textarea.report-reason'); if(ta) ta.value = '';
                    bootstrap.Modal.getOrCreateInstance(modal).show();
                  } else {
                    var reason = prompt('L√Ω do b√°o c√°o (t√πy ch·ªçn):');
                    reason = (reason || '').trim();
                    if(!reason){ try{ showToast('Vui l√≤ng nh·∫≠p l√Ω do b√°o c√°o.', 'danger'); }catch(e){} return; }
                    fetch('/api/reports/posts/'+encodeURIComponent(postId), { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reason: reason }) })
                      .then(r=>{
                        if(r.ok || r.status === 201){ try{ showToast('C·∫£m ∆°n, b√°o c√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i.', 'success'); }catch(e){} }
                        else { r.json().then(j=> showToast('B√°o c√°o th·∫•t b·∫°i: ' + (j.message || r.statusText), 'danger')).catch(()=> showToast('B√°o c√°o th·∫•t b·∫°i', 'danger')); }
                      }).catch(e=>{ console.error(e); try{ showToast('L·ªói khi g·ª≠i b√°o c√°o', 'danger'); }catch(_){} });
                  }
                }catch(e){ console.error(e); }
              })(this);">B√°o c√°o</button>
                      <button type="button" class="list-group-item list-group-item-action" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Modal t√πy ch·ªçn b√†i Post:END -->
              </div>

              <div class="pc-body">
                  <div class="post-content"></div>
                  <div class="post-media pm-grid"></div>
          <!-- Shares list for this post -->
          <div class="post-shares mt-3"></div>
              </div>


              <div class="pc-actions" id="post-info-reactions-and-comments">
                  
                <!-- N√∫t hi·ªÉn th·ªã s·ªë l∆∞·ª£ng v√† lo·∫°i reactions -->
                <button type="button" class="btn-reaction-summary"
                        style="display:inline-flex;align-items:center;gap:4px;background:transparent;border:0;padding:0;color:#65676b;font-weight:500;font-size:.9rem;line-height:1;text-transform:none;box-shadow:none;"
                        onclick="(async function(btn){
                          try{
                            const article = btn.closest('article'); if(!article) return;
                            const postId = article.dataset.postId; if(!postId) return;

                            const modal = Array.from(article.querySelectorAll('.reactions-modal')).find(function(m){ return m.closest('article')===article; }) || null;
                            const listEl = modal.querySelector('.reactions-list');
                            const tabsWrap = modal.querySelector('.reaction-tabs');

                            function iconByType(t){
                              t=String(t||'').toLowerCase();
                              if(t==='love') return '<i class=&quot;bi bi-heart-fill text-danger&quot;></i>';
                              if(t==='haha') return 'üòÜ';
                              if(t==='sad')  return 'üò¢';
                              if(t==='angry')return 'üò°';
                              return '<i class=&quot;bi bi-hand-thumbs-up&quot;></i>';
                            }
                            function fmtTime(ts){
                              if(!ts) return '';
                              const d=new Date(ts); if(isNaN(d)) return '';
                              const diff=(Date.now()-d.getTime())/1000;
                              if(diff<60) return 'V·ª´a xong';
                              if(diff<3600) return Math.floor(diff/60)+' ph√∫t';
                              if(diff<86400) return Math.floor(diff/3600)+' gi·ªù';
                              if(diff<172800) return 'H√¥m qua';
                              return d.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'});
                            }
                            function updateCounts(arr){
                              const counts={all:arr.length, like:0,love:0,haha:0,sad:0,angry:0};
                              arr.forEach(r=>{ const t=String(r.reactionType||r.type||'').toLowerCase(); if(counts[t]!=null) counts[t]++; });
                              Object.keys(counts).forEach(k=>{
                                const el=modal.querySelector('[data-count=&quot;'+k+'&quot;]'); if(el) el.textContent=counts[k];
                              });
                            }
                            // Cache user details per modal open
                            const userCache = modal._userCache || new Map();
                            modal._userCache = userCache;

                            function getAuthorId(r){
                              return r.authorId || r.userId || r.ownerId || (r.user && (r.user.id || r.user.user_id)) || (r.author && (r.author.id || r.author.user_id)) || null;
                            }

                            async function fetchUserOnce(id){
                              if(!id) return null;
                              // de-dupe concurrent fetches by caching the pending promise
                              if(userCache.has(id)){
                                const cached = userCache.get(id);
                                return cached && typeof cached.then === 'function' ? await cached : cached;
                              }
                              const pending = (async () => {
                                try{
                                  const res = await fetch('/api/users/' + encodeURIComponent(id), { credentials:'include' });
                                  if(!res.ok) return null;
                                  const u = await res.json();
                                  return u || null;
                                }catch(e){ return null; }
                              })();
                              userCache.set(id, pending);
                              const resolved = await pending;
                              userCache.set(id, resolved);
                              return resolved;
                            }

                            function normName(u){
                              return (u && (u.full_name || u.fullName || u.name || u.username)) || '·∫®n danh';
                            }
                            function normAvatar(u){
                              return (u && (u.avatar_url || u.avatarUrl || u.avatar)) || '/img/image1.png';
                            }
                            function normEmail(u){
                              return (u && (u.email || u.emailAddress || u.mail || u.contactEmail || u.user_email)) || '';
                            }

                            async function renderList(arr, filter){
                              const f = String(filter||'all').toLowerCase();
                              const data = f==='all' ? arr : arr.filter(r => String(r.reactionType||r.type||'').toLowerCase()===f);

                              // helper: copy to clipboard
                              async function copyToClipboard(text){
                                try{
                                  if(navigator.clipboard && window.isSecureContext){
                                    await navigator.clipboard.writeText(text);
                                  }else{
                                    const ta=document.createElement('textarea');
                                    ta.value=text;
                                    ta.style.position='fixed';
                                    ta.style.top='-9999px';
                                    document.body.appendChild(ta);
                                    ta.focus();
                                    ta.select();
                                    document.execCommand('copy');
                                    ta.remove();
                                  }
                                  return true;
                                }catch(e){ return false; }
                              }

                              listEl.innerHTML='';
                              if(data.length===0){
                                const empty=document.createElement('div');
                                empty.className='text-muted small text-center py-2';
                                empty.textContent='Ch∆∞a c√≥ c·∫£m x√∫c n√†o.';
                                listEl.appendChild(empty);
                                return;
                              }

                              // Prefetch unique authors
                              const uniqueIds = Array.from(new Set(data.map(getAuthorId).filter(Boolean)));
                              await Promise.all(uniqueIds.map(id => fetchUserOnce(id)));

                              // Render rows
                              data.forEach(r=>{
                                const u = userCache.get(getAuthorId(r));
                                const name = normName(u);
                                const avatar = normAvatar(u);
                                const email = normEmail(u);
                                const t = String(r.reactionType||r.type||'').toLowerCase();

                                const item=document.createElement('div');
                                item.className='list-group-item d-flex align-items-center gap-2';

                                const img=document.createElement('img');
                                img.src=avatar; img.alt=''; img.className='rounded-circle';
                                img.style.width='36px'; img.style.height='36px'; img.style.objectFit='cover';

                                const body=document.createElement('div');
                                body.className='flex-fill d-flex flex-column';
                                const nm=document.createElement('div');
                                nm.className='fw-semibold';
                                nm.textContent=name;

                                const meta=document.createElement('div');
                                meta.className='text-muted small';
                                meta.textContent=fmtTime(r.createdAt||r.created_at||r.created||null);

                                body.appendChild(nm);
                                if(email){
                                  const emRow=document.createElement('div');
                                  emRow.className='text-muted small d-flex align-items-center gap-2';
                                  const em=document.createElement('span');
                                  em.textContent=email;

                                  const copyBtn=document.createElement('button');
                                  copyBtn.type='button';
                                  copyBtn.className='btn btn-sm btn-outline-secondary py-0 px-2';
                                  copyBtn.title='Sao ch√©p email';
                                  copyBtn.innerHTML=`<i class='bi bi-clipboard'></i>`;

                                  copyBtn.addEventListener('click', async (ev)=>{
                                    ev.stopPropagation();
                                    const ok = await copyToClipboard(email);
                                    const prev = copyBtn.innerHTML;
                                    copyBtn.innerHTML = ok ? `<i class='bi bi-clipboard-check'></i>` : `<i class='bi bi-clipboard-x'></i>`;
                                    copyBtn.disabled = true;
                                    setTimeout(()=>{
                                      copyBtn.innerHTML = prev;
                                      copyBtn.disabled = false;
                                    }, 1200);
                                  });

                                  emRow.appendChild(em);
                                  emRow.appendChild(copyBtn);
                                  body.appendChild(emRow);
                                }
                                body.appendChild(meta);

                                const ico=document.createElement('div');
                                ico.className='ms-auto rx-ico';
                                ico.innerHTML=iconByType(t);

                                item.appendChild(img);
                                item.appendChild(body);
                                item.appendChild(ico);

                                listEl.appendChild(item);
                              });
                            }

                            if(!modal._bound){
                              tabsWrap.addEventListener('click', function(ev){
                                const btnTab = ev.target.closest('[data-filter]'); if(!btnTab) return;
                                tabsWrap.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
                                btnTab.classList.add('active');
                                const filter = btnTab.getAttribute('data-filter');
                                renderList(modal._dataReactions||[], filter);
                              });
                              modal._bound=true;
                            }

                            let arr=[];
                            try{
                              const res=await fetch('/api/posts/'+encodeURIComponent(postId)+'/reactions/all',{credentials:'include'});
                              arr = res.ok? await res.json() : [];
                              if(!Array.isArray(arr)) arr=[];
                            }catch(e){ arr=[]; }
                            modal._dataReactions = arr;

                            updateCounts(arr);
                            tabsWrap.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
                            const allTab=tabsWrap.querySelector('[data-filter=&quot;all&quot;]'); if(allTab) allTab.classList.add('active');
                            renderList(arr,'all');

                            bootstrap.Modal.getOrCreateInstance(modal).show();
                          }catch(e){ console.error(e); }
                        })(this)">
                    <span class="rx-ico most-reaction"></span>
                    <span class="rx-ico second-most-reaction"></span>
                    <span class="like-count">0</span>
                </button>

                <!-- Modal xem chi ti·∫øt reactions -->
                <div class="modal fade reactions-modal" tabindex="-1" aria-hidden="true" role="dialog">
                  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">C·∫£m x√∫c</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng" 
              onclick="(function(btn){ try{ var art = btn.closest('article'); var b = art && art.querySelector('.btn-reaction-summary'); if(b) b.focus(); }catch(e){} })(this)"
            ></button>
                      </div>
                      <div class="modal-body">
                        <ul class="nav nav-pills reaction-tabs gap-1 mb-3 flex-wrap">
                          <li class="nav-item">
                            <button type="button" class="nav-link active" data-filter="all">T·∫•t c·∫£
                              <span class="badge bg-secondary ms-1" data-count="all">0</span>
                            </button>
                          </li>
                          <li class="nav-item">
                            <button type="button" class="nav-link" data-filter="like">Th√≠ch
                              <span class="badge bg-secondary ms-1" data-count="like">0</span>
                            </button>
                          </li>
                          <li class="nav-item">
                            <button type="button" class="nav-link" data-filter="love">Y√™u th√≠ch
                              <span class="badge bg-secondary ms-1" data-count="love">0</span>
                            </button>
                          </li>
                          <li class="nav-item">
                            <button type="button" class="nav-link" data-filter="haha">Haha
                              <span class="badge bg-secondary ms-1" data-count="haha">0</span>
                            </button>
                          </li>
                          <li class="nav-item">
                            <button type="button" class="nav-link" data-filter="sad">Bu·ªìn
                              <span class="badge bg-secondary ms-1" data-count="sad">0</span>
                            </button>
                          </li>
                          <li class="nav-item">
                            <button type="button" class="nav-link" data-filter="angry">Ph·∫´n n·ªô
                              <span class="badge bg-secondary ms-1" data-count="angry">0</span>
                            </button>
                          </li>
                        </ul>
                        <div class="list-group reactions-list"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <style>
                  /* Facebook-like compact stats row */
                  #post-info-reactions-and-comments{
                    display:flex;align-items:center;justify-content:space-between;gap:12px;
                    padding:.25rem 0;border:0;margin:0;
                  }
                  #post-info-reactions-and-comments .btn-reaction-summary:hover{ text-decoration:underline; color:#050505; }
                  #post-info-reactions-and-comments .rx-ico{
                    width:18px;height:18px;border-radius:50%;
                    display:inline-flex;align-items:center;justify-content:center;
                    background:#fff;border:1px solid #e4e6eb;box-shadow:0 1px 1px rgba(0,0,0,.08);
                    font-size:12px; margin-left:-6px;
                  }
                  #post-info-reactions-and-comments .rx-ico:first-child{ margin-left:0; }
                  #post-info-reactions-and-comments .like-count{ margin-left:4px; color:#65676b; }

                  /* Modal ‚Äî closer to FB pills/list */
                  .reactions-modal .nav-link{
                    display:inline-flex;align-items:center;gap:6px;border-radius:20px;
                    background:#f0f2f5;color:#050505;
                  }
                  .reactions-modal .nav-link.active{ background:#e7f3ff;color:#1b74e4; }
                  .reactions-modal .list-group-item{ border:0;padding:.5rem .25rem; }
                  .reactions-modal .rx-ico{
                    width:20px;height:20px;border-radius:50%;
                    display:inline-flex;align-items:center;justify-content:center;
                    background:#fff;border:1px solid #e4e6eb;box-shadow:0 1px 1px rgba(0,0,0,.08);
                    font-size:12px;
                  }
                </style>

                <!-- N√∫t hi·ªÉn th·ªã s·ªë comment -->
                <button type="button" class="btn-comment-summary" aria-label="Xem b√¨nh lu·∫≠n"
                  style="background:transparent;border:0;padding:0;color:#65676b;font-weight:500;font-size:.9rem;line-height:1;text-transform:none;box-shadow:none;"
                  onclick="(function(btn){
                  try{
                    var article = btn.closest('article'); if(!article) return;
                    var modal = Array.from(article.querySelectorAll('.comments-modal')).find(function(m){ return m.closest('article')===article; }) || null;
                    if(modal){
                      try{ if(!article._loadComments && typeof window.initCommentsForArticle==='function'){ window.initCommentsForArticle(article); } }catch(_){ }
                      if(article._loadComments) article._loadComments();
                      var inst = bootstrap.Modal.getOrCreateInstance(modal);
                      inst.show();
                      setTimeout(function(){
                        var input = article.querySelector('.modal-comment-input');
                        if(input) input.focus();
                      }, 200);
                    }
                  }catch(e){}
                  })(this)">
                  <span class="ico"><i class="bi bi-chat-dots"></i></span>
                  <span class="txt">B√¨nh lu·∫≠n</span>
                  <span class="count comment-count">0</span>
                </button>

                <!-- T·∫£i s·ªë b√¨nh lu·∫≠n ban ƒë·∫ßu -->
                <script>
                  (function(){
                  try{
                    var sc = document.currentScript;
                    var article = sc;
                    while(article && article.tagName !== 'ARTICLE'){ article = article.parentElement; }
                    if(!article) return;

                    var countEl = article.querySelector('.comment-count');
                    if(!countEl) return;

                    async function setCount(n){
                    countEl.textContent = Number(n||0);
                    }

                    async function fetchInitialCount(postId){
                    //  t·∫£i danh s√°ch v√† ƒë·∫øm
                    try{
                      var r2 = await fetch('/api/posts/'+encodeURIComponent(postId)+'/comments', { credentials:'include' });
                      if(r2.ok){
                      var d = await r2.json();
                      if(Array.isArray(d)){ setCount(d.length); return; }
                      if(d && typeof d.totalElements === 'number'){ setCount(d.totalElements); return; }
                      if(d && Array.isArray(d.content)){ setCount(d.content.length); return; }
                      }
                    }catch(_){}
                    setCount(0);
                    }

                    function init(){
                    if(article._commentCountLoaded) return;
                    var postId = article.dataset.postId;
                    if(!postId){ setTimeout(init, 50); return; }
                    article._commentCountLoaded = true;
                    fetchInitialCount(postId);
                    }

                    init();
                  }catch(_){}
                  })();
                </script>

                <!-- N√∫t hi·ªÉn th·ªã s·ªë chia s·∫ª -->
                <button type="button" class="btn-share-summary" aria-label="Xem s·ªë chia s·∫ª"
                  style="background:transparent;border:0;padding:0;color:#65676b;font-weight:500;font-size:.9rem;line-height:1;text-transform:none;box-shadow:none;margin-left:16px;"
                  onclick="(function(btn){ try{ var article=btn.closest('article'); if(!article) return; var shareList=article.querySelector('.post-shares'); if(shareList){ shareList.scrollIntoView({behavior:'smooth', block:'nearest'}); } }catch(e){} })(this)">
                  <span class="ico"><i class="bi bi-share"></i></span>
                  <span class="txt">Chia s·∫ª</span>
                  <span class="count share-count">0</span>
                </button>

                <!-- T·∫£i s·ªë chia s·∫ª ban ƒë·∫ßu + helper global refresh -->
                <script>
                  (function(){
                    try{
                      var sc = document.currentScript;
                      var article = sc;
                      while(article && article.tagName !== 'ARTICLE'){ article = article.parentElement; }
                      if(!article) return;

                      var countEl = article.querySelector('.share-count');
                      if(!countEl) return;

                      async function setCount(n){ countEl.textContent = Number(n||0); }

                      async function fetchShareCount(postId){
                        try{
                          var r = await fetch('/api/posts/'+encodeURIComponent(postId)+'/shares',{credentials:'include'});
                          if(r.ok){
                            var data = await r.json().catch(()=>[]);
                            if(Array.isArray(data)) return data.length;
                            if(data && Array.isArray(data.content)) return data.content.length;
                            if(Number.isFinite(data.totalElements)) return data.totalElements;
                            if(Number.isFinite(data.total)) return data.total;
                            if(Number.isFinite(data.count)) return data.count;
                          }
                        }catch(_){ }
                        return 0;
                      }

                      async function init(){
                        if(article._shareCountLoaded) return;
                        var postId = article.dataset.postId; if(!postId){ setTimeout(init,50); return; }
                        article._shareCountLoaded = true;
                        var n = await fetchShareCount(postId);
                        setCount(n);
                      }

                      // tiny global helper to refresh share count across all cards for a post
                      window.QDTCounts = window.QDTCounts || {};
                      window.QDTCounts.refreshShareCountForPost = async function(postId){
                        try{
                          var n = await fetchShareCount(postId);
                          // update all matching article nodes whether they use data-post-id or data-original-post-id
                          const selShares = 'article.post-card[data-post-id="'+String(postId)+'"] .share-count, article.post-card.share-item[data-original-post-id="'+String(postId)+'"] .share-count, article.post-card[data-original-post-id="'+String(postId)+'"] .share-count';
                          document.querySelectorAll(selShares).forEach(function(el){ el.textContent = Number(n||0); });
                        }catch(_){ }
                      }

                      init();
                    }catch(_){ }
                  })();
                </script>

              </div>



              <div class="pc-actions">
                <!-- ReactionsComposer:BEGIN -->
                <div class="reaction-composer" style="position:relative;flex:1;display:flex;align-items:stretch;"
                     onmouseenter="(function(w){
                        try{
                          clearTimeout(w._hideTo);
                          var pop=w.querySelector('.react-popover');

                          // ensure we cancel delayed show when leaving wrapper
                          if(!w._boundLeave){
                            w.addEventListener('mouseleave', function(){
                              try{ clearTimeout(w._showTo); }catch(e){}
                            });
                            w._boundLeave=1;
                          }

                          if(pop){
                            // delay 200ms before showing
                            clearTimeout(w._showTo);
                            w._showTo=setTimeout(function(){
                              pop.style.display='flex';

                              if(!pop._bound){
                                pop.addEventListener('mouseenter', function(){
                                  try{ clearTimeout(w._hideTo); clearTimeout(w._showTo);}catch(e){}
                                  this.style.display='flex';
                                });
                                pop.addEventListener('mouseleave', function(){
                                  try{ clearTimeout(w._hideTo); clearTimeout(w._showTo);}catch(e){}
                                  w._hideTo=setTimeout(()=>{ this.style.display='none'; }, 300);
                                });
                                pop._bound=1;
                              }

                              if(window.QDTReactions) window.QDTReactions.ensureLoaded(w);
                            }, 200);
                          }
                        }catch(e){}
                     })(this)"
                     onmouseleave="(function(w){
                        try{
                          clearTimeout(w._hideTo);
                          var pop=w.querySelector('.react-popover');
                          w._hideTo=setTimeout(function(){ if(pop) pop.style.display='none'; }, 300);
                        }catch(e){}
                     })(this)">

                  <!-- Main Reaction Button (quick Like toggle) -->
                  <button type="button" class="act-btn btn-like" data-active="0" data-reaction=""
                          onclick="(function(btn){
                            // N·∫øu ƒë√£ c√≥ reaction r·ªìi th√¨ b·ªè reaction
                            try{
                                const article=btn.closest('article'); if(!article) return;
                                const currentType=(article.getAttribute('data-my-reaction')||'').toLowerCase();
                                if(currentType){
                                    const currentId=(article.getAttribute('data-my-reaction-id')||'');
                                    if(currentId){
                                        console.log('Removing reaction:', currentId);
                                        fetch('/api/posts/'+encodeURIComponent(article.dataset.postId)+'/reactions/'+encodeURIComponent(currentId),{
                                            method:'DELETE',credentials:'include'
                                        }).then(res=>{
                                            if(res.ok){
                                                if(window.QDTReactions) window.QDTReactions.ensureLoaded(btn.closest('.reaction-composer'));
                                            }
                                        }).catch(()=>{});
                                    }
                                    // C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
                                    if(window.QDTReactions) window.QDTReactions.toggleLike(btn.closest('.reaction-composer'));

                                    return;
                                }
                            }catch(e){}

                            try{
                              if(event){event.stopPropagation(); if(event.stopImmediatePropagation) event.stopImmediatePropagation();}
                              if(window.QDTReactions) window.QDTReactions.toggleLike(btn.closest('.reaction-composer'));
                            }catch(e){}
                          })(this)">
                    <span class="ico"><i class="bi bi-hand-thumbs-up"></i></span>
                    <span class="txt">Th√≠ch</span>
                </button>

                  <!-- Reaction Popover -->
                    <style>
                    .qdt-react-pop{
                      display:none;position:absolute;bottom:110%;left:0;
                      background:linear-gradient(180deg,#ffffffaa,#fffffff0);
                      border:1px solid rgba(120,150,190,.35);
                      box-shadow:0 10px 28px rgba(30,70,140,.18), inset 0 1px 0 rgba(255,255,255,.9);
                      border-radius:999px;padding:8px 10px;gap:8px;z-index:20;
                      align-items:center;justify-content:center;
                      backdrop-filter:saturate(140%) blur(6px); -webkit-backdrop-filter:saturate(140%) blur(6px);
                      animation:qdt-pop-in .16s cubic-bezier(.2,.9,.2,1);
                    }
                    .qdt-react-pop .rx-btn{
                      width:44px;height:44px;border-radius:50%;
                      border:1px solid rgba(120,150,190,.35);
                      background:linear-gradient(180deg,#f7fbff,#eef5ff);
                      font-size:22px;line-height:1;display:flex;align-items:center;justify-content:center;
                      box-shadow:0 4px 10px rgba(30,70,140,.18), inset 0 1px 0 rgba(255,255,255,.9);
                      transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
                      cursor:pointer;
                    }
                    .qdt-react-pop .rx-btn:hover{
                      transform:translateY(-2px) scale(1.08);
                      box-shadow:0 10px 18px rgba(30,70,140,.25), inset 0 1px 0 rgba(255,255,255,.95);
                      filter:saturate(1.1);
                    }
                    .qdt-react-pop .rx-btn:active{ transform:translateY(0) scale(.96); }
                    .qdt-react-pop .rx-like{ background:linear-gradient(180deg,#e7f3ff,#f2f8ff); border-color:#b9d7ff; color:#1b74e4; }
                    .qdt-react-pop .rx-love{ background:linear-gradient(180deg,#fff0f2,#ffe5ea); border-color:#ffc2cc; }
                    .qdt-react-pop .rx-haha{ background:linear-gradient(180deg,#fff8e1,#fff2bf); border-color:#ffe29a; }
                    .qdt-react-pop .rx-sad{  background:linear-gradient(180deg,#eaf5ff,#dff0ff); border-color:#bcdcff; }
                    .qdt-react-pop .rx-angry{background:linear-gradient(180deg,#ffe8e5,#ffd9d3); border-color:#ffc2b8; }
                    .qdt-react-pop .rx-arrow{
                      position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);
                      width:14px;height:14px;background:#fffffff0;border:1px solid rgba(120,150,190,.35);
                      border-top:none;border-left:none;transform:translateX(-50%) rotate(45deg);
                      box-shadow:2px 2px 10px rgba(30,70,140,.15);
                    }
                    /* @keyframes qdt-pop-in{
                      0%{ transform:translateX(-50%) translateY(6px) scale(.96); opacity:0; }
                      100%{ transform:translateX(-50%) translateY(0)  scale(1);    opacity:1; }
                    } */
                    </style>

                    <div class="react-popover qdt-react-pop" role="group" aria-label="Ch·ªçn c·∫£m x√∫c">
                    <!-- <span class="rx-arrow" aria-hidden="true"></span> -->

                    <!-- like -->
                    <button type="button" class="rx-btn rx-like" title="Th√≠ch"
                        onclick="(function(opt){ if(window.QDTReactions) window.QDTReactions.setReaction(opt.closest('.reaction-composer'),'like'); })(this)">üëç</button>

                    <!-- love -->
                    <button type="button" class="rx-btn rx-love" title="Y√™u th√≠ch"
                        onclick="(function(opt){ if(window.QDTReactions) window.QDTReactions.setReaction(opt.closest('.reaction-composer'),'love'); })(this)">
                      <i class="bi bi-heart-fill text-danger"></i>
                    </button>

                    <!-- haha -->
                    <button type="button" class="rx-btn rx-haha" title="Haha"
                        onclick="(function(opt){ if(window.QDTReactions) window.QDTReactions.setReaction(opt.closest('.reaction-composer'),'haha'); })(this)">üòÜ</button>

                    <!-- sad -->
                    <button type="button" class="rx-btn rx-sad" title="Bu·ªìn"
                        onclick="(function(opt){ if(window.QDTReactions) window.QDTReactions.setReaction(opt.closest('.reaction-composer'),'sad'); })(this)">üò¢</button>

                    <!-- angry -->
                    <button type="button" class="rx-btn rx-angry" title="Ph·∫´n n·ªô"
                        onclick="(function(opt){ if(window.QDTReactions) window.QDTReactions.setReaction(opt.closest('.reaction-composer'),'angry'); })(this)">üò°</button>
                    </div>
                </div>

                <script>
                (function(){
                    if(window.QDTReactions) return;

                    function iconByType(t){
                        t=String(t||'').toLowerCase();
                        if(t==='love') return '<i class="bi bi-heart-fill text-danger"></i>';
                        if(t==='haha') return 'üòÜ';
                        if(t==='sad')  return 'üò¢';
                        if(t==='angry')return 'üò°';
                        return '<i class="bi bi-hand-thumbs-up"></i>';
                    } 

                    function labelByType(t){
                        t=String(t||'').toLowerCase();
                        if(t==='love') return 'Y√™u th√≠ch';
                        if(t==='haha') return 'Haha';
                        if(t==='sad')  return 'Bu·ªìn';
                        if(t==='angry')return 'Ph·∫´n n·ªô';
                        return 'Th√≠ch';
                    }

                    async function fetchAll(postId){
                        try{
                            const r=await fetch('/api/posts/'+encodeURIComponent(postId)+'/reactions/all',{credentials:'include'});
                            if(!r.ok) return [];
                            const data=await r.json();
                            return Array.isArray(data)?data:[];
                        }catch(e){return [];}
                    }

                    function getMine(arr){
                        const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                        const meId=auth.user_id;
                        return arr.find(it=>
                            (it&&it.authorId&&meId!=null&&(String(it.authorId)===String(meId)))||
                            it.mine===true||it.ownedByRequester===true
                        )||null;
                    }

                    function updateUI(wrap, mine, total, arr=null){
                        const article=wrap.closest('article'); if(!article) return;
                        const btn=wrap.querySelector('.btn-like');
                        const countEl=wrap.querySelector('.like-count');
                        if(countEl) countEl.textContent = Number(total||0);
                        const t = mine?(mine.reactionType||''):'';
                        const id = mine?(mine.id||''):'';
                        article.setAttribute('data-my-reaction', t||'');
                        article.setAttribute('data-my-reaction-id', id||'');
                        if(btn){
                            btn.dataset.active = t? '1':'0';
                            btn.setAttribute('data-reaction', t||'');
                            const txt=btn.querySelector('.txt'); if(txt) txt.textContent = t? labelByType(t) : 'Th√≠ch';
                            const ico=btn.querySelector('.ico'); if(ico) ico.innerHTML = iconByType(t);
                        }

                        // C·∫≠p nh·∫≠t ph·∫ßn hi·ªÉn th·ªã t·ªïng h·ª£p reactions
                        console.log('Updating reactions');
                        const infoWrap = article.querySelector('#post-info-reactions-and-comments');
                        if(infoWrap){
                            const likeCountEl = infoWrap.querySelector('.like-count');
                            const mostReactionEl = infoWrap.querySelector('.most-reaction');
                            const secondMostReactionEl = infoWrap.querySelector('.second-most-reaction');

                            // ƒê·∫øm s·ªë l∆∞·ª£ng t·ª´ng lo·∫°i reaction
                            const reactionCounts = {};
                            (arr||[]).forEach(r => {
                                const type = (r.reactionType || '').toLowerCase();
                                if(type){
                                    reactionCounts[type] = (reactionCounts[type] || 0) + 1;
                                }
                            });

                            // S·∫Øp x·∫øp c√°c lo·∫°i reaction theo s·ªë l∆∞·ª£ng gi·∫£m d·∫ßn
                            const sortedReactions = Object.entries(reactionCounts)
                                .sort((a, b) => b[1] - a[1]);

                            // C·∫≠p nh·∫≠t giao di·ªán
                            // N·∫øu b·∫°n ƒë√£ reaction, hi·ªÉn th·ªã "b·∫°n v√† x ng∆∞·ªùi kh√°c"
                            if(mine && total > 1){
                                if(likeCountEl) likeCountEl.textContent = "B·∫°n v√† " + (total - 1) + ' ng∆∞·ªùi kh√°c';
                            } else if(mine && total === 1){
                                if(likeCountEl) likeCountEl.textContent = 'B·∫°n';
                            } else {
                                if(likeCountEl) likeCountEl.textContent = total > 0 ? total : 'Ch∆∞a c√≥ reaction n√†o...';
                            }
                            if(mostReactionEl) mostReactionEl.innerHTML = sortedReactions[0] ? iconByType(sortedReactions[0][0]) : '<i class="bi bi-plus"></i>';
                            if(secondMostReactionEl) secondMostReactionEl.innerHTML = sortedReactions[1] ? iconByType(sortedReactions[1][0]) : '‚ãØ';
                        }

            // Broadcast: sync reactions UI across all cards of the same postId (original + share)
            try{
              const postId = article.dataset.postId;
              if(postId){
                const rc = {};
                (arr||[]).forEach(r => { const type=(r.reactionType||'').toLowerCase(); if(type){ rc[type]=(rc[type]||0)+1; } });
                const sorted = Object.entries(rc).sort((a,b)=> b[1]-a[1]);
                const totalAll = Object.values(rc).reduce((s,c)=>s+c,0);

                // target both post-card[data-post-id] and share-item/data-original-post-id variants
                const sel = 'article.post-card[data-post-id="'+String(postId)+'"],'
                          + 'article.post-card.share-item[data-original-post-id="'+String(postId)+'"],'
                          + 'article.post-card[data-original-post-id="'+String(postId)+'"]';
                document.querySelectorAll(sel).forEach(function(other){
                  if(!other || other===article) return;
                  try{
                    // summary pills
                    const wrap2 = other.querySelector('#post-info-reactions-and-comments');
                    if(wrap2){
                      const likeCount2 = wrap2.querySelector('.like-count');
                      const most2 = wrap2.querySelector('.most-reaction');
                      const second2 = wrap2.querySelector('.second-most-reaction');
                      if(likeCount2) likeCount2.textContent = totalAll > 0 ? totalAll : 'Ch∆∞a c√≥ reaction n√†o...';
                      if(most2) most2.innerHTML = sorted[0] ? iconByType(sorted[0][0]) : '<i class="bi bi-plus"></i>';
                      if(second2) second2.innerHTML = sorted[1] ? iconByType(sorted[1][0]) : '‚ãØ';
                    }
                    // composer counter and button label
                    const comp2 = other.querySelector('.reaction-composer');
                    if(comp2){
                      const lc2 = comp2.querySelector('.like-count'); if(lc2) lc2.textContent = Number(totalAll||0);
                      const btn2 = comp2.querySelector('.btn-like');
                      other.setAttribute('data-my-reaction', t||'');
                      other.setAttribute('data-my-reaction-id', id||'');
                      if(btn2){
                        btn2.dataset.active = t? '1':'0';
                        btn2.setAttribute('data-reaction', t||'');
                        const txt2=btn2.querySelector('.txt'); if(txt2) txt2.textContent = t? labelByType(t) : 'Th√≠ch';
                        const ico2=btn2.querySelector('.ico'); if(ico2) ico2.innerHTML = iconByType(t);
                      }
                    }
                  }catch(_){ }
                });
              }
            }catch(_){ }
                    }

                    async function refresh(wrap){
                        const article=wrap.closest('article'); if(!article) return;
                        const postId=article.dataset.postId; if(!postId) return;
                        const arr = await fetchAll(postId);
                        updateUI(wrap, getMine(arr), arr.length, arr);
                        wrap.dataset.loaded='1';
                    }

                    async function setReaction(wrap, type){
                        const article=wrap.closest('article'); if(!article) return;
                        const postId=article.dataset.postId; if(!postId) return;
                        const currentType=(article.getAttribute('data-my-reaction')||'').toLowerCase();
                        const currentId=(article.getAttribute('data-my-reaction-id')||'');

                        const body={type:String(type||'').toLowerCase()};
                        const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                        if(auth&&auth.user_id){
                            body.user={ id : auth.user_id };
                        }
                        await fetch('/api/posts/'+encodeURIComponent(postId)+'/reactions',{
                            method:'POST',credentials:'include',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify(body)
                        }).catch(()=>{});
                        await refresh(wrap);
                        const pop=wrap.querySelector('.react-popover'); if(pop) pop.style.display='none';
                    }

                    async function toggleLike(wrap){
                        const article=wrap.closest('article'); if(!article) return;
                        const currentType=(article.getAttribute('data-my-reaction')||'').toLowerCase();
                        if(currentType==='like') return setReaction(wrap,'like'); // will remove
                        return setReaction(wrap,'like'); // will set to like
                    }

                    function ensureLoaded(wrap){
                        if(!wrap || wrap.dataset.loaded==='1') return;
                        refresh(wrap);
                    }

                    function autoInit(){
                        document.querySelectorAll('.reaction-composer').forEach(w=>ensureLoaded(w));
                    }

                    window.QDTReactions={ensureLoaded, setReaction, toggleLike};
                    if(document.readyState!=='loading'){ setTimeout(autoInit,0); }
                    else { document.addEventListener('DOMContentLoaded', autoInit); }
                    // try{
                    //     const mo=new MutationObserver(()=>autoInit());
                    //     mo.observe(document.documentElement,{childList:true,subtree:true});
                    // }catch(e){}
                })();
                </script>
                <!-- ReactionsComposer:END -->


                <!-- Comments -->
                <button type="button" class="act-btn btn-comment" onclick="(function(btn){try{var article=btn.closest('article'); if(!article) return; var modal = Array.from(article.querySelectorAll('.comments-modal')).find(function(m){return m.closest('article')===article;})||null; if(!modal) return; if(!article._loadComments && typeof window.initCommentsForArticle==='function'){ window.initCommentsForArticle(article);} if(article._loadComments){ article._loadComments(); } var inst = bootstrap.Modal.getOrCreateInstance(modal); inst.show();}catch(e){ console.error('[comments:btn-click] failed', e); }})(this)">
                    <span class="ico"><i class="bi bi-chat-dots"></i></span>
                    <span class="txt">B√¨nh lu·∫≠n</span>
                </button>
        <!-- Share -->
        <button type="button" class="act-btn" onclick="(function(btn){ try{ var article=btn.closest('article'); if(!article) return; var modal=article.querySelector('.share-modal'); if(modal) bootstrap.Modal.getOrCreateInstance(modal).show(); }catch(e){} })(this)">
          <span class="ico"><i class="bi bi-share"></i></span>
          <span class="txt">Chia s·∫ª</span>
        </button>

              </div>

              <!-- Hidden footer to keep existing JS safe, but open modal instead -->
              <div class="pc-footer d-none">
                <input type="text"
                       class="form-control form-control-sm cm-input"
                       placeholder="Vi·∫øt b√¨nh lu·∫≠n..."
                       style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;"
                       onfocus="(function(inp){
                         try{
                           var article = inp.closest('article');
                           var modal = article.querySelector('.comments-modal');
                           if(modal){ bootstrap.Modal.getOrCreateInstance(modal).show(); }
                           var f = inp.closest('.pc-footer'); if(f) f.classList.add('d-none');
                         }catch(e){}
                       })(this)">
              </div>

                <!-- Comments Modal:BEGIN -->
                <div class="modal fade comments-modal" tabindex="-1" aria-hidden="true" role="dialog">
                  <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title">B√¨nh lu·∫≠n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                    </div>
                    <div class="modal-body">
                    <div class="list-group comments-list">
                      <div class="text-muted small text-center py-2">Ch∆∞a c√≥ b√¨nh lu·∫≠n.</div>
                    </div>
                    <div class="mt-3 d-flex gap-2">
                      <input type="text" class="form-control modal-comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
                      <button type="button" class="btn btn-primary"
                          onclick="(async function(btn){
                          try{
                            var article = btn.closest('article'); if(!article) return;
                            var postId = article.dataset.postId; if(!postId) return;
                            // scope to the current comments modal to avoid nested preview collisions
                            var modalEl = btn.closest('.modal');
                            var input = modalEl ? modalEl.querySelector('.modal-comment-input') : article.querySelector('.modal-comment-input');
                            var text = (input && input.value || '').trim();
                            if(!text) return;

                            var auth = {};
                            try{ auth = JSON.parse(localStorage.getItem('auth')||'{}'); }catch(e){}
                            var uid = auth && (auth.user_id || auth.id || auth.userId);
                            var body = { content: text };
                            if(uid!=null) body.user = { id: uid };

                            const res = await fetch('/api/posts/'+encodeURIComponent(postId)+'/comments',{
                              method:'POST',
                              credentials:'include',
                              headers:{'Content-Type':'application/json'},
                              body: JSON.stringify(body)
                            });
                            if(res.ok){
                            input.value='';
                            if(article._loadComments) await article._loadComments();
                            }
                          }catch(e){}
                          })(this)">
                      G·ª≠i
                      </button>
                    </div>
                    </div>
                  </div>
                  </div>
                </div>
                

                <!-- Share Modal:BEGIN -->
                <div class="modal fade share-modal" tabindex="-1" aria-hidden="true" role="dialog">
                  <div class="modal-dialog modal-dialog-centered modal-md">
                  <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title">Chia s·∫ª b√†i vi·∫øt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-2">
                        <textarea class="form-control share-textarea" rows="3" placeholder="Vi·∫øt g√¨ ƒë√≥ khi chia s·∫ª..."></textarea>
                      </div>
                      <div class="mb-2">
                        <label class="form-label small">Ai c√≥ th·ªÉ xem</label>
                        <select class="form-select form-select-sm share-visibility">
                          <option value="public">C√¥ng khai</option>
                          <option value="friends">B·∫°n b√®</option>
                          <option value="private">Ch·ªâ m√¨nh t√¥i</option>
                        </select>
                      </div>
                      <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="button" class="btn btn-primary share-send-btn">Chia s·∫ª</button>
                      </div>
                    </div>
                  </div>
                  </div>
                </div>

                <script>
                (function(){
                  try{
                    var script = document.currentScript;
                    var article = script;
                    while(article && article.tagName !== 'ARTICLE'){ article = article.parentElement; }
                    if(!article) return;

                    var shareModal = article.querySelector('.share-modal');
                    if(!shareModal) return;

                    var btn = shareModal.querySelector('.share-send-btn');
                    var ta = shareModal.querySelector('.share-textarea');

                    if(!btn) return;
                    if(btn.dataset._shareHandler === '1'){
                      // already attached
                  } else {
                      btn.dataset._shareHandler = '1';
                      btn.addEventListener('click', async function(){
                        try{
                          if(btn.dataset.sending==='1') return; // prevent double submit
                          btn.dataset.sending='1';
                          btn.disabled = true;

                          try{
                            var postId = article.dataset.postId; if(!postId) return;
                            var text = (ta && ta.value||'').trim();
                            var visEl = shareModal.querySelector('.share-visibility');
                            var visibility = (visEl && visEl.value) || 'public';
                            var body = { shared_text: text, visibility: visibility };
                            var res = await fetch('/api/posts/'+encodeURIComponent(postId)+'/shares', {
                              method: 'POST', credentials: 'include',
                              headers: {'Content-Type':'application/json'},
                              body: JSON.stringify(body)
                            });

                            if(res.ok){
                              // hide modal and show small toast-like feedback
                              bootstrap.Modal.getInstance(shareModal).hide();
                              try{ var toasts = document.querySelector('.qdt-toast-area'); if(!toasts){ toasts = document.createElement('div'); toasts.className='qdt-toast-area position-fixed top-0 end-0 p-3'; document.body.appendChild(toasts);} var t = document.createElement('div'); t.className='toast show bg-success text-white p-2 my-2'; t.textContent='ƒê√£ chia s·∫ª'; toasts.appendChild(t); setTimeout(()=>t.remove(),3000);}catch(e){}
                              // clear textarea
                              try{ if(ta) ta.value = ''; }catch(e){}
                              // refresh per-post share list
                              try{ if(typeof article._loadShares === 'function') article._loadShares(); }catch(e){}
                              // refresh global share count (ties to original post id on share cards)
                              try{ if(window.QDTCounts && window.QDTCounts.refreshShareCountForPost){ window.QDTCounts.refreshShareCountForPost(article.dataset.postId); } }catch(e){}
                              // refresh the whole feed so the new share appears as a feed item
                              try{ if(typeof loadPosts === 'function') loadPosts(); }catch(e){}
                              } else {
                              var json = {};
                              try{ json = await res.json(); }catch(e){}
                              alert('Kh√¥ng th·ªÉ chia s·∫ª: '+(json && json.message?json.message:res.status));
                            }

                          }catch(e){ console.error(e); alert('L·ªói khi chia s·∫ª'); }
                          finally{ try{ btn.dataset.sending='0'; btn.disabled=false; }catch(_){} }
                      
                          }catch(e){ console.error(e);
                    }
                      });
                        if(btn){
                          if(btn.dataset._shareHandler === '1'){
                            // already attached
                          } else {
                            btn.dataset._shareHandler = '1';
                            btn.addEventListener('click', async function(){
                              try{
                                if(btn.dataset.sending === '1') return;
                                btn.dataset.sending = '1';
                                btn.disabled = true;
                                var postId = article.dataset.postId; if(!postId) return;
                                var text = (ta && ta.value||'').trim();
                                var visEl = shareModal.querySelector('.share-visibility');
                                var visibility = (visEl && visEl.value) || 'public';
                                var body = { shared_text: text, visibility: visibility };
                                var res = await fetch('/api/posts/'+encodeURIComponent(postId)+'/shares', {
                                  method: 'POST', credentials: 'include',
                                  headers: {'Content-Type':'application/json'},
                                  body: JSON.stringify(body)
                                });
                                if(res.ok){
                                  try{ bootstrap.Modal.getInstance(shareModal).hide(); }catch(_){ }
                                  try{ var toasts = document.querySelector('.qdt-toast-area'); if(!toasts){ toasts = document.createElement('div'); toasts.className='qdt-toast-area position-fixed top-0 end-0 p-3'; document.body.appendChild(toasts);} var t = document.createElement('div'); t.className='toast show bg-success text-white p-2 my-2'; t.textContent='ƒê√£ chia s·∫ª'; toasts.appendChild(t); setTimeout(()=>t.remove(),3000);}catch(e){}
                                  try{ if(ta) ta.value = ''; }catch(e){}
                                  try{ if(typeof article._loadShares === 'function') article._loadShares(); }catch(e){}
                                  try{ if(window.QDTCounts && window.QDTCounts.refreshShareCountForPost){ window.QDTCounts.refreshShareCountForPost(article.dataset.postId); } }catch(e){}
                                  try{ if(typeof loadPosts === 'function') loadPosts(); }catch(e){}
                                } else {
                                  var json = {};
                                  try{ json = await res.json(); }catch(e){}
                                  alert('Kh√¥ng th·ªÉ chia s·∫ª: '+(json && json.message?json.message:res.status));
                                }
                              }catch(e){ console.error(e); alert('L·ªói khi chia s·∫ª'); }
                              finally{ try{ btn.dataset.sending='0'; btn.disabled=false; }catch(_){} }
                            });
                          }
                      }

                    // auto-load shares on article render
                    try{ article._loadShares(); }catch(e){}

                  }catch(e){};

                })();

                </script>


                <script>
                (function(){
                  try{
                  var script = document.currentScript;
                  var article = script;
                  while(article && article.tagName !== 'ARTICLE'){ article = article.parentElement; }
                  if(!article) return;

                  var modal = article.querySelector('.comments-modal');
                  if(!modal) return;

                  var listEl = modal.querySelector('.comments-list');

                  // Global initializer: attach a per-article loader and modal hook so shares and clones work reliably
                  // Always resolves the post id from article.dataset.postId (single source of truth)
                  if(typeof window.initCommentsForArticle !== 'function'){
                    window.initCommentsForArticle = function(articleNode){
                      try{
                        if(!articleNode) return;
                        if(articleNode._commentsInit) return; // avoid double-init
                        articleNode._commentsInit = true;
                        const cmModal = Array.from(articleNode.querySelectorAll('.comments-modal')).find(function(m){ return m.closest('article') === articleNode; }) || null;
                        if(!cmModal) return;
                        const cmList = cmModal.querySelector('.comments-list');

                        async function loadCommentsForArticle(){
                          const postId = articleNode.dataset.postId;
                          if(!postId) return;
                          try{
                            cmList.innerHTML = '<div class="text-center text-muted small py-2">ƒêang t·∫£i b√¨nh lu·∫≠n...</div>';
                            const res = await fetch('/api/posts/'+encodeURIComponent(postId)+'/comments', { credentials:'include' });
                            const data = res.ok ? await res.json() : [];
                            let arr = [];
                            if(Array.isArray(data)) arr = data;
                            else if(data && Array.isArray(data.content)) arr = data.content;
                            else if(data && Array.isArray(data.items)) arr = data.items;
                            else if(data && Array.isArray(data.data)) arr = data.data;

                            // Ensure a per-article user cache
                            const userCache = articleNode._userCache || new Map();
                            articleNode._userCache = userCache;

                            // Hoisted helpers are available: getUserIdFromComment, normName, normAvatar, normEmail, formatRelativeTime
                            // Prefetch unique users
                            try{
                              const uniqueIds = Array.from(new Set((arr||[]).map(getUserIdFromComment).filter(Boolean)));
                              await Promise.all(uniqueIds.map(async function(id){
                                if(!id) return null;
                                if(userCache.has(id)){
                                  const cached = userCache.get(id);
                                  return (cached && typeof cached.then==='function') ? await cached : cached;
                                }
                                const pending = (async () => {
                                  try{
                                    const r = await fetch('/api/users/' + encodeURIComponent(id), { credentials:'include' });
                                    if(!r.ok) return null;
                                    const u = await r.json();
                                    return u || null;
                                  }catch(e){ return null; }
                                })();
                                userCache.set(id, pending);
                                const resolved = await pending; userCache.set(id, resolved);
                                return resolved;
                              }));
                            }catch(_){ }

                            // current user id
                            let me = {};
                            try{ me = JSON.parse(localStorage.getItem('auth')||'{}'); }catch(_){ me = {}; }
                            const meId = me.user_id || me.id || me.userId || null;

                            // Render comments (oldest -> newest)
                            cmList.innerHTML = '';
                            if(!arr || arr.length===0){
                              cmList.innerHTML = '<div class="text-muted small text-center py-2">Ch∆∞a c√≥ b√¨nh lu·∫≠n.</div>';
                            } else {
                              const ts = c => new Date(c.created_at || c.createdAt || c.created || 0).getTime();
                              arr = arr.slice().sort((a,b)=> ts(a) - ts(b));
                              arr.forEach(function(c){
                                try{
                                  const uid = getUserIdFromComment(c);
                                  const fallbackUser = c.user || c.author || {};
                                  const u = (uid && userCache.get(uid)) || fallbackUser;
                                  const name = normName(u);
                                  const avatar = normAvatar(u);
                                  const email = normEmail(u);
                                  const content = c.content || c.text || '';
                                  const created = c.created_at || c.createdAt || c.created || null;

                                  const item = document.createElement('div');
                                  try{ if(c && (c.id||c.comment_id||c.commentId)) item.id = 'comment-' + (c.id || c.comment_id || c.commentId); }catch(_){ }
                                  item.className = 'list-group-item border-0 bg-transparent p-0';
                                  item.style.marginBottom = '6px';

                                  const row = document.createElement('div'); row.className='d-flex align-items-start gap-2 py-2';
                                  const img = document.createElement('img');
                                  img.src=avatar; img.alt=''; img.className='rounded-circle';
                                  img.style.width='40px'; img.style.height='40px'; img.style.objectFit='cover';
                                  if(email) img.title = email;

                                  const bubble = document.createElement('div');
                                  bubble.className='flex-fill';
                                  bubble.style.background='#f7f9fc';
                                  bubble.style.border='1px solid rgba(120,150,190,.30)';
                                  bubble.style.borderRadius='12px';
                                  bubble.style.padding='.5rem .75rem';
                                  bubble.style.minWidth='0';

                                  const header = document.createElement('div'); header.className='d-flex align-items-center justify-content-between gap-2 flex-wrap';
                                  const left = document.createElement('div'); left.className='d-flex align-items-center gap-2 flex-wrap';
                                  const nameSpan = document.createElement('span'); nameSpan.textContent = name; nameSpan.style.fontWeight='600'; nameSpan.style.color='#2a3542'; left.appendChild(nameSpan);
                                  if(email){
                                    const emailWrap = document.createElement('span');
                                    emailWrap.className = 'text-muted small d-inline-flex align-items-center gap-1';
                                    emailWrap.style.whiteSpace='nowrap';
                                    const emailSpan = document.createElement('span'); emailSpan.textContent = email; emailSpan.style.maxWidth='220px'; emailSpan.style.overflow='hidden'; emailSpan.style.textOverflow='ellipsis';
                                    const copyBtn = document.createElement('button');
                                    copyBtn.type='button'; copyBtn.className='btn btn-sm btn-outline-secondary py-0 px-2'; copyBtn.title='Sao ch√©p email'; copyBtn.innerHTML = "<i class='bi bi-clipboard'></i>";
                                    copyBtn.addEventListener('click', async function(ev){ ev.stopPropagation(); try{ if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(email); } }catch(_){ } });
                                    emailWrap.appendChild(emailSpan); emailWrap.appendChild(copyBtn);
                                    left.appendChild(emailWrap);
                                  }
                                  const timeEl = document.createElement('small'); timeEl.className='text-muted';
                                  const usedTime = (c.updatedAt || c.updated_at || c.updated) ? (c.updatedAt || c.updated_at || c.updated) : created;
                                  timeEl.textContent = (typeof formatRelativeTime==='function'? formatRelativeTime(usedTime): (usedTime? new Date(usedTime).toLocaleString():'')) + ((c.updatedAt || c.updated_at || c.updated)? ' ‚Ä¢ ƒê√£ ch·ªânh s·ª≠a' : '');
                                  header.appendChild(left);
                                  header.appendChild(timeEl);

                                  const contentDiv = document.createElement('div'); contentDiv.style.whiteSpace='pre-wrap'; contentDiv.style.marginTop='6px'; contentDiv.textContent = content;

                                  // Actions (owner: edit/delete; others: report)
                                  const actionsWrap = document.createElement('div');
                                  actionsWrap.style.marginTop='6px'; actionsWrap.style.display='flex'; actionsWrap.style.gap='8px'; actionsWrap.style.alignItems='center';
                                  const isOwner = ((meId != null) && (String(meId) === String(uid))) || c.mine === true || c.ownedByRequester === true;
                                  const postIdLocal = postId;
                                  if(isOwner){
                                    const editBtn = document.createElement('button'); editBtn.type='button'; editBtn.className='btn btn-sm btn-link'; editBtn.textContent='S·ª≠a';
                                    const delBtn = document.createElement('button'); delBtn.type='button'; delBtn.className='btn btn-sm btn-link text-danger'; delBtn.textContent='Xo√°';

                                    editBtn.addEventListener('click', function(ev){
                                      ev.stopPropagation(); if(bubble._editing) return; bubble._editing = true;
                                      const ta = document.createElement('textarea'); ta.className='form-control'; ta.style.minHeight='60px'; ta.value = content;
                                      bubble.replaceChild(ta, contentDiv);
                                      const save = document.createElement('button'); save.type='button'; save.className='btn btn-sm btn-primary'; save.textContent='L∆∞u';
                                      const cancel = document.createElement('button'); cancel.type='button'; cancel.className='btn btn-sm btn-link'; cancel.textContent='Hu·ª∑';
                                      const actionBar = document.createElement('div'); actionBar.style.marginTop='6px'; actionBar.style.display='flex'; actionBar.style.gap='8px';
                                      actionBar.appendChild(save); actionBar.appendChild(cancel); bubble.appendChild(actionBar);
                                      save.addEventListener('click', async function(){
                                        try{
                                          const newText = ta.value || '';
                                          const rr = await fetch('/api/posts/'+encodeURIComponent(postIdLocal)+'/comments/'+encodeURIComponent(c.id),{
                                            method:'PUT', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ content: newText })
                                          });
                                          if(rr.ok){ try{ if(articleNode._loadComments) await articleNode._loadComments(); }catch(_){ } }
                                          else { const jj = await rr.json().catch(()=>({})); alert('C·∫≠p nh·∫≠t b√¨nh lu·∫≠n th·∫•t b·∫°i: ' + (jj.message || rr.statusText)); try{ bubble.removeChild(actionBar); bubble.replaceChild(contentDiv, ta); bubble._editing=false; }catch(_){ } }
                                        }catch(e){ console.error(e); alert('L·ªói m·∫°ng'); }
                                      });
                                      cancel.addEventListener('click', function(){ try{ bubble.removeChild(actionBar); bubble.replaceChild(contentDiv, ta); bubble._editing=false; }catch(_){ } });
                                    });

                                    delBtn.addEventListener('click', async function(ev){
                                      ev.stopPropagation(); if(!confirm('X√°c nh·∫≠n xo√° b√¨nh lu·∫≠n n√†y?')) return;
                                      try{
                                        const rr = await fetch('/api/posts/'+encodeURIComponent(postIdLocal)+'/comments/'+encodeURIComponent(c.id),{ method:'DELETE', credentials:'include' });
                                        if(rr.status === 204){ try{ item.remove(); }catch(_){ item.style.display='none'; } try{ if(articleNode._loadComments) articleNode._loadComments(); }catch(_){ }
                                        } else { const jj = await rr.json().catch(()=>({})); alert('Xo√° th·∫•t b·∫°i: ' + (jj.message || rr.statusText)); }
                                      }catch(e){ console.error(e); alert('L·ªói m·∫°ng'); }
                                    });

                                    actionsWrap.appendChild(editBtn); actionsWrap.appendChild(delBtn);
                                  } else {
                                    try{
                                      const reportBtn = document.createElement('button'); reportBtn.type='button'; reportBtn.className='btn btn-sm btn-link text-danger'; reportBtn.textContent='B√°o c√°o';
                                      reportBtn.addEventListener('click', function(ev){
                                        ev.stopPropagation();
                                        try{
                                          const rmodal = document.getElementById('qdt_report_modal');
                                          if(rmodal){ rmodal.dataset.targetType='comment'; rmodal.dataset.targetId=String(c.id); const ta = rmodal.querySelector('textarea.report-reason'); if(ta) ta.value=''; bootstrap.Modal.getOrCreateInstance(rmodal).show(); }
                                          else {
                                            const reason = prompt('L√Ω do b√°o c√°o (t√πy ch·ªçn):');
                                            // optional: if submitCommentReport is available
                                            if(typeof submitCommentReport === 'function') submitCommentReport(c.id, reason||'');
                                          }
                                        }catch(e){ console.error(e); }
                                      });
                                      actionsWrap.appendChild(reportBtn);
                                    }catch(e){ }
                                  }

                                  bubble.appendChild(header);
                                  bubble.appendChild(contentDiv);
                                  bubble.appendChild(actionsWrap);
                                  row.appendChild(img); row.appendChild(bubble);
                                  item.appendChild(row);
                                  cmList.appendChild(item);
                                }catch(e){ /* continue */ }
                              });
                            }

                            // update comment-count on related cards
                            try{
                              const count = (data && (Number.isFinite(data.totalElements)? data.totalElements : (Number.isFinite(data.total)? data.total : (Number.isFinite(data.count)? data.count : null)))) ?? (arr?arr.length:0);
                              const selComments = 'article.post-card[data-post-id="'+String(postId)+'"] .comment-count, article.post-card.share-item[data-original-post-id="'+String(postId)+'"] .comment-count, article.post-card[data-original-post-id="'+String(postId)+'"] .comment-count';
                              document.querySelectorAll(selComments).forEach(function(el){ el.textContent = Number(count||0); });
                            }catch(_){ }
                          }catch(e){ cmList.innerHTML = '<div class="text-muted small text-center py-2">T·∫£i b√¨nh lu·∫≠n th·∫•t b·∫°i.</div>'; }
                        }

                        articleNode._loadComments = loadCommentsForArticle;
                        cmModal.addEventListener('shown.bs.modal', function(){ loadCommentsForArticle(); });
                      }catch(e){ console.error('initCommentsForArticle failed', e); }
                    };
                  }

                  // cache user details per-article to avoid refetching
                  var userCache = article._userCache || new Map();
                  article._userCache = userCache;

                  function normName(u){
                    return (u && (u.full_name || u.fullName || u.name || u.username)) || '·∫®n danh';
                  } 
                  function normAvatar(u){
                    return (u && (u.avatar_url || u.avatarUrl || u.profilePictureUrl || u.profile_picture_url || u.profilePicture || u.avatar)) || '/img/image1.png';
                  }
                  function normEmail(u){
                    return (u && (u.email || u.emailAddress || u.mail || u.contactEmail || u.user_email)) || '';
                  }

                  function getUserIdFromComment(c){
                    return (
                      c.authorId || c.userId || c.user_id || c.ownerId || c.commenterId || c.createdBy ||
                      (c.user && (c.user.id || c.user.user_id)) ||
                      (c.author && (c.author.id || c.author.user_id)) ||
                      null
                    );
                  }

                  async function fetchUserOnce(id){
                    if(!id) return null;
                    if(userCache.has(id)){
                    const cached = userCache.get(id);
                    return cached && typeof cached.then === 'function' ? await cached : cached;
                    }
                    const pending = (async () => {
                    try{
                      // Use same-origin relative API; JSESSIONID is sent via credentials: 'include'
                      const res = await fetch('/api/users/' + encodeURIComponent(id), { credentials:'include' });
                      if(!res.ok) return null;
                      const u = await res.json();
                      return u || null;
                    }catch(e){ return null; }
                    })();
                    userCache.set(id, pending);
                    const resolved = await pending;
                    userCache.set(id, resolved);
                    return resolved;
                  }

                  async function copyToClipboard(text){
                    try{
                    if(navigator.clipboard && window.isSecureContext){
                      await navigator.clipboard.writeText(text);
                    }else{
                      const ta=document.createElement('textarea');
                      ta.value=text;
                      ta.style.position='fixed';
                      ta.style.top='-9999px';
                      document.body.appendChild(ta);
                      ta.focus(); ta.select();
                      document.execCommand('copy');
                      ta.remove();
                    }
                    return true;
                    }catch(e){ return false; }
                  }

                  function formatRelativeTime(ts){
                    if(!ts) return '';
                    var d=new Date(ts);
                    if(isNaN(d)) return '';
                    var diff=(Date.now()-d.getTime())/1000;
                    if(diff<60) return 'V·ª´a xong';
                    if(diff<3600) return Math.floor(diff/60)+' ph√∫t';
                    if(diff<86400) return Math.floor(diff/3600)+' gi·ªù';
                    if(diff<172800) return 'H√¥m qua';
                    return d.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'});
                  }

                    async function renderComments(arr){
                    listEl.innerHTML = '';
                    if(!arr || arr.length===0){
                      listEl.innerHTML = '<div class="text-muted small text-center py-2">Ch∆∞a c√≥ b√¨nh lu·∫≠n.</div>';
                      return;
                    }

                    // Prefetch unique user details using /api/users/{id}
                    const uniqueIds = Array.from(new Set(arr.map(getUserIdFromComment).filter(Boolean)));
                    if(uniqueIds.length){
                      await Promise.all(uniqueIds.map(id => fetchUserOnce(id)));
                    }

                    // Sort comments by time (oldest -> newest) for natural reading flow
                    const ts = c => new Date(c.created_at || c.createdAt || c.created || 0).getTime();
                    arr = arr.slice().sort((a,b)=> ts(a) - ts(b));

                    // current logged-in user id (from localStorage auth). fallback keys checked for common shapes
                    var _authRaw = {};
                    try{ _authRaw = JSON.parse(localStorage.getItem('auth')||'{}'); }catch(e){ _authRaw = {}; }
                    var _meId = _authRaw.user_id || _authRaw.id || _authRaw.userId || null;

                    arr.forEach(function(c){
              const fallbackUser = c.user || c.author || {};
                      const uid = getUserIdFromComment(c);
                      const u = (uid && userCache.get(uid)) || fallbackUser;

                      const name = normName(u);
                      const avatar = normAvatar(u);
                      const email = normEmail(u);
                      const content = c.content || c.text || '';
                      const created = c.created_at || c.createdAt || c.created || null;

                      // Item wrapper (no default list-group borders/paddings)
                      const item = document.createElement('div');
                      // set an id so deep-links can target this comment: #comment-<id>
                      try{ if(c && (c.id||c.comment_id||c.commentId)) item.id = 'comment-' + (c.id || c.comment_id || c.commentId); }catch(e){}
                      item.className = 'list-group-item border-0 bg-transparent p-0';
                      item.style.marginBottom = '6px';

                      // Row layout
                      const row = document.createElement('div');
                      row.className = 'd-flex align-items-start gap-2 py-2';

                      // Avatar
                      const img = document.createElement('img');
                      img.src = avatar; img.alt=''; img.className='rounded-circle';
                      img.style.width='40px'; img.style.height='40px'; img.style.objectFit='cover';
                      img.style.boxShadow='0 2px 6px rgba(0,0,0,.15)';
                      if(email) img.title = email;

                      // Bubble
                      const bubble = document.createElement('div');
                      bubble.className = 'flex-fill';
                      bubble.style.background = '#f7f9fc';
                      bubble.style.border = '1px solid rgba(120,150,190,.30)';
                      bubble.style.borderRadius = '12px';
                      bubble.style.padding = '.5rem .75rem';
                      bubble.style.minWidth = '0';

                      // Header (name + email on left, time on right)
                      const header = document.createElement('div');
                      header.className = 'd-flex align-items-center justify-content-between gap-2 flex-wrap';

                      const left = document.createElement('div');
                      left.className = 'd-flex align-items-center gap-2 flex-wrap';

                      const nameSpan = document.createElement('span');
                      nameSpan.textContent = name;
                      nameSpan.style.fontWeight = '600';
                      nameSpan.style.color = '#2a3542';
                      left.appendChild(nameSpan);

                      if(email){
                      const emailWrap = document.createElement('span');
                      emailWrap.className = 'text-muted small d-inline-flex align-items-center gap-1';
                      emailWrap.style.whiteSpace = 'nowrap';

                      const emailSpan = document.createElement('span');
                      emailSpan.textContent = email;
                      emailSpan.style.maxWidth = '220px';
                      emailSpan.style.overflow = 'hidden';
                      emailSpan.style.textOverflow = 'ellipsis';

                      const copyBtn = document.createElement('button');
                      copyBtn.type='button';
                      copyBtn.className='btn btn-sm btn-outline-secondary py-0 px-2';
                      copyBtn.title='Sao ch√©p email';
                      copyBtn.innerHTML = "<i class='bi bi-clipboard'></i>";
                      copyBtn.addEventListener('click', async function(ev){
                        ev.stopPropagation();
                        const ok = await copyToClipboard(email);
                        const prev = copyBtn.innerHTML;
                        copyBtn.innerHTML = ok ? "<i class='bi bi-clipboard-check'></i>" : "<i class='bi bi-clipboard-x'></i>";
                        copyBtn.disabled = true;
                        setTimeout(function(){
                        copyBtn.innerHTML = prev;
                        copyBtn.disabled = false;
                        }, 1200);
                      });

                      emailWrap.appendChild(emailSpan);
                      emailWrap.appendChild(copyBtn);
                      left.appendChild(emailWrap);
                      }

                      const timeEl = document.createElement('small');
                      timeEl.className = 'text-muted';
                      // Prefer updated timestamp when available
                      const usedTime = (c.updatedAt || c.updated_at || c.updated) ? (c.updatedAt || c.updated_at || c.updated) : created;
                      timeEl.textContent = formatRelativeTime(usedTime) + ((c.updatedAt || c.updated_at || c.updated) ? ' ‚Ä¢ ƒê√£ ch·ªânh s·ª≠a' : '');

                      header.appendChild(left);
                      header.appendChild(timeEl);

                      // Content
                      const contentRow = document.createElement('div');
                      contentRow.textContent = content;
                      contentRow.style.whiteSpace = 'pre-wrap';
                      contentRow.style.marginTop = '4px';
                      contentRow.style.lineHeight = '1.45';
                      contentRow.style.color = '#2a3542';

                      // Actions area (Edit / Delete) - only show when current user is the comment author
                      try{
                        var actionsWrap = document.createElement('div');
                        actionsWrap.style.marginTop = '6px';
                        actionsWrap.style.display = 'flex';
                        actionsWrap.style.gap = '8px';
                        actionsWrap.style.alignItems = 'center';

                        var postId = article.dataset.postId;
                        var isOwner = ((_meId != null) && (String(_meId) === String(uid))) || c.mine === true || c.ownedByRequester === true;
                        if(isOwner){
                          var editBtn = document.createElement('button');
                          editBtn.type = 'button';
                          editBtn.className = 'btn btn-sm btn-link';
                          editBtn.textContent = 'S·ª≠a';

                          var delBtn = document.createElement('button');
                          delBtn.type = 'button';
                          delBtn.className = 'btn btn-sm btn-link text-danger';
                          delBtn.textContent = 'Xo√°';

                          // Edit handler: replace content with textarea, provide Save/Cancel
                          editBtn.addEventListener('click', function(ev){
                            ev.stopPropagation();
                            if(bubble._editing) return;
                            bubble._editing = true;
                            var ta = document.createElement('textarea');
                            ta.className = 'form-control';
                            ta.style.minHeight = '60px';
                            ta.value = content;
                            bubble.replaceChild(ta, contentRow);

                            var save = document.createElement('button'); save.type='button'; save.className='btn btn-sm btn-primary'; save.textContent='L∆∞u';
                            var cancel = document.createElement('button'); cancel.type='button'; cancel.className='btn btn-sm btn-link'; cancel.textContent='Hu·ª∑';
                            var actionBar = document.createElement('div'); actionBar.style.marginTop='6px'; actionBar.style.display='flex'; actionBar.style.gap='8px';
                            actionBar.appendChild(save); actionBar.appendChild(cancel);
                            bubble.appendChild(actionBar);

                            save.addEventListener('click', async function(){
                              try{
                                var newText = ta.value || '';
                                var rr = await fetch('/api/posts/'+encodeURIComponent(postId)+'/comments/'+encodeURIComponent(c.id),{
                                  method: 'PUT', credentials: 'include', headers: {'Content-Type':'application/json'},
                                  body: JSON.stringify({ content: newText })
                                });
                                if(rr.ok){
                                  // reload the list to reflect updated content/time
                                  try{ if(article._loadComments) await article._loadComments(); }catch(_){ }
                                } else {
                                  var jj = await rr.json().catch(()=>({}));
                                  alert('C·∫≠p nh·∫≠t b√¨nh lu·∫≠n th·∫•t b·∫°i: ' + (jj.message || rr.statusText));
                                  // restore UI
                                  try{ bubble.removeChild(actionBar); bubble.replaceChild(contentRow, ta); bubble._editing = false; }catch(_){ }
                                }
                              }catch(e){ console.error(e); alert('L·ªói m·∫°ng'); }
                            });

                            cancel.addEventListener('click', function(){
                              try{ bubble.removeChild(actionBar); bubble.replaceChild(contentRow, ta); bubble._editing = false; }
                              catch(e){}
                            });
                          });

                          // Delete handler: confirm then call DELETE
                          delBtn.addEventListener('click', async function(ev){
                            ev.stopPropagation();
                            if(!confirm('X√°c nh·∫≠n xo√° b√¨nh lu·∫≠n n√†y?')) return;
                            try{
                              var rr = await fetch('/api/posts/'+encodeURIComponent(postId)+'/comments/'+encodeURIComponent(c.id),{
                                method: 'DELETE', credentials: 'include'
                              });
                              if(rr.status === 204){
                                // remove item and update counts
                                try{ item.remove(); }catch(_){ item.style.display='none'; }
                                try{ if(article._loadComments) article._loadComments(); }catch(_){ }
                              }else{
                                var jj = await rr.json().catch(()=>({}));
                                alert('Xo√° th·∫•t b·∫°i: ' + (jj.message||rr.statusText));
                              }
                            }catch(e){ console.error(e); alert('L·ªói m·∫°ng'); }
                          });

                          actionsWrap.appendChild(editBtn);
                          actionsWrap.appendChild(delBtn);
                          bubble.appendChild(actionsWrap);
                        } else {
                          // Not the owner -> allow reporting the comment
                          try{
                            var reportBtn = document.createElement('button');
                            reportBtn.type = 'button';
                            reportBtn.className = 'btn btn-sm btn-link text-danger';
                            reportBtn.textContent = 'B√°o c√°o';
                            reportBtn.addEventListener('click', function(ev){
                              ev.stopPropagation();
                              // open bootstrap modal to collect reason
                              try{
                                var modal = document.getElementById('qdt_report_modal');
                                if(modal){
                                  modal.dataset.targetType = 'comment';
                                  modal.dataset.targetId = String(c.id);
                                  modal.querySelector('textarea.report-reason').value = '';
                                  var bs = bootstrap.Modal.getOrCreateInstance(modal);
                                  bs.show();
                                } else {
                                  // fallback to prompt
                                  var reason = prompt('L√Ω do b√°o c√°o (t√πy ch·ªçn):');
                                  submitCommentReport(c.id, reason || '');
                                }
                              }catch(e){ console.error(e); }
                            });
                            actionsWrap.appendChild(reportBtn);
                            bubble.appendChild(actionsWrap);
                          }catch(e){ console.error('report btn error', e); }
                        }
                      }catch(e){ console.error(e); }

                      // Mount
                      bubble.appendChild(header);
                      bubble.appendChild(contentRow);
                      row.appendChild(img);
                      row.appendChild(bubble);
                      item.appendChild(row);
                      listEl.appendChild(item);
                    });
                    }

                  async function loadComments(){
                    var postId = article.dataset.postId;
                    if(!postId) return;
                    try{ console.debug('[comments:modal-iife] fetch for', { postId, articleId: article.id, isShare: article.classList.contains('share-item') }); }catch(_){ }
                    try{
                      listEl.innerHTML = '<div class="text-center text-muted small py-2">ƒêang t·∫£i b√¨nh lu·∫≠n...</div>';
                      var res = await fetch('/api/posts/'+encodeURIComponent(postId)+'/comments', { credentials:'include' });
                      var data = res.ok ? await res.json() : [];
                      var arr = [];
                      if(Array.isArray(data)) arr = data;
                      else if(data && Array.isArray(data.content)) arr = data.content;
                      else if(data && Array.isArray(data.items)) arr = data.items;
                      else if(data && Array.isArray(data.data)) arr = data.data;

                      await renderComments(arr);
                      try{ console.debug('[comments:modal-iife] rendered', { count: Array.isArray(arr)?arr.length:0 }); }catch(_){ }

                      var count = (data && (Number.isFinite(data.totalElements)? data.totalElements : (Number.isFinite(data.total)? data.total : (Number.isFinite(data.count)? data.count : null))))
                                 ?? arr.length;
                      // update comment-count on all related cards (original + shares)
                      try{
                        const selComments = 'article.post-card[data-post-id="'+String(postId)+'"] .comment-count, article.post-card.share-item[data-original-post-id="'+String(postId)+'"] .comment-count, article.post-card[data-original-post-id="'+String(postId)+'"] .comment-count';
                        document.querySelectorAll(selComments).forEach(function(el){ el.textContent = Number(count||0); });
                      }catch(_){ }
                    }catch(e){
                      listEl.innerHTML = '<div class="text-muted small text-center py-2">T·∫£i b√¨nh lu·∫≠n th·∫•t b·∫°i.</div>';
                    }
                  }

                  // expose to inline "G·ª≠i" handler
                  article._loadComments = loadComments;

                  // load when modal is shown
                  modal.addEventListener('shown.bs.modal', function(){ loadComments(); });

                  // optional: submit on Enter in input
                      // Bind Enter submit on the correct modal input(s) within this article (exclude nested previews)
                      var modalInputs = Array.from(article.querySelectorAll('.comments-modal .modal-comment-input')).filter(function(inp){ return inp.closest('article') === article; });
                      modalInputs.forEach(function(input){
                        input.addEventListener('keydown', function(e){
                          if(e.key === 'Enter'){
                            e.preventDefault();
                            var modalEl = input.closest('.modal');
                            var btnSend = modalEl ? modalEl.querySelector('.btn.btn-primary') : article.querySelector('.btn.btn-primary');
                            if(btnSend) btnSend.click();
                          }
                        });
                      });
                  }catch(e){}
                })();
                </script>
                <!-- Comments Modal:END -->

          </article>
      </template>

      <style>
      .post-feed{display:flex;flex-direction:column;gap:20px;}
      .post-card{
          position:relative;
          background:linear-gradient(150deg,#ffffff,#f4f7fa 55%,#ebf2fa);
          border:1px solid rgba(120,150,190,.35);
          border-radius:22px;
          padding:1rem 1rem .5rem;
          box-shadow:0 8px 26px -10px rgba(30,70,140,.25),0 3px 8px -4px rgba(30,70,140,.18),inset 0 1px 0 rgba(255,255,255,.9);
          overflow:hidden;
          /* animation:pcFade .45s cubic-bezier(.4,.65,.25,1); */
          /* height limit (increased to reduce inner scrollbar when showing media) */
          --pc-max-h:1100px;
          display:flex;
          flex-direction:column;
          max-height:var(--pc-max-h);
      }
      /* Scrollable body (header + actions + footer stay visible) */
      .post-card .pc-body{
          flex:1 1 auto;
          /* allow the body itself to scroll while keeping header/actions fixed */
          overflow:auto;
          scrollbar-width:thin;
          scrollbar-color:#b8c6d6 transparent;
          padding-right:.35rem;
      }

    /* KEEP MEDIA RATIO (no cropping / stretching) */
    .post-card .pc-body .post-media figure{
          position:relative;
          margin:0;
      }
    .post-card .pc-body .post-media img,
    .post-card .pc-body .post-media video{
      width:100%;
      height:100%;
      object-fit:contain;   /* show whole media without cropping */
      display:block;
      background:#000;      /* letterbox background for videos / wide images */
      border-radius:14px;
    }

      /* If a grid cell had a forced height from previous rules, let media inside adapt */
    .post-card .pc-body .post-media figure > *{
      max-height:100%;
    }

    /* Override grid cells to have sensible heights so media fits without scrolling */
  .post-card .pc-body .post-media.pm-grid > figure{ height: 480px; }
  .post-card .pc-body .post-media.pm-grid.img-1 > figure{ height: 720px; }
  .post-card .pc-body .post-media.pm-grid.img-2 > figure{ height: 520px; }
  .post-card .pc-body .post-media.pm-grid.img-3 > figure{ height: 400px; }
  .post-card .pc-body .post-media.pm-grid.img-4 > figure{ height: 360px; }
  /* Important posts: keep same heights (explicit to override any later theme overrides) */
  .post-card.post-important .pc-body .post-media.pm-grid > figure{ height: 480px; }
  .post-card.post-important .pc-body .post-media.pm-grid.img-1 > figure{ height: 720px; }
  .post-card.post-important .pc-body .post-media.pm-grid.img-2 > figure{ height: 520px; }
  .post-card.post-important .pc-body .post-media.pm-grid.img-3 > figure{ height: 400px; }
  .post-card.post-important .pc-body .post-media.pm-grid.img-4 > figure{ height: 360px; }
      .post-card .pc-body::-webkit-scrollbar{width:8px;}
      .post-card .pc-body::-webkit-scrollbar-track{background:transparent;}
      .post-card .pc-body::-webkit-scrollbar-thumb{
          background:linear-gradient(#9fb6cc,#6d8fb2);
          border-radius:20px;
      }
      .post-card .pc-body:after{
          content:"";
          position:sticky;
          bottom:0;left:0;right:0;
          height:28px;
          pointer-events:none;
          background:linear-gradient(to bottom,rgba(255,255,255,0),#fff 70%);
          display:block;
          margin-top:-28px;
      }
      @media (prefers-color-scheme:dark){
          .post-card .pc-body:after{
              background:linear-gradient(to bottom,rgba(34,42,52,0),#1b222c 70%);
          }
      }
      /* @keyframes pcFade{0%{transform:translateY(10px);opacity:0}100%{transform:translateY(0);opacity:1}} */
      .post-card:before{
          content:"";
          position:absolute;inset:0;
          background:
            radial-gradient(circle at 85% 15%,rgba(27,116,228,.12),transparent 60%),
            radial-gradient(circle at 12% 85%,rgba(90,162,255,.12),transparent 65%);
          pointer-events:none;
          mix-blend-mode:overlay;
      }
      /* .post-card:hover{transform:translateY(-3px);box-shadow:0 14px 40px -12px rgba(30,70,140,.35),0 6px 16px -6px rgba(30,70,140,.25),inset 0 1px 0 rgba(255,255,255,.9);} */
      .pc-head{display:flex;align-items:center;margin-bottom:.65rem;flex:0 0 auto;}
      .pc-author{display:flex;align-items:center;gap:.75rem;}
      .pc-av-wrap{position:relative;width:52px;height:52px;border-radius:18px;padding:2px;background:linear-gradient(135deg,#1b74e4,#6aa8ff);}
      .pc-avatar{width:100%;height:100%;border-radius:16px;object-fit:cover;display:block;box-shadow:0 4px 10px -4px rgba(0,0,0,.35);}
      .pc-author-text{line-height:1.15;}
      .pc-name{font-weight:600;font-size:.95rem;}
      .pc-meta{font-size:.65rem;letter-spacing:.5px;display:flex;align-items:center;text-transform:uppercase;font-weight:600;opacity:.65;}
      .pc-dot{width:4px;height:4px;border-radius:50%;background:currentColor;margin:0 6px;}
      .pc-menu{
          margin-left:auto;
          background:linear-gradient(135deg,#f2f7ff,#e5eefb);
          border:1px solid rgba(120,150,190,.35);
          width:38px;height:38px;border-radius:14px;
          display:flex;align-items:center;justify-content:center;
          color:#365372;box-shadow:0 3px 8px -4px rgba(30,70,140,.25),inset 0 1px 0 rgba(255,255,255,.9);
          transition:.35s;
      }
      /* .pc-menu:hover{transform:translateY(-3px);color:#1b74e4;border-color:rgba(27,116,228,.55);} */
      .pc-body{font-size:.95rem;color:#2a3542;padding:0 .15rem;}
      .post-content{white-space:pre-wrap;margin-bottom:.75rem;line-height:1.45;font-weight:500;}
      .post-media{border-radius:18px;overflow:hidden;display:grid;gap:6px;margin-bottom:.6rem;}
      .pm-grid{--c:1;}
      .pm-grid.img-2{--c:2;}
      .pm-grid.img-3{--c:2;}
      .pm-grid.img-4{--c:2;}
      .pm-grid>figure,.pm-grid img,.pm-grid video{width:100%;height:100%;object-fit:cover;display:block;}
      .pm-grid{grid-template-columns:repeat(var(--c),1fr);}
      .pm-grid img,.pm-grid video{border-radius:14px;box-shadow:0 4px 12px -4px rgba(0,0,0,.25);}
  .pm-grid.img-3> :first-child{grid-column:span 2;}
  .pm-grid.img-4> :nth-child(1){grid-row:span 2;}
      .pc-actions{
          display:flex;gap:8px;
          padding:.55rem .35rem .35rem;
          border-top:1px solid rgba(120,150,190,.25);
          margin:0 -.15rem;
          flex:0 0 auto;
      }
      .act-btn{
          flex:1;
          position:relative;
          border:1px solid rgba(120,150,190,.35);
          background:linear-gradient(135deg,#f2f7ff,#e5eefb);
          color:#2a3542;
          font-weight:600;font-size:.7rem;letter-spacing:.6px;
          padding:.55rem .55rem;
          text-transform:uppercase;
          border-radius:14px;
          display:flex;align-items:center;justify-content:center;
          gap:6px;
          box-shadow:0 2px 6px -3px rgba(30,70,140,.35),inset 0 1px 0 rgba(255,255,255,.9);
          transition:.45s cubic-bezier(.6,.2,.2,1);
          overflow:hidden;
      }
      .act-btn .ico{display:flex;}
      .act-btn .count{
          background:#1b74e4;
          color:#fff;
          padding:0 6px;
          border-radius:10px;
          font-size:.6rem;
          font-weight:600;
          letter-spacing:0;
      }
      /* .act-btn:hover{transform:translateY(-3px);border-color:rgba(27,116,228,.55);color:#1b74e4;} */
      /* .act-btn:active{transform:translateY(-1px) scale(.95);} */
      .act-btn[data-active="1"]{
          background:linear-gradient(135deg,#1b74e4,#559dff);
          color:#fff;
          border-color:#1b74e4;
      }
      .act-btn[data-active="1"] .count{background:rgba(255,255,255,.25);}
      .pc-footer{padding:.55rem 0 0;flex:0 0 auto;}
      .comment-box{position:relative;}
      .cm-input{
          background:#f0f4f9;
          border:1px solid rgba(120,150,190,.35);
          border-radius:18px;
          padding:.55rem .9rem;
          font-size:.75rem;
      }
      .cm-input:focus{background:#e8eef5;box-shadow:none;border-color:#1b74e4;}
      /* Skeleton */
      .post-skeleton{
          height:180px;
          border-radius:22px;
          background:
            linear-gradient(100deg,rgba(220,230,240,.6) 8%,rgba(255,255,255,.9) 18%,rgba(220,230,240,.6) 28%) #e2e8ef;
          background-size:200% 100%;
          /* animation:shimmer 1.4s linear infinite; */
          border:1px solid rgba(120,150,190,.25);
      }
      /* @keyframes shimmer{to{background-position:-200% 0}} */
      /* @media (prefers-color-scheme:dark){
          .post-card{background:linear-gradient(150deg,#222a34,#1b222c 60%,#161d25);border-color:rgba(140,170,210,.25);color:#d9e2ec;}
          .post-card:before{background:
              radial-gradient(circle at 85% 15%,rgba(90,162,255,.18),transparent 60%),
              radial-gradient(circle at 12% 85%,rgba(27,116,228,.18),transparent 65%);
          }
          .pc-meta{opacity:.75;}
          .pc-menu, .act-btn{background:linear-gradient(135deg,#2b3440,#242c36);color:#d3dbe6;border-color:rgba(140,170,210,.28);}
          .act-btn:hover{color:#7eb6ff;}
          .cm-input{background:#2a313b;color:#d9e2ec;border-color:rgba(140,170,210,.28);}
          .cm-input:focus{background:#323a45;border-color:#4c95ff;}
          .post-skeleton{
              background:
                linear-gradient(100deg,rgba(60,70,82,.55) 8%,rgba(90,100,112,.6) 18%,rgba(60,70,82,.55) 28%) #2a313b;
          }
      } */
    /* Share preview adjustments: make the preview card taller and media larger */
    .post-card.share-item .card.mt-2{
      min-height:140px;
      padding:12px;
    }
    .post-card.share-item .card.mt-2 .small.text-muted{
      max-height:220px;
      overflow:auto;
    }
    .post-card.share-item .card.mt-2 img,
    .post-card.share-item .card.mt-2 video{
      width:100%;
      max-height:360px;
      object-fit:cover;
      display:block;
      border-radius:8px;
    }
    .post-card.share-item .card.mt-2 .d-flex img{
      width:40px; height:40px; object-fit:cover; border-radius:50%;
    }
      </style>
      <!-- Report modal (shared) -->
      <div class="modal fade" id="qdt_report_modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">B√°o c√°o n·ªôi dung</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">L√Ω do b√°o c√°o (t√πy ch·ªçn):</div>
              <textarea class="form-control report-reason" rows="4" placeholder="Nh·∫≠p l√Ω do..."></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hu·ª∑</button>
              <button type="button" class="btn btn-danger" id="qdt_report_submit_btn">G·ª≠i b√°o c√°o</button>
            </div>
          </div>
        </div>
      </div>

      <script>
      // Toast helper (Bootstrap toast)
      (function(){
        // small html-escape utility local to this fragment
        function _escapeHtml(s){
          if(s == null) return '';
          return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }
        // Append toast container if missing
        if(!document.getElementById('qdt_toast_container')){
          var div = document.createElement('div');
          div.id = 'qdt_toast_container';
          div.style.position = 'fixed';
          div.style.right = '20px';
          div.style.bottom = '20px';
          div.style.zIndex = '10800';
          document.body.appendChild(div);
        }
        window.showToast = function(message, type){
          type = type || 'info';
          var toastId = 'qdt_toast_'+Date.now();
          var wrapper = document.getElementById('qdt_toast_container');
          var html = `<div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">`+
                     `<div class="d-flex"><div class="toast-body">${_escapeHtml(message)}</div>`+
                     `<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`;
          var tmp = document.createElement('div'); tmp.innerHTML = html;
          wrapper.appendChild(tmp.firstChild);
          var tEl = document.getElementById(toastId);
          var bs = new bootstrap.Toast(tEl); bs.show();
          // remove after hidden
          tEl.addEventListener('hidden.bs.toast', function(){ try{ tEl.remove(); }catch(_){} });
        };
      })();

      // submit handler used by report modal
      (function(){
        const submitBtn = document.getElementById('qdt_report_submit_btn');
        if(!submitBtn) return;
        submitBtn.addEventListener('click', async function(){
          try{
            var modal = document.getElementById('qdt_report_modal');
            if(!modal) return;
            var reason = (modal.querySelector('textarea.report-reason').value || '').trim();
            if(!reason){
              try{ showToast('Vui l√≤ng nh·∫≠p l√Ω do b√°o c√°o.', 'danger'); }catch(e){ alert('Vui long nhap ly do bao cao.'); }
              return;
            }
            var t = modal.dataset.targetType || '';
            var id = modal.dataset.targetId || '';
            var url = '';
            if(t === 'comment') url = '/api/reports/comments/'+encodeURIComponent(id);
            else if(t === 'post') url = '/api/reports/posts/'+encodeURIComponent(id);
            else if(t === 'product') url = '/api/reports/market/'+encodeURIComponent(id);
            if(!url) { showToast('Kh√¥ng x√°c ƒë·ªãnh lo·∫°i b√°o c√°o', 'danger'); return; }
            var bs = bootstrap.Modal.getInstance(modal);
            // send
            var r = await fetch(url, { method:'POST', credentials:'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ reason: reason }) });
            if(r.ok || r.status === 201){
              try{ bs.hide(); }catch(_){}
              showToast('C·∫£m ∆°n, b√°o c√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i.', 'success');
            } else {
              var j = await r.json().catch(()=>({}));
              showToast('B√°o c√°o th·∫•t b·∫°i: ' + (j.message || r.statusText), 'danger');
            }
          }catch(e){ console.error(e); showToast('L·ªói khi g·ª≠i b√°o c√°o: ' + (e && e.message ? e.message : String(e)), 'danger'); }
        });
      })();
      // fallback function used earlier
      async function submitCommentReport(id, reason){
        reason = (reason || '').trim();
        if(!reason){ try{ showToast('Vui l√≤ng nh·∫≠p l√Ω do b√°o c√°o.', 'danger'); }catch(e){ /* ignore */ } return null; }
        try{
          var r = await fetch('/api/reports/comments/'+encodeURIComponent(id), { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reason: reason }) });
          return r;
        }catch(e){ console.error(e); throw e; }
      }
      </script>

      <script>
      (function(){
          const listEl = document.getElementById('postList');
          const tpl = document.getElementById('postCardTemplate');
          // set of postIds that have share items rendered as feed (to avoid duplicating inside post .post-shares)
          let postsWithFeedShare = new Set();

          function showSkeleton(count=3){
              listEl.innerHTML='';
              for(let i=0;i<count;i++){
                  const sk=document.createElement('div');
                  sk.className='post-skeleton';
                  listEl.appendChild(sk);
              }
          }

      // Helper: normalize various media shapes into {mediaType, mediaUrl}[]
      function normalizeMediaArray(raw){
        try{
          if(!raw) return [];
          // if raw is an object (single file), wrap it
          if(!Array.isArray(raw)) raw = [raw];
          return raw.map(m => {
            if(!m) return null;
            if(typeof m === 'string') return { mediaType: 'image', mediaUrl: m };
            const mediaType = (m.mediaType || m.type || m.media_type || (m.mime && String(m.mime).toLowerCase().startsWith('video') ? 'video' : '') ) || '';
            const mediaUrl = m.mediaUrl || m.media_url || m.url || m.path || m.fileUrl || m.file_url || m.src || m.source || m.location || m.image || m.video || null;
            if(!mediaUrl) return null;
            return { mediaType: String(mediaType||'').toLowerCase(), mediaUrl };
          }).filter(Boolean);
        }catch(e){ console.error('normalizeMediaArray error', e); return []; }
      }

      // Helper: extract media from a full post-like object (supports many shapes)
      function extractMediaFromPostLike(orig){
        if(!orig) return [];
        let raw = [];
        if(Array.isArray(orig.medias) && orig.medias.length) raw = orig.medias.slice();
        else if(Array.isArray(orig.media) && orig.media.length) raw = orig.media.slice();
        else if(Array.isArray(orig.mediaUrls) && orig.mediaUrls.length) raw = orig.mediaUrls.map(u=>({ mediaUrl: u }));
        else if(Array.isArray(orig.attachments) && orig.attachments.length) raw = orig.attachments.slice();
        else if(Array.isArray(orig.files) && orig.files.length) raw = orig.files.slice();
        else if(Array.isArray(orig.images) && orig.images.length) raw = orig.images.slice();
        else if(Array.isArray(orig.videos) && orig.videos.length) raw = orig.videos.slice();
        if(!raw.length && typeof orig === 'object'){
          if(orig.image) raw.push({ mediaUrl: orig.image });
          if(orig.video) raw.push({ mediaUrl: orig.video, mediaType: 'video' });
        }
        return normalizeMediaArray(raw);
      }

      // Render media area for a post-card node using normalized media array
      function renderMediaForNode(node, postObj){
        try{
          const mediaWrap = node.querySelector('.post-media');
          if(!mediaWrap) return;
          mediaWrap.innerHTML = '';
          const mediaArr = extractMediaFromPostLike(postObj);
          if(!Array.isArray(mediaArr) || mediaArr.length===0){ mediaWrap.style.display='none'; return; }
          mediaWrap.style.display='block';
          const total = mediaArr.length;
          const classMap = total<=4?('img-'+total):'img-4';
          mediaWrap.className = 'post-media pm-grid '+classMap;
          mediaArr.slice(0,4).forEach((m,idx)=>{
            let u = m.mediaUrl;
            const t = (m.mediaType||'image');
            if(u && !u.startsWith('http') && !u.startsWith('/') && !u.startsWith('data:')){ u = '/api/media/files/' + encodeURIComponent(u); }
            if(!u) return;
            let el;
            if(String(t).toLowerCase().includes('video') || String(u).toLowerCase().endsWith('.mp4') || String(u).toLowerCase().endsWith('.webm')){
              el=document.createElement('video'); el.style.width='100%'; el.style.height='100%'; el.style.objectFit='contain'; el.style.display='block'; el.style.background='#000'; el.src=u; el.controls=true; el.playsInline=true;
            } else {
              el=document.createElement('img'); el.src=u; el.loading='lazy'; el.alt='';
            }
            const fig=document.createElement('figure'); fig.style.margin='0'; fig.appendChild(el);
            if(idx===3 && total>4){ const overlay=document.createElement('div'); overlay.textContent='+'+(total-4); overlay.style.position='absolute'; overlay.style.inset='0'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.fontSize='2rem'; overlay.style.fontWeight='700'; overlay.style.color='#fff'; overlay.style.background='rgba(0,0,0,.45)'; overlay.style.backdropFilter='blur(2px)'; fig.style.position='relative'; fig.appendChild(overlay); }
            mediaWrap.appendChild(fig);
          });
        }catch(e){ console.error('renderMediaForNode error', e); }
      }

      // Populate a cloned post-card node with a post object. options.compact hides actions/modals for preview.
      function populatePostNode(node, p, options){
        try{
          options = options || {};
          const postId = p.post_id || p.id || '';
          const author = p.author || {};
          const name = author.fullName || author.full_name || author.name || '·∫®n danh';
          const avatar = author.avatarUrl || author.avatar || '/img/image1.png';
          const created = p.created_at || p.createdAt || p.created || null;
          const updated = p.updated_at || p.updatedAt || p.updated || null;
          const content = (p.content || p.caption || p.text || '').trim();

          node.dataset.postId = postId;
          node.id = 'post-'+postId;
          const nameEl = node.querySelector('.pc-name'); if(nameEl) nameEl.textContent = name;
          const avEl = node.querySelector('.pc-avatar'); if(avEl) avEl.src = avatar;
          const timeEl = node.querySelector('.post-time');
          if(timeEl){
            const showTs = updated || created;
            const edited = (updated && created && (new Date(updated).getTime() > new Date(created).getTime()));
            timeEl.textContent = (typeof formatRelativeTime==='function' ? formatRelativeTime(showTs) : (showTs ? new Date(showTs).toLocaleString() : '')) + (edited ? ' ‚Ä¢ ƒê√£ ch·ªânh s·ª≠a' : '');
            const iso = showTs ? new Date(showTs).toISOString() : '';
            if(iso) timeEl.setAttribute('datetime', iso);
          }
          const contentEl = node.querySelector('.post-content'); if(contentEl){ contentEl.textContent = content; if(!content) contentEl.style.display='none'; else contentEl.style.display='block'; }

          // mark if this post has feed-level share
          if(postsWithFeedShare && postsWithFeedShare.has(String(postId))){ node.dataset.hasFeedShare = '1'; }

          // render media using helper
          renderMediaForNode(node, p);

          // compact mode tweaks for preview inside a share
          if(options.compact){
            try{ const more = node.querySelector('.pc-more-modal'); if(more) more.remove(); }catch(_){}
            try{ const actions = node.querySelectorAll('.pc-actions'); actions.forEach(a=>a.style.display='none'); }catch(_){ }
            // remove the inner three-dots menu so users don't click the preview's menu (which has no proper data attributes)
            try{ const menuBtn = node.querySelector('.pc-menu'); if(menuBtn) menuBtn.remove(); }catch(_){ }
            // hide author header in preview when requested
            if(options.hideAuthor){ try{ const head = node.querySelector('.pc-head'); if(head) head.style.display='none'; }catch(_){ } }
            // hide inner post content when requested (useful when share text duplicates original post)
            if(options.hideContent){ try{ if(contentEl) contentEl.style.display='none'; }catch(_){ } }
            try{ node.classList.add('shared-preview'); node.style.margin='0'; node.style.border='0'; }catch(_){}
          }
        }catch(e){ console.error('populatePostNode error', e); }
      }

      async function loadPosts(){
        showSkeleton();
        try{
          // fetch posts
          const res = await fetch(fetchUrl, { credentials:'include' });
          if(!res.ok) throw new Error(res.status);
          const data = await res.json();
          const posts = Array.isArray(data) ? data : (Array.isArray(data.content) ? data.content : []);

          // build map for posts
          const postsById = {};
          posts.forEach(p=>{ const id = p.post_id || p.id; if(id!=null) postsById[String(id)] = p; });

          // fetch shares for each post in parallel (only for posts present in this page)
          const postIds = Object.keys(postsById);
          const shareFetches = postIds.map(id => fetch('/api/posts/'+encodeURIComponent(id)+'/shares', { credentials:'include' }).then(r=> r.ok ? r.json().catch(()=>[]) : []).catch(()=>[]));
          const shareResults = await Promise.allSettled(shareFetches);

          const shares = [];
          shareResults.forEach((sr, idx)=>{
          if(sr.status === 'fulfilled' && Array.isArray(sr.value)){
            const id = postIds[idx];
            sr.value.forEach(s=>{ s._postId = id; shares.push(s); });
          }
          });

          // Additionally, if this fragment is used on a user profile (fetchUrl like /api/posts/user/{id}),
          // fetch the shares created by that user so their shared posts appear on their profile.
          try{
            const m = fetchUrl.match(/\/api\/posts\/user\/(\d+)/);
            if(m){
              const userId = m[1];
              const r2 = await fetch('/api/users/' + encodeURIComponent(userId) + '/shares', { credentials:'include' });
              if(r2.ok){
                const userShares = await r2.json();
                if(Array.isArray(userShares)){
                  userShares.forEach(us => {
                    // The server already embeds originalPost in DTO as originalPost
                    if(us && us.originalPost){
                      // Normalize field names similar to postsById mapping
                      const op = us.originalPost;
                      const opId = op.id || op.post_id || null;
                      if(opId != null) postsById[String(opId)] = op;
                      us._postId = opId;
                      shares.push(us);
                    }
                  });
                }
              }
            }
          }catch(e){ console.warn('fetch user shares failed', e); }

                  // Deduplicate shares: sometimes the same share is returned twice
                  // (once from per-post /api/posts/{id}/shares and once from /api/users/{id}/shares)
                  try{
                    const seen = new Set();
                    const uniq = [];
                    shares.forEach(s=>{
                      const sid = s.id || s.shareId || s._id || null;
                      const key = sid ? String(sid) : (String(s._postId||'') + '::' + String((s.sharedText||s.shared_text||'').trim()));
                      if(!seen.has(key)){
                        seen.add(key);
                        uniq.push(s);
                      }
                    });
                    shares.length = 0; shares.push.apply(shares, uniq);
                  }catch(e){ console.warn('dedupe shares failed', e); }

                  // mark posts that have feed-level shares
                  postsWithFeedShare = new Set(shares.map(s=>String(s._postId)));

                  // convert posts and shares to unified feed items
          const feedItems = [];
          posts.forEach(p=>{
          const id = p.post_id || p.id || null;
          const created = p.created_at || p.createdAt || p.created || null;
          feedItems.push({ type: 'post', id: id, createdAt: created, raw: p });
          });
          shares.forEach(s=>{
          const created = s.created_at || s.createdAt || s.created || s.updated_at || s.updatedAt || null;
          // originalPost may be embedded as s.originalPost or we may look it up via postsById
          const orig = s.originalPost || postsById[String(s._postId)] || null;
          feedItems.push({ type: 'share', id: s.id || null, createdAt: created, share: s, originalPostId: s._postId, originalPost: orig });
          });

          // sort feed by createdAt desc
          feedItems.sort((a,b)=>{
          const ta = new Date(a.createdAt || 0).getTime();
          const tb = new Date(b.createdAt || 0).getTime();
          return tb - ta;
          });

          renderFeed(feedItems);
        }catch(err){
          console.error(err);
          listEl.innerHTML = '<div class="text-center text-muted small">Kh√¥ng t·∫£i ƒë∆∞·ª£c b√†i vi·∫øt.</div>';
        }
      }

      function renderFeed(items){
        listEl.innerHTML='';
        if(!Array.isArray(items) || items.length===0){
          listEl.innerHTML='<div class="text-center text-muted small">Ch∆∞a c√≥ b√†i vi·∫øt.</div>';
          return;
        }

        items.forEach(it=>{
          const node = tpl.content.firstElementChild.cloneNode(true);

                  if(it.type === 'post'){
          const p = it.raw;
          const postId = p.post_id || p.id || '';
                    // if this post also has a share item shown in the feed, mark the node so we can hide per-post .post-shares
          const author = p.author || {};
          const name = author.fullName || author.full_name || author.name || '·∫®n danh';
          const avatar = author.avatarUrl || author.avatar || '/img/image1.png';
          const created = p.created_at || p.createdAt || p.created || null;
          const updated = p.updated_at || p.updatedAt || p.updated || null;
          const content = (p.content || '').trim();

                    node.dataset.postId = postId;
                    if(postsWithFeedShare && postsWithFeedShare.has(String(postId))){
                      node.dataset.hasFeedShare = '1';
                    }
          node.id = 'post-'+postId;
          node.querySelector('.pc-name').textContent = name;
          node.querySelector('.pc-avatar').src = avatar;
          (function(){
            const timeEl = node.querySelector('.post-time'); if(!timeEl) return;
            const showTs = updated || created;
            const edited = (updated && created && (new Date(updated).getTime() > new Date(created).getTime()));
            timeEl.textContent = (typeof formatRelativeTime==='function' ? formatRelativeTime(showTs) : (showTs ? new Date(showTs).toLocaleString() : '')) + (edited ? ' ‚Ä¢ ƒê√£ ch·ªânh s·ª≠a' : '');
            const iso = showTs ? new Date(showTs).toISOString() : '';
            if(iso) timeEl.setAttribute('datetime', iso);
          })();
          node.querySelector('.post-content').textContent = content;
          if(!content) node.querySelector('.post-content').style.display='none';

          // visibility: set dataset + visible label from post data
          try{
            const visRaw = (p.visibility || p.visibility_level || p.visibilityType || '').toString().toLowerCase();
            if(visRaw){
              node.dataset.visibility = visRaw;
              const visElTop = node.querySelector('.pc-visibility');
              if(visElTop){
                const map = { public:'C√¥ng khai', friends:'B·∫°n b√®', friend:'B·∫°n b√®', private:'Ch·ªâ m√¨nh t√¥i' };
                visElTop.textContent = map[visRaw] || visElTop.textContent;
              }
            }
          }catch(_){ }
          // media handling (normalize various shapes like Post.medias)
          const mediaWrap = node.querySelector('.post-media'); mediaWrap.innerHTML='';
          const mediaArr = extractMediaFromPostLike(p);
          if(!Array.isArray(mediaArr) || mediaArr.length===0){ mediaWrap.style.display='none'; }
          else {
            mediaWrap.style.display='block';
            const total = mediaArr.length;
            const classMap = total<=4?('img-'+total):'img-4';
            mediaWrap.className = 'post-media pm-grid '+classMap;
            mediaArr.slice(0,4).forEach((m,idx)=>{
              const t = (m.mediaType||'image');
              const u = m.mediaUrl;
              if(!u) return;
              let el;
                      // If u looks like a bare filename (no protocol or leading slash), call media API
                      (function(){ if(u && !u.startsWith('http') && !u.startsWith('/') && !u.startsWith('data:')){ u = '/api/media/files/' + encodeURIComponent(u); } return u; })();
                      if(String(t).toLowerCase().includes('video') || String(u).toLowerCase().endsWith('.mp4') || String(u).toLowerCase().endsWith('.webm')){
                        el=document.createElement('video'); el.style.width='100%'; el.style.height='100%'; el.style.objectFit='contain'; el.style.display='block'; el.style.background='#000'; el.src=u; el.controls=true; el.playsInline=true;
                      } else {
                        el=document.createElement('img'); el.src=u; el.loading='lazy'; el.alt='';
                      }
              const fig=document.createElement('figure'); fig.style.margin='0'; fig.appendChild(el);
              if(idx===3 && total>4){ const overlay=document.createElement('div'); overlay.textContent='+'+(total-4); overlay.style.position='absolute'; overlay.style.inset='0'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.fontSize='2rem'; overlay.style.fontWeight='700'; overlay.style.color='#fff'; overlay.style.background='rgba(0,0,0,.45)'; overlay.style.backdropFilter='blur(2px)'; fig.style.position='relative'; fig.appendChild(overlay); }
              mediaWrap.appendChild(fig);
            });
          }

          } else if(it.type === 'share'){
          const s = it.share;
          const sharer = s.user || {};
          const name = sharer.fullName || sharer.full_name || sharer.name || '·∫®n danh';
          const avatar = sharer.avatarUrl || sharer.avatar || '/img/image1.png';
          // Prefer updated timestamp for display (show when the share was last updated), fall back to created
          const created = s.updated_at || s.updatedAt || s.updated || s.created_at || s.createdAt || s.created || null;
          const sharedText = s.sharedText || s.shared_text || '';
          // Visibility stored on the share record (may differ from original post)
          const shareVisibility = (s.visibility || s.visibility_level || s.visibilityType || '').toString().toLowerCase() || '';

          // mark as share item
          node.classList.add('share-item');
          // keep original post id as attribute for reference
          if(it.originalPostId) {
            node.dataset.originalPostId = it.originalPostId;
            // For share items, set postId to the original post id so edit/delete handlers can find the post
            node.dataset.postId = it.originalPostId; 
          }
          node.dataset.shareId = it.id || '';
          // Prevent rendering the per-post shares list inside this share item (avoids duplicate shared_text)
          node.dataset.hasFeedShare = '1';

          node.querySelector('.pc-name').textContent = name + ' ‚Ä¢ ƒê√£ chia s·∫ª';
          node.querySelector('.pc-avatar').src = avatar;
          // set dataset.visibility from share
          try{ if(shareVisibility) node.dataset.visibility = shareVisibility; }catch(_){ }
          // update visibility label in header if present
          try{
            const visElTop = node.querySelector('.pc-visibility');
            if(visElTop){ const map = { public:'C√¥ng khai', friends:'B·∫°n b√®', friend:'B·∫°n b√®', private:'Ch·ªâ m√¨nh t√¥i' }; visElTop.textContent = map[shareVisibility] || (shareVisibility || visElTop.textContent); }
          }catch(_){ }
          (function(){ const timeEl = node.querySelector('.post-time'); timeEl.textContent = formatRelativeTime(created); const iso = created ? new Date(created).toISOString() : ''; if(iso) timeEl.setAttribute('datetime', iso); })();

          // show shared text as the main content
          const contentEl = node.querySelector('.post-content'); contentEl.textContent = (sharedText || '').trim(); if(!contentEl.textContent) contentEl.style.display='none';

          // show a detailed preview box for the original post (author, content, media)
          try{
            const previewWrap = document.createElement('div'); previewWrap.className = 'mt-2';
            // helper to normalize content for duplicate detection
            const norm = (s)=> String(s||'').replace(/\s+/g,' ').trim().toLowerCase();
            if(it.originalPost){
              try{
                const cloned = tpl.content.firstElementChild.cloneNode(true);
                // detect duplicate content: if share's text equals original post content (case-insensitive, collapsed whitespace)
                const op = it.originalPost || {};
                const origContent = norm(op.content || op.caption || op.text || '');
                const sText = norm(sharedText || '');
                const duplicate = !!(sText && origContent && sText === origContent);
                // Always hide author in the preview to avoid name duplication; hide content when duplicate
                populatePostNode(cloned, it.originalPost, { compact: true, hideContent: duplicate });
                try{ if(it.originalPostId){ cloned.dataset.postId = String(it.originalPostId); cloned.dataset.originalPostId = String(it.originalPostId); } }catch(_){ }
                previewWrap.appendChild(cloned);
                try{ if(typeof window.initCommentsForArticle === 'function'){ window.initCommentsForArticle(cloned); } }catch(_){ }
              }catch(e){ console.error('render share preview error', e); previewWrap.innerHTML = '<div class="small text-muted">(Kh√¥ng th·ªÉ hi·ªÉn th·ªã b√†i g·ªëc)</div>'; }
            } else if(it.originalPostId){
              previewWrap.innerHTML = '<div class="small text-muted">ƒêang t·∫£i b√†i g·ªëc‚Ä¶</div>';
              (async function(){
                try{
                  const r = await fetch('/api/posts/' + encodeURIComponent(it.originalPostId), { credentials:'include' });
                  if(r.ok){ const json = await r.json(); const cloned = tpl.content.firstElementChild.cloneNode(true);
                      try{
                        const origContent = norm(json.content || json.caption || json.text || '');
                        const sText = norm(sharedText || '');
                        const duplicate = !!(sText && origContent && sText === origContent);
                        populatePostNode(cloned, json, { compact: true, hideContent: duplicate });
                        try{ if(it.originalPostId){ cloned.dataset.postId = String(it.originalPostId); cloned.dataset.originalPostId = String(it.originalPostId); } }catch(_){ }
                      }catch(e){ populatePostNode(cloned, json, { compact: true }); }
                      try{ if(it.originalPostId){ cloned.dataset.postId = String(it.originalPostId); cloned.dataset.originalPostId = String(it.originalPostId); } }catch(_){ }
            previewWrap.innerHTML=''; previewWrap.appendChild(cloned); try{ if(typeof window.initCommentsForArticle === 'function'){ window.initCommentsForArticle(cloned); } }catch(_){ } }
                  else { previewWrap.innerHTML = '<div class="small text-muted">(Kh√¥ng th·ªÉ t·∫£i b√†i g·ªëc)</div>'; }
                }catch(e){ console.error('fetch original post failed', e); previewWrap.innerHTML = '<div class="small text-muted">(Kh√¥ng th·ªÉ t·∫£i b√†i g·ªëc)</div>'; }
              })();
            } else {
              previewWrap.innerHTML = '<div class="small text-muted">(B√†i g·ªëc kh√¥ng c√≥ s·∫µn)</div>';
            }

            const bodyArea = node.querySelector('.pc-body') || node;
            bodyArea.appendChild(previewWrap);
          }catch(e){ console.error(e); }

          // hide media area for the share item (we show preview only)
          const mediaWrap2 = node.querySelector('.post-media'); mediaWrap2.innerHTML=''; mediaWrap2.style.display='none';
          }

          // initialize reactions so counts and states load for this node (post or share)
          try{
            if(window.QDTReactions){
              const comp = node.querySelector('.reaction-composer');
              if(comp) window.QDTReactions.ensureLoaded(comp);
            }
          }catch(e){}

          try{
            node.querySelectorAll('.btn-comment').forEach(function(btn){
              btn.addEventListener('click', function(ev){
                try{
                  const article = btn.closest('article') || node;
                  const modal = Array.from(article.querySelectorAll('.comments-modal')).find(m => (m.closest('article') === article)) || null;
                  if(modal){
                    if(!article._loadComments && typeof window.initCommentsForArticle === 'function'){
                      try{ window.initCommentsForArticle(article); }catch(_){ }
                    }
                    if(article._loadComments) article._loadComments();
                    const inst = bootstrap.Modal.getOrCreateInstance(modal);
                    inst.show();
                    setTimeout(()=>{ const input = article.querySelector('.modal-comment-input'); if(input) input.focus(); }, 150);
                    return;
                  }
                }catch(_){ }
                // fallback
                try{ node.querySelector('.pc-footer').classList.toggle('d-none'); node.querySelector('.cm-input')?.focus(); }catch(__){}
              });
            });
          }catch(e){}

          try{ node.addEventListener('keydown',e=>{ if(e.target.classList && e.target.classList.contains && e.target.classList.contains('cm-input') && e.key==='Enter'){ e.preventDefault(); e.target.value=''; } }); }catch(e){}

          listEl.appendChild(node);
          // ensure reactions loaded after insertion as well (in case defer is needed)
          try{
            if(window.QDTReactions){
              const comp = node.querySelector('.reaction-composer');
              if(comp) window.QDTReactions.ensureLoaded(comp);
            }
          }catch(_){ }
          try{ if(typeof window.initCommentsForArticle === 'function'){ window.initCommentsForArticle(node); } }catch(_){ }

                  // Ensure per-article share handlers and loader are initialized
                  try{
                    (function(article){
                      if(!article || article._shareInit) return; // already initialized
                      article._shareInit = true;
                      var shareModal = article.querySelector('.share-modal');
                      if(!shareModal) return;
                      var btn = shareModal.querySelector('.share-send-btn');
                      var ta = shareModal.querySelector('.share-textarea');
                      if(btn){
                        btn.addEventListener('click', async function(){
                          try{
                            var postId = article.dataset.postId; if(!postId) return;
                            var text = (ta && ta.value||'').trim();
                            var visEl = shareModal.querySelector('.share-visibility');
                            var visibility = (visEl && visEl.value) || 'public';
                            var body = { shared_text: text, visibility: visibility };
                            var res = await fetch('/api/posts/'+encodeURIComponent(postId)+'/shares', {
                              method: 'POST', credentials: 'include',
                              headers: {'Content-Type':'application/json'},
                              body: JSON.stringify(body)
                            });
                            if(res.ok){
                              try{ bootstrap.Modal.getInstance(shareModal).hide(); }catch(_){ }
                              try{ var toasts = document.querySelector('.qdt-toast-area'); if(!toasts){ toasts = document.createElement('div'); toasts.className='qdt-toast-area position-fixed top-0 end-0 p-3'; document.body.appendChild(toasts);} var t = document.createElement('div'); t.className='toast show bg-success text-white p-2 my-2'; t.textContent='ƒê√£ chia s·∫ª'; toasts.appendChild(t); setTimeout(()=>t.remove(),3000);}catch(e){}
                              try{ if(typeof article._loadShares === 'function') article._loadShares(); }catch(e){}
                            } else {
                              var json = {};
                              try{ json = await res.json(); }catch(e){}
                              alert('Kh√¥ng th·ªÉ chia s·∫ª: '+(json && json.message?json.message:res.status));
                            }
                          }catch(e){ console.error(e); alert('L·ªói khi chia s·∫ª'); }
                        });
                      }

                      // define loader if not present
                        if(typeof article._loadShares !== 'function'){
                          article._loadShares = async function(){
                            try{
                              // if this post is already shown as a feed-level share, skip per-post shares to avoid duplicate UI
                              if(article.dataset.hasFeedShare === '1'){
                                var containerSkip = article.querySelector('.post-shares'); if(containerSkip) containerSkip.style.display='none';
                                return;
                              }
                              var postId = article.dataset.postId; if(!postId) return;
                              var container = article.querySelector('.post-shares'); if(!container) return;
                              container.innerHTML = '<div class="text-muted small">ƒêang t·∫£i chia s·∫ª...</div>';
                              const res = await fetch('/api/posts/'+encodeURIComponent(postId)+'/shares', { credentials:'include' });
                              if(!res.ok){ container.innerHTML = '<div class="text-muted small">Kh√¥ng th·ªÉ t·∫£i chia s·∫ª</div>'; return; }
                              const arr = await res.json(); if(!Array.isArray(arr) || arr.length===0){ container.innerHTML = ''; return; }
                              // render each share as a compact card
container.innerHTML = '';
arr.forEach(s=>{
  const wrap = document.createElement('div');
  wrap.className = 'card mb-2';

  const body = document.createElement('div');
  body.className = 'card-body py-2';

  // --- Header: Avatar + Name ---
  const top = document.createElement('div');
  top.className = 'd-flex align-items-center gap-2';
  const av = document.createElement('img');
  av.src = (s.user && (s.user.avatarUrl || s.user.avatar_url)) || '/img/image1.png';
  av.className = 'rounded-circle';
  av.style.width = '36px';
  av.style.height = '36px';
  av.style.objectFit = 'cover';

  const name = document.createElement('div');
  name.className = 'fw-semibold';
  name.textContent =
    (s.user && (s.user.fullName || s.user.full_name)) ||
    (s.user && (s.user.firstName || s.user.first_name)) ||
    '·∫®n danh';

  top.append(av, name);
  body.appendChild(top);

  // --- Shared text ---
  if (s.sharedText || s.shared_text) {
    const sharedText = document.createElement('div');
    sharedText.className = 'mt-2';
    sharedText.textContent = s.sharedText || s.shared_text || '';
    body.appendChild(sharedText);
  }

  // --- Shared media (images/videos) ---
  (function(){
    try{
      const mediaArr = extractMediaFromPostLike(s);
      if(Array.isArray(mediaArr) && mediaArr.length > 0){
        const mediaWrap = document.createElement('div');
        mediaWrap.className = 'mt-2 d-flex flex-wrap gap-2';
        mediaArr.forEach(m => {
          const t = (m.mediaType||'image').toLowerCase();
          const url = m.mediaUrl;
          if(!url) return;
          (function(){ if(url && !url.startsWith('http') && !url.startsWith('/') && !url.startsWith('data:')){ url = '/api/media/files/' + encodeURIComponent(url); } return url; })();
          if(t.includes('image') || url.toLowerCase().endsWith('.jpg') || url.toLowerCase().endsWith('.png') || url.toLowerCase().endsWith('.jpeg')){
            const img = document.createElement('img'); img.src = url; img.className='img-fluid rounded'; img.style.maxHeight='300px'; img.style.objectFit='cover'; mediaWrap.appendChild(img);
          } else {
            const vid = document.createElement('video'); vid.src = url; vid.controls = true; vid.className='rounded'; vid.style.maxHeight='360px'; vid.style.width='100%'; mediaWrap.appendChild(vid);
          }
        });
        body.appendChild(mediaWrap);
      }
    }catch(e){ console.error(e); }
  })();

  wrap.appendChild(body);
  container.appendChild(wrap);
});

                            }catch(e){ console.error(e); }
                          };
                        }

                        try{ article._loadShares(); }catch(e){}
                    })(node);
                  }catch(e){}
              });

          // safety: ensure all dynamically created articles have comments init
          try{
            if(typeof window.initCommentsForArticle === 'function'){
              setTimeout(function(){
                document.querySelectorAll('article.post-card').forEach(function(a){ try{ window.initCommentsForArticle(a); }catch(_){ } });
              }, 0);
            }
          }catch(_){ }

          }

          function formatRelativeTime(ts){
              if(!ts) return '';
              const d=new Date(ts);
              if(isNaN(d)) return '';
              const diff = (Date.now()-d.getTime())/1000;
              if(diff<60) return 'V·ª´a xong';
              if(diff<3600) return Math.floor(diff/60)+' ph√∫t';
              if(diff<86400) return Math.floor(diff/3600)+' gi·ªù';
              if(diff<172800) return 'H√¥m qua';
              return d.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'});
          }

          loadPosts();
      })();
      // Deep-link handler: if URL has ?postId=... then open that post's comments modal and optionally scroll to comment
      (function(){
        try{
          const params = new URL(window.location.href).searchParams;
          const postId = params.get('postId') || params.get('postid');
          if(!postId) return;
          // wait a tick for posts to render
          setTimeout(function(){
            const article = document.querySelector('article.post-card[data-post-id="'+postId+'"]') || document.getElementById('post-'+postId);
            if(article){
              // show comments modal if present
              const modal = article.querySelector('.comments-modal');
              if(modal){
                try{ bootstrap.Modal.getOrCreateInstance(modal).show(); }catch(e){}
                // if fragment contains comment-<id>, scroll into view after comments loaded
                const hash = window.location.hash || '';
                if(hash && hash.startsWith('#comment-')){
                  const commentId = hash.replace('#','');
                  // wait for comments to load then scroll
                  setTimeout(function(){
                    const el = article.querySelector('#'+CSS.escape(commentId));
                    if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.style.transition='background-color 0.6s'; const prevBg=el.style.backgroundColor; el.style.backgroundColor='#fff3cd'; setTimeout(()=>{ el.style.backgroundColor = prevBg; }, 1600); }
                  }, 600);
                }
              } else {
                // no modal: just scroll to article
                article.scrollIntoView({behavior:'smooth', block:'center'});
              }
            } else {
              // not found yet: try again shortly (in case posts are still loading)
              setTimeout(function(){ window.location = window.location.href; }, 400);
            }
          }, 600);
        }catch(e){}
      })();
      </script>
      
      <!-- Confirm Delete Share Modal (inside fragment) -->
      <div class="modal fade" id="qdt_confirm_delete_share_modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">X√°c nh·∫≠n x√≥a</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>
            <div class="modal-body">
              B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a chia s·∫ª n√†y?
              <div id="qdt_confirm_delete_share_error" class="text-danger small mt-2" style="display:none"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="button" class="btn btn-danger" id="qdt_confirm_delete_share_btn">X√≥a</button>
            </div>
          </div>
        </div>
      </div>

      <script>
        (function(){
          const modalEl = document.getElementById('qdt_confirm_delete_share_modal');
          const btnConfirm = document.getElementById('qdt_confirm_delete_share_btn');
          const errEl = document.getElementById('qdt_confirm_delete_share_error');
          let modalInstance = null;

          function ensure(){
            if(!modalInstance && modalEl && typeof bootstrap !== 'undefined'){
              modalInstance = new bootstrap.Modal(modalEl);
            }
          }

          // Open the confirm modal for deleting a share
          window.openConfirmDeleteShare = function(articleEl, postId, shareId){
            console.log('[delete-share] openConfirmDeleteShare()', { postId, shareId, articleEl });
            try{
              if(!modalEl){ console.error('qdt_confirm_delete_share_modal not found'); return; }
              if(typeof bootstrap === 'undefined'){ console.error('Bootstrap is not available'); return; }
              ensure();
              if(!modalInstance){ console.error('Failed to create Bootstrap modal instance'); return; }
              // Store context on modal element
              modalEl.dataset.postId = postId || '';
              modalEl.dataset.shareId = shareId || '';
              modalEl._articleEl = articleEl || null; // keep DOM ref for removal
              if(errEl){ errEl.style.display='none'; errEl.textContent=''; }
              if(btnConfirm){ btnConfirm.disabled = !(postId && shareId); }
              modalInstance.show();
            }catch(e){ console.error('openConfirmDeleteShare error:', e); }
          };

          async function doDeleteShare(){
            try{
              const postId = modalEl?.dataset?.postId;
              const shareId = modalEl?.dataset?.shareId;
              if(!postId || !shareId){
                if(errEl){ errEl.style.display='block'; errEl.textContent='Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c b√†i chia s·∫ª ƒë·ªÉ x√≥a.'; }
                return;
              }
              if(btnConfirm){ btnConfirm.disabled = true; btnConfirm.textContent = 'ƒêang x√≥a...'; }
              const url = '/api/posts/' + encodeURIComponent(postId) + '/shares/' + encodeURIComponent(shareId);
              const res = await fetch(url, { method:'DELETE', credentials:'include' });
              if(res.ok || res.status === 204){
                try{ modalInstance.hide(); }catch(_){ }
                // Remove the share article element if available
                try{
                  const art = modalEl._articleEl;
                  if(art){ art.remove(); }
                  else {
                    // Fallback: remove by data-share-id
                    const a2 = document.querySelector('article.post-card[data-share-id="'+String(shareId)+'"]');
                    if(a2) a2.remove();
                  }
                }catch(_){ }
                try{ window.showToast && showToast('ƒê√£ x√≥a b√†i chia s·∫ª', 'success'); }catch(_){ }
                // Optionally refresh lists
                try{ if(typeof window.loadPosts === 'function') window.loadPosts(); }catch(_){ }
                // refresh share count for the original post
                try{ if(window.QDTCounts && window.QDTCounts.refreshShareCountForPost){ window.QDTCounts.refreshShareCountForPost(postId); } }catch(_){ }
              } else {
                let j=null; try{ j = await res.json(); }catch(_){ }
                const msg = (j && (j.message||j.error)) ? j.message||j.error : ('L·ªói: ' + res.status);
                if(errEl){ errEl.style.display='block'; errEl.textContent = msg; }
              }
            }catch(e){
              console.error(e);
              if(errEl){ errEl.style.display='block'; errEl.textContent='ƒê√£ x·∫£y ra l·ªói khi x√≥a.'; }
            }finally{
              if(btnConfirm){ btnConfirm.disabled=false; btnConfirm.textContent='X√≥a'; }
            }
          }

          if(btnConfirm){ btnConfirm.addEventListener('click', doDeleteShare); }
        })();
      </script>

      <!-- Confirm Delete Post Modal (inside fragment) -->
      <div class="modal fade" id="qdt_confirm_delete_post_modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">X√°c nh·∫≠n x√≥a</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>
            <div class="modal-body">
              B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?
              <div id="qdt_confirm_delete_post_error" class="text-danger small mt-2" style="display:none"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="button" class="btn btn-danger" id="qdt_confirm_delete_post_btn">X√≥a</button>
            </div>
          </div>
        </div>
      </div>

      <script>
        (function(){
          const modalEl = document.getElementById('qdt_confirm_delete_post_modal');
          const btnConfirm = document.getElementById('qdt_confirm_delete_post_btn');
          const errEl = document.getElementById('qdt_confirm_delete_post_error');
          let modalInstance = null;

          function ensure(){
            if(!modalInstance && modalEl && typeof bootstrap !== 'undefined'){
              modalInstance = new bootstrap.Modal(modalEl);
            }
          }

          // Open the confirm modal for deleting a full post
          window.openConfirmDeletePost = function(articleEl, postId){
            console.log('[delete-post] openConfirmDeletePost()', { postId, articleEl });
            try{
              if(!modalEl){ console.error('qdt_confirm_delete_post_modal not found'); return; }
              if(typeof bootstrap === 'undefined'){ console.error('Bootstrap is not available'); return; }
              ensure();
              if(!modalInstance){ console.error('Failed to create Bootstrap modal instance'); return; }
              modalEl.dataset.postId = postId || '';
              modalEl._articleEl = articleEl || null;
              if(errEl){ errEl.style.display='none'; errEl.textContent=''; }
              if(btnConfirm){ btnConfirm.disabled = !(postId); }
              modalInstance.show();
            }catch(e){ console.error('openConfirmDeletePost error:', e); }
          };

          async function doDeletePost(){
            try{
              const postId = modalEl?.dataset?.postId;
              if(!postId){ if(errEl){ errEl.style.display='block'; errEl.textContent='Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c b√†i vi·∫øt ƒë·ªÉ x√≥a.'; } return; }
              if(btnConfirm){ btnConfirm.disabled=true; btnConfirm.textContent='ƒêang x√≥a...'; }
              const url = '/api/posts/' + encodeURIComponent(postId);
              const res = await fetch(url, { method:'DELETE', credentials:'include' });
              if(res.ok || res.status === 204){
                try{ modalInstance.hide(); }catch(_){ }
                try{
                  const art = modalEl._articleEl || document.querySelector('article.post-card[data-post-id="'+String(postId)+'"]');
                  if(art) art.remove();
                }catch(_){ }
                // Remove any share feed items that reference this original post (immediate UI update)
                try{
                  const sel = 'article.post-card[data-post-id="'+String(postId)+'"], article.post-card.share-item[data-post-id="'+String(postId)+'"], article.post-card.share-item[data-original-post-id="'+String(postId)+'"], article.post-card[data-original-post-id="'+String(postId)+'"]';
                  const relatedShares = document.querySelectorAll(sel);
                  relatedShares.forEach(function(el){ try{ el.remove(); }catch(e){} });
                }catch(_){ }
                try{ window.showToast && showToast('ƒê√£ x√≥a b√†i vi·∫øt', 'success'); }catch(_){ }
                try{ if(typeof window.loadPosts === 'function') window.loadPosts(); }catch(_){ }
              } else {
                let j=null; try{ j = await res.json(); }catch(_){ }
                const msg = (j && (j.message||j.error)) ? j.message||j.error : ('L·ªói: ' + res.status);
                if(errEl){ errEl.style.display='block'; errEl.textContent = msg; }
              }
            }catch(e){
              console.error(e);
              if(errEl){ errEl.style.display='block'; errEl.textContent='ƒê√£ x·∫£y ra l·ªói khi x√≥a.'; }
            }finally{
              if(btnConfirm){ btnConfirm.disabled=false; btnConfirm.textContent='X√≥a'; }
            }
          }

          if(btnConfirm){ btnConfirm.addEventListener('click', doDeletePost); }
        })();
      </script>

      <!-- Post Segment:END -->
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Edit Share Modal -->
  <div class="modal fade" id="qdt_edit_share_modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">S·ª≠a b√†i chia s·∫ª</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">N·ªôi dung chia s·∫ª</label>
            <textarea class="form-control" id="qdt_edit_share_text" rows="3" placeholder="Vi·∫øt g√¨ ƒë√≥..."></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Tr·∫°ng th√°i</label>
            <select class="form-select" id="qdt_edit_share_visibility">
              <option value="public">C√¥ng khai</option>
              <option value="friends">B·∫°n b√®</option>
              <option value="private">C√° nh√¢n</option>
            </select>
          </div>
          <div id="qdt_edit_share_error" class="text-danger small" style="display:none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" id="qdt_edit_share_submit">L∆∞u thay ƒë·ªïi</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const modalEl = document.getElementById('qdt_edit_share_modal');
      let modalInstance = null;
      function ensure(){ if(!modalInstance) modalInstance = new bootstrap.Modal(modalEl); }

      window.openEditShareModal = function(opts){
        try{
          if(!modalEl){ console.error('openEditShareModal: modal element not found (id=qdt_edit_share_modal)'); alert('Kh√¥ng th·ªÉ m·ªü giao di·ªán s·ª≠a share: modal kh√¥ng t·ªìn t·∫°i.'); return; }
          if(typeof bootstrap === 'undefined'){ console.error('openEditShareModal: bootstrap is undefined'); alert('Kh√¥ng th·ªÉ m·ªü giao di·ªán s·ª≠a share: bootstrap kh√¥ng s·∫µn s√†ng.'); return; }
          ensure();
          if(!modalInstance){ console.error('openEditShareModal: failed to create modal instance'); alert('Kh√¥ng th·ªÉ m·ªü giao di·ªán s·ª≠a share.'); return; }
          modalEl.dataset.postId = opts.postId;
          modalEl.dataset.shareId = opts.shareId;
          modalEl.dataset.articleSelector = ''; // optional
          const ta = modalEl.querySelector('#qdt_edit_share_text');
          const sel = modalEl.querySelector('#qdt_edit_share_visibility');
          const err = modalEl.querySelector('#qdt_edit_share_error');
          if(ta) ta.value = opts.sharedText || '';
          if(sel) sel.value = opts.visibility || 'public';
          if(err) { err.style.display='none'; err.textContent=''; }
          modalInstance.show();
        }catch(e){ console.error('openEditShareModal error:', e); alert('Kh√¥ng th·ªÉ m·ªü giao di·ªán s·ª≠a share. Ki·ªÉm tra console ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.'); }
      };

      async function submitEditShare(){
        try{
          const postId = modalEl.dataset.postId; const shareId = modalEl.dataset.shareId;
          const ta = modalEl.querySelector('#qdt_edit_share_text');
          const sel = modalEl.querySelector('#qdt_edit_share_visibility');
          const err = modalEl.querySelector('#qdt_edit_share_error');
          if(!postId || !shareId){ if(err){ err.style.display='block'; err.textContent='Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c b√†i share.'; } return; }
          const body = { shared_text: (ta && ta.value) ? ta.value : '' };
          if(sel && sel.value) body.visibility = sel.value;
          const url = '/api/posts/' + encodeURIComponent(postId) + '/shares/' + encodeURIComponent(shareId);
          const res = await fetch(url, { method: 'PUT', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
          if(!res.ok){ let j=null; try{ j = await res.json(); }catch(_){ } if(err){ err.style.display='block'; err.textContent = (j && j.message) ? j.message : ('L·ªói: ' + res.status); } return; }
          const updated = await res.json().catch(()=>null);
          // Update DOM: replace post-content text, visibility label and time if present
          try{
            const rootArticle = document.querySelector('article[data-share-id="'+String(shareId)+'"]') || document.querySelector('article.post-card[data-share-id="'+String(shareId)+'"]');
            if(rootArticle){
              // update content
              const contentEl = rootArticle.querySelector('.post-content'); if(contentEl) contentEl.textContent = body.shared_text;
              // update visibility dataset + label
              if(body.visibility){
                try{ rootArticle.dataset.visibility = body.visibility; }catch(_){ }
                const visEl = rootArticle.querySelector('.pc-visibility');
                if(visEl){ const map = { public: 'C√¥ng khai', friend: 'B·∫°n b√®', friends: 'B·∫°n b√®', private: 'C√° nh√¢n' }; visEl.textContent = map[body.visibility] || body.visibility; }
              }
              // update time to show edited
              const timeEl = rootArticle.querySelector('.post-time');
              try{
                if(timeEl){ if(typeof formatRelativeTime === 'function'){ const nowIso = new Date().toISOString(); timeEl.textContent = formatRelativeTime(nowIso) + ' ‚Ä¢ ƒê√£ ch·ªânh s·ª≠a'; timeEl.setAttribute('datetime', nowIso); } else { timeEl.textContent = 'V·ª´a xong ‚Ä¢ ƒê√£ ch·ªânh s·ª≠a'; } }
              }catch(_){ }
            }
          }catch(_){ }
          modalInstance.hide();
          try{ const toasts = document.querySelector('.qdt-toast-area') || (function(){ const t=document.createElement('div'); t.className='qdt-toast-area position-fixed top-0 end-0 p-3'; document.body.appendChild(t); return t; })(); const t=document.createElement('div'); t.className='toast show bg-success text-white p-2 my-2'; t.textContent='C·∫≠p nh·∫≠t chia s·∫ª th√†nh c√¥ng'; toasts.appendChild(t); setTimeout(()=>t.remove(),3000); }catch(_){ }
        }catch(e){ console.error(e); const err = modalEl.querySelector('#qdt_edit_share_error'); if(err){ err.style.display='block'; err.textContent='ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t.'; } }
      }

      const submitBtn = document.getElementById('qdt_edit_share_submit');
      if(submitBtn) submitBtn.addEventListener('click', submitEditShare);
    })();
  </script>
  <script>
    // Diagnostic helper: run from console with runEditShareDiagnostics();
    window.runEditShareDiagnostics = function(){
      try{
        const modalEl = document.getElementById('qdt_edit_share_modal');
        console.log('qdt_edit_share_modal element:', modalEl);
        console.log('bootstrap available:', typeof bootstrap !== 'undefined');
        if(modalEl){ console.log('modal in body?', document.body.contains(modalEl)); }
      }catch(e){ console.error(e); }
    };
  </script>
  
  </body>
</html>
