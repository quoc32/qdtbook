<!-- fragments.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8">
    <title>QDTBook - Home</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <style>
      body { background:#f0f2f5; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
      .navbar-brand { font-weight:700; color:#1365ff !important; }
      .search-box { background:#f0f2f5; border:none; border-radius:20px; padding:6px 14px; width:230px; }
      .search-box:focus { outline:0; box-shadow:none; background:#e4e6eb; }
      .sidebar-sticky { position:sticky; top:70px; }
      .story-card { height:160px; border-radius:12px; background:#fff; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; font-weight:600; color:#555; }
      .composer, .post-card { background:#fff; border-radius:8px; border:1px solid #ddd; }
      .composer textarea { resize:none; border:none; box-shadow:none; }
      .composer textarea:focus { outline:0; }
      .btn-primary { background:#1b74e4; border-color:#1b74e4; }
      .btn-primary:hover { background:#155ec0; }
      .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; }
      .post-img { border-radius:8px; max-height:480px; object-fit:cover; width:100%; }
      .action-btn { background:transparent; border:none; padding:6px 8px; border-radius:6px; font-weight:500; color:#555; }
      .action-btn:hover { background:#f0f2f5; }
      .right-card { background:#fff; border:1px solid #ddd; border-radius:8px; }
      @media (max-width: 992px){
          .left-col, .right-col { display:none; }
          .search-box { width:140px; }
      }
    </style>
  </head>
  <body>

    <div th:fragment="postSegment(fetchUrl, isSelfProfile)">
        <!-- Khai b√°o bi·∫øn Thymeleaf cho JavaScript -->
        <p th:text="${fetchUrl}" id="fetchUrl_id" style="display: none;"></p>
        <p th:text="${isSelfProfile}" id="isSelfProfile_id" hidden></p>
        <script th:inline="javascript">
            /*<![CDATA[*/
            const fetchUrl = document.getElementById('fetchUrl_id').textContent;
            /*]]>*/
            var isSelfProfile = (function(){
                const el = document.getElementById('isSelfProfile_id');
                if(!el) return 'false';
                const val = el.textContent.trim().toLowerCase();
                return val === 'true' || val === '1';
            })();
        </script>

      <!-- Post Segment:BEGIN -->
      <div id="postList" class="post-feed"></div>

      <template id="postCardTemplate">
          <article class="post-card" data-post-id="">
              <div class="pc-head">
                  <div class="pc-author">
                      <div class="pc-av-wrap">
                            <img class="pc-avatar" src="/img/image1.png" alt="">
                      </div>
                      <div class="pc-author-text">
                          <div class="pc-name">·∫®n danh</div>
                          <div class="pc-meta">
                              <time class="post-time"></time>
                              <span class="pc-dot"></span>
                              <span class="pc-visibility">B·∫°n b√®</span>
                          </div>
                      </div>
                  </div>
                <button class="pc-menu" type="button" aria-label="Menu"
                    onclick="(function(btn){var m=btn.closest('article').querySelector('.pc-more-modal');bootstrap.Modal.getOrCreateInstance(m).show();})(this)">
                  <i class="bi bi-three-dots"></i>
                </button>

                <!-- Modal t√πy ch·ªçn b√†i Post:BEGIN -->
                <div class="modal fade pc-more-modal" tabindex="-1" aria-hidden="true" role="dialog">
                  <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content">
                      <div class="modal-header">
                    <h5 class="modal-title">T√πy ch·ªçn b√†i vi·∫øt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                      </div>
                      <div class="modal-body">
                    <div class="list-group list-group-flush">

                        <button type="button" class="list-group-item list-group-item-action"
                            th:if="${canDeletePost}"
                            onclick="(function(btn){
                                console.log('Delete post clicked');
                                const isSelf = isSelfProfile;
                                if(!isSelf){
                                    alert('Ch·ªâ c√≥ th·ªÉ x√≥a b√†i vi·∫øt tr√™n trang c√° nh√¢n c·ªßa b·∫°n.');
                                    return;
                                }
                                const article = btn.closest('article');
                                const postId = article.dataset.postId;
                                if(!postId){
                                    alert('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c b√†i vi·∫øt ƒë·ªÉ x√≥a.');
                                    return;
                                }
                                if(!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?')){
                                    return;
                                }
                                // G·ª≠i y√™u c·∫ßu x√≥a b√†i vi·∫øt
                                fetch('/api/posts/' + encodeURIComponent(postId), {
                                    method: 'DELETE',
                                    credentials: 'include'
                                }).then(res => {
                                    if(res.ok){
                                        // X√≥a b√†i vi·∫øt kh·ªèi giao di·ªán
                                        article.remove();
                                    }else{
                                        alert('X√≥a b√†i vi·∫øt th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
                                    }
                                }).catch(err => {
                                    console.error(err);
                                    alert('ƒê√£ x·∫£y ra l·ªói khi x√≥a b√†i vi·∫øt.');
                                }).finally(() => {
                                    window.location.reload();
                                });
                            })(this);"
                        >X√≥a b√†i vi·∫øt</button>
                        <!-- Script x·ª≠ l√Ω x√≥a b√†i vi·∫øt -->
                        <script>
                            
                        </script>

                      <button type="button" class="list-group-item list-group-item-action">B√°o c√°o</button>
                      <button type="button" class="list-group-item list-group-item-action" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Modal t√πy ch·ªçn b√†i Post:END -->
              </div>

              <div class="pc-body">
                  <div class="post-content"></div>
                  <div class="post-media pm-grid"></div>
              </div>


              <div class="pc-actions" id="post-info-reactions-and-comments">
                  
                <!-- N√∫t hi·ªÉn th·ªã s·ªë l∆∞·ª£ng v√† lo·∫°i reactions -->
                <button type="button" class="btn-reaction-summary"
                        style="display:inline-flex;align-items:center;gap:4px;background:transparent;border:0;padding:0;color:#65676b;font-weight:500;font-size:.9rem;line-height:1;text-transform:none;box-shadow:none;"
                        onclick="(async function(btn){
                          try{
                            const article = btn.closest('article'); if(!article) return;
                            const postId = article.dataset.postId; if(!postId) return;

                            const modal = article.querySelector('.reactions-modal');
                            const listEl = modal.querySelector('.reactions-list');
                            const tabsWrap = modal.querySelector('.reaction-tabs');

                            function iconByType(t){
                              t=String(t||'').toLowerCase();
                              if(t==='love') return '<i class=&quot;bi bi-heart-fill text-danger&quot;></i>';
                              if(t==='haha') return 'üòÜ';
                              if(t==='sad')  return 'üò¢';
                              if(t==='angry')return 'üò°';
                              return '<i class=&quot;bi bi-hand-thumbs-up&quot;></i>';
                            }
                            function fmtTime(ts){
                              if(!ts) return '';
                              const d=new Date(ts); if(isNaN(d)) return '';
                              const diff=(Date.now()-d.getTime())/1000;
                              if(diff<60) return 'V·ª´a xong';
                              if(diff<3600) return Math.floor(diff/60)+' ph√∫t';
                              if(diff<86400) return Math.floor(diff/3600)+' gi·ªù';
                              if(diff<172800) return 'H√¥m qua';
                              return d.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'});
                            }
                            function updateCounts(arr){
                              const counts={all:arr.length, like:0,love:0,haha:0,sad:0,angry:0};
                              arr.forEach(r=>{ const t=String(r.reactionType||r.type||'').toLowerCase(); if(counts[t]!=null) counts[t]++; });
                              Object.keys(counts).forEach(k=>{
                                const el=modal.querySelector('[data-count=&quot;'+k+'&quot;]'); if(el) el.textContent=counts[k];
                              });
                            }
                            // Cache user details per modal open
                            const userCache = modal._userCache || new Map();
                            modal._userCache = userCache;

                            function getAuthorId(r){
                              return r.authorId || r.userId || r.ownerId || (r.user && (r.user.id || r.user.user_id)) || (r.author && (r.author.id || r.author.user_id)) || null;
                            }

                            async function fetchUserOnce(id){
                              if(!id) return null;
                              // de-dupe concurrent fetches by caching the pending promise
                              if(userCache.has(id)){
                                const cached = userCache.get(id);
                                return cached && typeof cached.then === 'function' ? await cached : cached;
                              }
                              const pending = (async () => {
                                try{
                                  const res = await fetch('/api/users/' + encodeURIComponent(id), { credentials:'include' });
                                  if(!res.ok) return null;
                                  const u = await res.json();
                                  return u || null;
                                }catch(e){ return null; }
                              })();
                              userCache.set(id, pending);
                              const resolved = await pending;
                              userCache.set(id, resolved);
                              return resolved;
                            }

                            function normName(u){
                              return (u && (u.full_name || u.fullName || u.name || u.username)) || '·∫®n danh';
                            }
                            function normAvatar(u){
                              return (u && (u.avatar_url || u.avatarUrl || u.avatar)) || '/img/image1.png';
                            }
                            function normEmail(u){
                              return (u && (u.email || u.emailAddress || u.mail || u.contactEmail || u.user_email)) || '';
                            }

                            async function renderList(arr, filter){
                              const f = String(filter||'all').toLowerCase();
                              const data = f==='all' ? arr : arr.filter(r => String(r.reactionType||r.type||'').toLowerCase()===f);

                              // helper: copy to clipboard
                              async function copyToClipboard(text){
                                try{
                                  if(navigator.clipboard && window.isSecureContext){
                                    await navigator.clipboard.writeText(text);
                                  }else{
                                    const ta=document.createElement('textarea');
                                    ta.value=text;
                                    ta.style.position='fixed';
                                    ta.style.top='-9999px';
                                    document.body.appendChild(ta);
                                    ta.focus();
                                    ta.select();
                                    document.execCommand('copy');
                                    ta.remove();
                                  }
                                  return true;
                                }catch(e){ return false; }
                              }

                              listEl.innerHTML='';
                              if(data.length===0){
                                const empty=document.createElement('div');
                                empty.className='text-muted small text-center py-2';
                                empty.textContent='Ch∆∞a c√≥ c·∫£m x√∫c n√†o.';
                                listEl.appendChild(empty);
                                return;
                              }

                              // Prefetch unique authors
                              const uniqueIds = Array.from(new Set(data.map(getAuthorId).filter(Boolean)));
                              await Promise.all(uniqueIds.map(id => fetchUserOnce(id)));

                              // Render rows
                              data.forEach(r=>{
                                const u = userCache.get(getAuthorId(r));
                                const name = normName(u);
                                const avatar = normAvatar(u);
                                const email = normEmail(u);
                                const t = String(r.reactionType||r.type||'').toLowerCase();

                                const item=document.createElement('div');
                                item.className='list-group-item d-flex align-items-center gap-2';

                                const img=document.createElement('img');
                                img.src=avatar; img.alt=''; img.className='rounded-circle';
                                img.style.width='36px'; img.style.height='36px'; img.style.objectFit='cover';

                                const body=document.createElement('div');
                                body.className='flex-fill d-flex flex-column';
                                const nm=document.createElement('div');
                                nm.className='fw-semibold';
                                nm.textContent=name;

                                const meta=document.createElement('div');
                                meta.className='text-muted small';
                                meta.textContent=fmtTime(r.createdAt||r.created_at||r.created||null);

                                body.appendChild(nm);
                                if(email){
                                  const emRow=document.createElement('div');
                                  emRow.className='text-muted small d-flex align-items-center gap-2';
                                  const em=document.createElement('span');
                                  em.textContent=email;

                                  const copyBtn=document.createElement('button');
                                  copyBtn.type='button';
                                  copyBtn.className='btn btn-sm btn-outline-secondary py-0 px-2';
                                  copyBtn.title='Sao ch√©p email';
                                  copyBtn.innerHTML=`<i class='bi bi-clipboard'></i>`;

                                  copyBtn.addEventListener('click', async (ev)=>{
                                    ev.stopPropagation();
                                    const ok = await copyToClipboard(email);
                                    const prev = copyBtn.innerHTML;
                                    copyBtn.innerHTML = ok ? `<i class='bi bi-clipboard-check'></i>` : `<i class='bi bi-clipboard-x'></i>`;
                                    copyBtn.disabled = true;
                                    setTimeout(()=>{
                                      copyBtn.innerHTML = prev;
                                      copyBtn.disabled = false;
                                    }, 1200);
                                  });

                                  emRow.appendChild(em);
                                  emRow.appendChild(copyBtn);
                                  body.appendChild(emRow);
                                }
                                body.appendChild(meta);

                                const ico=document.createElement('div');
                                ico.className='ms-auto rx-ico';
                                ico.innerHTML=iconByType(t);

                                item.appendChild(img);
                                item.appendChild(body);
                                item.appendChild(ico);

                                listEl.appendChild(item);
                              });
                            }

                            if(!modal._bound){
                              tabsWrap.addEventListener('click', function(ev){
                                const btnTab = ev.target.closest('[data-filter]'); if(!btnTab) return;
                                tabsWrap.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
                                btnTab.classList.add('active');
                                const filter = btnTab.getAttribute('data-filter');
                                renderList(modal._dataReactions||[], filter);
                              });
                              modal._bound=true;
                            }

                            let arr=[];
                            try{
                              const res=await fetch('/api/posts/'+encodeURIComponent(postId)+'/reactions/all',{credentials:'include'});
                              arr = res.ok? await res.json() : [];
                              if(!Array.isArray(arr)) arr=[];
                            }catch(e){ arr=[]; }
                            modal._dataReactions = arr;

                            updateCounts(arr);
                            tabsWrap.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
                            const allTab=tabsWrap.querySelector('[data-filter=&quot;all&quot;]'); if(allTab) allTab.classList.add('active');
                            renderList(arr,'all');

                            bootstrap.Modal.getOrCreateInstance(modal).show();
                          }catch(e){ console.error(e); }
                        })(this)">
                    <span class="rx-ico most-reaction"></span>
                    <span class="rx-ico second-most-reaction"></span>
                    <span class="like-count">0</span>
                </button>

                <!-- Modal xem chi ti·∫øt reactions -->
                <div class="modal fade reactions-modal" tabindex="-1" aria-hidden="true" role="dialog">
                  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">C·∫£m x√∫c</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng" 
                            onclick="(function(){document.querySelector('.btn-reaction-summary').focus();}())"
                        ></button>
                      </div>
                      <div class="modal-body">
                        <ul class="nav nav-pills reaction-tabs gap-1 mb-3 flex-wrap">
                          <li class="nav-item">
                            <button type="button" class="nav-link active" data-filter="all">T·∫•t c·∫£
                              <span class="badge bg-secondary ms-1" data-count="all">0</span>
                            </button>
                          </li>
                          <li class="nav-item">
                            <button type="button" class="nav-link" data-filter="like">Th√≠ch
                              <span class="badge bg-secondary ms-1" data-count="like">0</span>
                            </button>
                          </li>
                          <li class="nav-item">
                            <button type="button" class="nav-link" data-filter="love">Y√™u th√≠ch
                              <span class="badge bg-secondary ms-1" data-count="love">0</span>
                            </button>
                          </li>
                          <li class="nav-item">
                            <button type="button" class="nav-link" data-filter="haha">Haha
                              <span class="badge bg-secondary ms-1" data-count="haha">0</span>
                            </button>
                          </li>
                          <li class="nav-item">
                            <button type="button" class="nav-link" data-filter="sad">Bu·ªìn
                              <span class="badge bg-secondary ms-1" data-count="sad">0</span>
                            </button>
                          </li>
                          <li class="nav-item">
                            <button type="button" class="nav-link" data-filter="angry">Ph·∫´n n·ªô
                              <span class="badge bg-secondary ms-1" data-count="angry">0</span>
                            </button>
                          </li>
                        </ul>
                        <div class="list-group reactions-list"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <style>
                  /* Facebook-like compact stats row */
                  #post-info-reactions-and-comments{
                    display:flex;align-items:center;justify-content:space-between;gap:12px;
                    padding:.25rem 0;border:0;margin:0;
                  }
                  #post-info-reactions-and-comments .btn-reaction-summary:hover{ text-decoration:underline; color:#050505; }
                  #post-info-reactions-and-comments .rx-ico{
                    width:18px;height:18px;border-radius:50%;
                    display:inline-flex;align-items:center;justify-content:center;
                    background:#fff;border:1px solid #e4e6eb;box-shadow:0 1px 1px rgba(0,0,0,.08);
                    font-size:12px; margin-left:-6px;
                  }
                  #post-info-reactions-and-comments .rx-ico:first-child{ margin-left:0; }
                  #post-info-reactions-and-comments .like-count{ margin-left:4px; color:#65676b; }

                  /* Modal ‚Äî closer to FB pills/list */
                  .reactions-modal .nav-link{
                    display:inline-flex;align-items:center;gap:6px;border-radius:20px;
                    background:#f0f2f5;color:#050505;
                  }
                  .reactions-modal .nav-link.active{ background:#e7f3ff;color:#1b74e4; }
                  .reactions-modal .list-group-item{ border:0;padding:.5rem .25rem; }
                  .reactions-modal .rx-ico{
                    width:20px;height:20px;border-radius:50%;
                    display:inline-flex;align-items:center;justify-content:center;
                    background:#fff;border:1px solid #e4e6eb;box-shadow:0 1px 1px rgba(0,0,0,.08);
                    font-size:12px;
                  }
                </style>

                <!-- N√∫t hi·ªÉn th·ªã s·ªë comment -->
                <button type="button" class="btn-comment-summary" aria-label="Xem b√¨nh lu·∫≠n"
                  style="background:transparent;border:0;padding:0;color:#65676b;font-weight:500;font-size:.9rem;line-height:1;text-transform:none;box-shadow:none;"
                  onclick="(function(btn){
                  try{
                    var article = btn.closest('article'); if(!article) return;
                    var modal = article.querySelector('.comments-modal'); 
                    if(modal){
                    if(article._loadComments) article._loadComments();
                    var inst = bootstrap.Modal.getOrCreateInstance(modal);
                    inst.show();
                    setTimeout(function(){
                      var input = article.querySelector('.modal-comment-input');
                      if(input) input.focus();
                    }, 200);
                    }
                  }catch(e){}
                  })(this)">
                  <span class="ico"><i class="bi bi-chat-dots"></i></span>
                  <span class="txt">B√¨nh lu·∫≠n</span>
                  <span class="count comment-count">0</span>
                </button>

                <!-- T·∫£i s·ªë b√¨nh lu·∫≠n ban ƒë·∫ßu -->
                <script>
                  (function(){
                  try{
                    var sc = document.currentScript;
                    var article = sc;
                    while(article && article.tagName !== 'ARTICLE'){ article = article.parentElement; }
                    if(!article) return;

                    var countEl = article.querySelector('.comment-count');
                    if(!countEl) return;

                    async function setCount(n){
                    countEl.textContent = Number(n||0);
                    }

                    async function fetchInitialCount(postId){
                    //  t·∫£i danh s√°ch v√† ƒë·∫øm
                    try{
                      var r2 = await fetch('/api/posts/'+encodeURIComponent(postId)+'/comments', { credentials:'include' });
                      if(r2.ok){
                      var d = await r2.json();
                      if(Array.isArray(d)){ setCount(d.length); return; }
                      if(d && typeof d.totalElements === 'number'){ setCount(d.totalElements); return; }
                      if(d && Array.isArray(d.content)){ setCount(d.content.length); return; }
                      }
                    }catch(_){}
                    setCount(0);
                    }

                    function init(){
                    if(article._commentCountLoaded) return;
                    var postId = article.dataset.postId;
                    if(!postId){ setTimeout(init, 50); return; }
                    article._commentCountLoaded = true;
                    fetchInitialCount(postId);
                    }

                    init();
                  }catch(_){}
                  })();
                </script>

              </div>



              <div class="pc-actions">
                <!-- ReactionsComposer:BEGIN -->
                <div class="reaction-composer" style="position:relative;flex:1;display:flex;align-items:stretch;"
                     onmouseenter="(function(w){
                        try{
                          clearTimeout(w._hideTo);
                          var pop=w.querySelector('.react-popover');

                          // ensure we cancel delayed show when leaving wrapper
                          if(!w._boundLeave){
                            w.addEventListener('mouseleave', function(){
                              try{ clearTimeout(w._showTo); }catch(e){}
                            });
                            w._boundLeave=1;
                          }

                          if(pop){
                            // delay 200ms before showing
                            clearTimeout(w._showTo);
                            w._showTo=setTimeout(function(){
                              pop.style.display='flex';

                              if(!pop._bound){
                                pop.addEventListener('mouseenter', function(){
                                  try{ clearTimeout(w._hideTo); clearTimeout(w._showTo);}catch(e){}
                                  this.style.display='flex';
                                });
                                pop.addEventListener('mouseleave', function(){
                                  try{ clearTimeout(w._hideTo); clearTimeout(w._showTo);}catch(e){}
                                  w._hideTo=setTimeout(()=>{ this.style.display='none'; }, 300);
                                });
                                pop._bound=1;
                              }

                              if(window.QDTReactions) window.QDTReactions.ensureLoaded(w);
                            }, 200);
                          }
                        }catch(e){}
                     })(this)"
                     onmouseleave="(function(w){
                        try{
                          clearTimeout(w._hideTo);
                          var pop=w.querySelector('.react-popover');
                          w._hideTo=setTimeout(function(){ if(pop) pop.style.display='none'; }, 300);
                        }catch(e){}
                     })(this)">

                  <!-- Main Reaction Button (quick Like toggle) -->
                  <button type="button" class="act-btn btn-like" data-active="0" data-reaction=""
                          onclick="(function(btn){
                            // N·∫øu ƒë√£ c√≥ reaction r·ªìi th√¨ b·ªè reaction
                            try{
                                const article=btn.closest('article'); if(!article) return;
                                const currentType=(article.getAttribute('data-my-reaction')||'').toLowerCase();
                                if(currentType){
                                    const currentId=(article.getAttribute('data-my-reaction-id')||'');
                                    if(currentId){
                                        console.log('Removing reaction:', currentId);
                                        fetch('/api/posts/'+encodeURIComponent(article.dataset.postId)+'/reactions/'+encodeURIComponent(currentId),{
                                            method:'DELETE',credentials:'include'
                                        }).then(res=>{
                                            if(res.ok){
                                                if(window.QDTReactions) window.QDTReactions.ensureLoaded(btn.closest('.reaction-composer'));
                                            }
                                        }).catch(()=>{});
                                    }
                                    // C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
                                    if(window.QDTReactions) window.QDTReactions.toggleLike(btn.closest('.reaction-composer'));

                                    return;
                                }
                            }catch(e){}

                            try{
                              if(event){event.stopPropagation(); if(event.stopImmediatePropagation) event.stopImmediatePropagation();}
                              if(window.QDTReactions) window.QDTReactions.toggleLike(btn.closest('.reaction-composer'));
                            }catch(e){}
                          })(this)">
                    <span class="ico"><i class="bi bi-hand-thumbs-up"></i></span>
                    <span class="txt">Th√≠ch</span>
                </button>

                  <!-- Reaction Popover -->
                    <style>
                    .qdt-react-pop{
                      display:none;position:absolute;bottom:110%;left:0;
                      background:linear-gradient(180deg,#ffffffaa,#fffffff0);
                      border:1px solid rgba(120,150,190,.35);
                      box-shadow:0 10px 28px rgba(30,70,140,.18), inset 0 1px 0 rgba(255,255,255,.9);
                      border-radius:999px;padding:8px 10px;gap:8px;z-index:20;
                      align-items:center;justify-content:center;
                      backdrop-filter:saturate(140%) blur(6px); -webkit-backdrop-filter:saturate(140%) blur(6px);
                      animation:qdt-pop-in .16s cubic-bezier(.2,.9,.2,1);
                    }
                    .qdt-react-pop .rx-btn{
                      width:44px;height:44px;border-radius:50%;
                      border:1px solid rgba(120,150,190,.35);
                      background:linear-gradient(180deg,#f7fbff,#eef5ff);
                      font-size:22px;line-height:1;display:flex;align-items:center;justify-content:center;
                      box-shadow:0 4px 10px rgba(30,70,140,.18), inset 0 1px 0 rgba(255,255,255,.9);
                      transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
                      cursor:pointer;
                    }
                    .qdt-react-pop .rx-btn:hover{
                      transform:translateY(-2px) scale(1.08);
                      box-shadow:0 10px 18px rgba(30,70,140,.25), inset 0 1px 0 rgba(255,255,255,.95);
                      filter:saturate(1.1);
                    }
                    .qdt-react-pop .rx-btn:active{ transform:translateY(0) scale(.96); }
                    .qdt-react-pop .rx-like{ background:linear-gradient(180deg,#e7f3ff,#f2f8ff); border-color:#b9d7ff; color:#1b74e4; }
                    .qdt-react-pop .rx-love{ background:linear-gradient(180deg,#fff0f2,#ffe5ea); border-color:#ffc2cc; }
                    .qdt-react-pop .rx-haha{ background:linear-gradient(180deg,#fff8e1,#fff2bf); border-color:#ffe29a; }
                    .qdt-react-pop .rx-sad{  background:linear-gradient(180deg,#eaf5ff,#dff0ff); border-color:#bcdcff; }
                    .qdt-react-pop .rx-angry{background:linear-gradient(180deg,#ffe8e5,#ffd9d3); border-color:#ffc2b8; }
                    .qdt-react-pop .rx-arrow{
                      position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);
                      width:14px;height:14px;background:#fffffff0;border:1px solid rgba(120,150,190,.35);
                      border-top:none;border-left:none;transform:translateX(-50%) rotate(45deg);
                      box-shadow:2px 2px 10px rgba(30,70,140,.15);
                    }
                    /* @keyframes qdt-pop-in{
                      0%{ transform:translateX(-50%) translateY(6px) scale(.96); opacity:0; }
                      100%{ transform:translateX(-50%) translateY(0)  scale(1);    opacity:1; }
                    } */
                    </style>

                    <div class="react-popover qdt-react-pop" role="group" aria-label="Ch·ªçn c·∫£m x√∫c">
                    <!-- <span class="rx-arrow" aria-hidden="true"></span> -->

                    <!-- like -->
                    <button type="button" class="rx-btn rx-like" title="Th√≠ch"
                        onclick="(function(opt){ if(window.QDTReactions) window.QDTReactions.setReaction(opt.closest('.reaction-composer'),'like'); })(this)">üëç</button>

                    <!-- love -->
                    <button type="button" class="rx-btn rx-love" title="Y√™u th√≠ch"
                        onclick="(function(opt){ if(window.QDTReactions) window.QDTReactions.setReaction(opt.closest('.reaction-composer'),'love'); })(this)">
                      <i class="bi bi-heart-fill text-danger"></i>
                    </button>

                    <!-- haha -->
                    <button type="button" class="rx-btn rx-haha" title="Haha"
                        onclick="(function(opt){ if(window.QDTReactions) window.QDTReactions.setReaction(opt.closest('.reaction-composer'),'haha'); })(this)">üòÜ</button>

                    <!-- sad -->
                    <button type="button" class="rx-btn rx-sad" title="Bu·ªìn"
                        onclick="(function(opt){ if(window.QDTReactions) window.QDTReactions.setReaction(opt.closest('.reaction-composer'),'sad'); })(this)">üò¢</button>

                    <!-- angry -->
                    <button type="button" class="rx-btn rx-angry" title="Ph·∫´n n·ªô"
                        onclick="(function(opt){ if(window.QDTReactions) window.QDTReactions.setReaction(opt.closest('.reaction-composer'),'angry'); })(this)">üò°</button>
                    </div>
                </div>

                <script>
                (function(){
                    if(window.QDTReactions) return;

                    function iconByType(t){
                        t=String(t||'').toLowerCase();
                        if(t==='love') return '<i class="bi bi-heart-fill text-danger"></i>';
                        if(t==='haha') return 'üòÜ';
                        if(t==='sad')  return 'üò¢';
                        if(t==='angry')return 'üò°';
                        return '<i class="bi bi-hand-thumbs-up"></i>';
                    } 

                    function labelByType(t){
                        t=String(t||'').toLowerCase();
                        if(t==='love') return 'Y√™u th√≠ch';
                        if(t==='haha') return 'Haha';
                        if(t==='sad')  return 'Bu·ªìn';
                        if(t==='angry')return 'Ph·∫´n n·ªô';
                        return 'Th√≠ch';
                    }

                    async function fetchAll(postId){
                        try{
                            const r=await fetch('/api/posts/'+encodeURIComponent(postId)+'/reactions/all',{credentials:'include'});
                            if(!r.ok) return [];
                            const data=await r.json();
                            return Array.isArray(data)?data:[];
                        }catch(e){return [];}
                    }

                    function getMine(arr){
                        const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                        const meId=auth.user_id;
                        return arr.find(it=>
                            (it&&it.authorId&&meId!=null&&(String(it.authorId)===String(meId)))||
                            it.mine===true||it.ownedByRequester===true
                        )||null;
                    }

                    function updateUI(wrap, mine, total, arr=null){
                        const article=wrap.closest('article'); if(!article) return;
                        const btn=wrap.querySelector('.btn-like');
                        const countEl=wrap.querySelector('.like-count');
                        if(countEl) countEl.textContent = Number(total||0);
                        const t = mine?(mine.reactionType||''):'';
                        const id = mine?(mine.id||''):'';
                        article.setAttribute('data-my-reaction', t||'');
                        article.setAttribute('data-my-reaction-id', id||'');
                        if(btn){
                            btn.dataset.active = t? '1':'0';
                            btn.setAttribute('data-reaction', t||'');
                            const txt=btn.querySelector('.txt'); if(txt) txt.textContent = t? labelByType(t) : 'Th√≠ch';
                            const ico=btn.querySelector('.ico'); if(ico) ico.innerHTML = iconByType(t);
                        }

                        // C·∫≠p nh·∫≠t ph·∫ßn hi·ªÉn th·ªã t·ªïng h·ª£p reactions
                        console.log('Updating reactions');
                        const infoWrap = article.querySelector('#post-info-reactions-and-comments');
                        if(infoWrap){
                            const likeCountEl = infoWrap.querySelector('.like-count');
                            const mostReactionEl = infoWrap.querySelector('.most-reaction');
                            const secondMostReactionEl = infoWrap.querySelector('.second-most-reaction');

                            // ƒê·∫øm s·ªë l∆∞·ª£ng t·ª´ng lo·∫°i reaction
                            const reactionCounts = {};
                            (arr||[]).forEach(r => {
                                const type = (r.reactionType || '').toLowerCase();
                                if(type){
                                    reactionCounts[type] = (reactionCounts[type] || 0) + 1;
                                }
                            });

                            // S·∫Øp x·∫øp c√°c lo·∫°i reaction theo s·ªë l∆∞·ª£ng gi·∫£m d·∫ßn
                            const sortedReactions = Object.entries(reactionCounts)
                                .sort((a, b) => b[1] - a[1]);

                            // C·∫≠p nh·∫≠t giao di·ªán
                            // N·∫øu b·∫°n ƒë√£ reaction, hi·ªÉn th·ªã "b·∫°n v√† x ng∆∞·ªùi kh√°c"
                            if(mine && total > 1){
                                if(likeCountEl) likeCountEl.textContent = "B·∫°n v√† " + (total - 1) + ' ng∆∞·ªùi kh√°c';
                            } else if(mine && total === 1){
                                if(likeCountEl) likeCountEl.textContent = 'B·∫°n';
                            } else {
                                if(likeCountEl) likeCountEl.textContent = total > 0 ? total : 'Ch∆∞a c√≥ reaction n√†o...';
                            }
                            if(mostReactionEl) mostReactionEl.innerHTML = sortedReactions[0] ? iconByType(sortedReactions[0][0]) : '<i class="bi bi-plus"></i>';
                            if(secondMostReactionEl) secondMostReactionEl.innerHTML = sortedReactions[1] ? iconByType(sortedReactions[1][0]) : '‚ãØ';
                        }
                    }

                    async function refresh(wrap){
                        const article=wrap.closest('article'); if(!article) return;
                        const postId=article.dataset.postId; if(!postId) return;
                        const arr = await fetchAll(postId);
                        updateUI(wrap, getMine(arr), arr.length, arr);
                        wrap.dataset.loaded='1';
                    }

                    async function setReaction(wrap, type){
                        const article=wrap.closest('article'); if(!article) return;
                        const postId=article.dataset.postId; if(!postId) return;
                        const currentType=(article.getAttribute('data-my-reaction')||'').toLowerCase();
                        const currentId=(article.getAttribute('data-my-reaction-id')||'');

                        const body={type:String(type||'').toLowerCase()};
                        const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                        if(auth&&auth.user_id){
                            body.user={ id : auth.user_id };
                        }
                        await fetch('/api/posts/'+encodeURIComponent(postId)+'/reactions',{
                            method:'POST',credentials:'include',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify(body)
                        }).catch(()=>{});
                        await refresh(wrap);
                        const pop=wrap.querySelector('.react-popover'); if(pop) pop.style.display='none';
                    }

                    async function toggleLike(wrap){
                        const article=wrap.closest('article'); if(!article) return;
                        const currentType=(article.getAttribute('data-my-reaction')||'').toLowerCase();
                        if(currentType==='like') return setReaction(wrap,'like'); // will remove
                        return setReaction(wrap,'like'); // will set to like
                    }

                    function ensureLoaded(wrap){
                        if(!wrap || wrap.dataset.loaded==='1') return;
                        refresh(wrap);
                    }

                    function autoInit(){
                        document.querySelectorAll('.reaction-composer').forEach(w=>ensureLoaded(w));
                    }

                    window.QDTReactions={ensureLoaded, setReaction, toggleLike};
                    if(document.readyState!=='loading'){ setTimeout(autoInit,0); }
                    else { document.addEventListener('DOMContentLoaded', autoInit); }
                    // try{
                    //     const mo=new MutationObserver(()=>autoInit());
                    //     mo.observe(document.documentElement,{childList:true,subtree:true});
                    // }catch(e){}
                })();
                </script>
                <!-- ReactionsComposer:END -->


                <!-- Comments -->
                <button type="button" class="act-btn btn-comment">
                    <span class="ico"><i class="bi bi-chat-dots"></i></span>
                    <span class="txt">B√¨nh lu·∫≠n</span>
                </button>
                <!-- Share -->
                <button type="button" class="act-btn">
                    <span class="ico"><i class="bi bi-share"></i></span>
                    <span class="txt">Chia s·∫ª</span>
                </button>

              </div>

              <!-- Hidden footer to keep existing JS safe, but open modal instead -->
              <div class="pc-footer d-none">
                <input type="text"
                       class="form-control form-control-sm cm-input"
                       placeholder="Vi·∫øt b√¨nh lu·∫≠n..."
                       style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;"
                       onfocus="(function(inp){
                         try{
                           var article = inp.closest('article');
                           var modal = article.querySelector('.comments-modal');
                           if(modal){ bootstrap.Modal.getOrCreateInstance(modal).show(); }
                           var f = inp.closest('.pc-footer'); if(f) f.classList.add('d-none');
                         }catch(e){}
                       })(this)">
              </div>

                <!-- Comments Modal:BEGIN -->
                <div class="modal fade comments-modal" tabindex="-1" aria-hidden="true" role="dialog">
                  <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title">B√¨nh lu·∫≠n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                    </div>
                    <div class="modal-body">
                    <div class="list-group comments-list">
                      <div class="text-muted small text-center py-2">Ch∆∞a c√≥ b√¨nh lu·∫≠n.</div>
                    </div>
                    <div class="mt-3 d-flex gap-2">
                      <input type="text" class="form-control modal-comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
                      <button type="button" class="btn btn-primary"
                          onclick="(async function(btn){
                          try{
                            var article = btn.closest('article'); if(!article) return;
                            var postId = article.dataset.postId; if(!postId) return;
                            var input = article.querySelector('.modal-comment-input');
                            var text = (input && input.value || '').trim();
                            if(!text) return;

                            var auth = {};
                            try{ auth = JSON.parse(localStorage.getItem('auth')||'{}'); }catch(e){}
                            var uid = auth && (auth.user_id || auth.id || auth.userId);
                            var body = { content: text };
                            if(uid!=null) body.user = { id: uid };

                            const res = await fetch('/api/posts/'+encodeURIComponent(postId)+'/comments',{
                              method:'POST',
                              credentials:'include',
                              headers:{'Content-Type':'application/json'},
                              body: JSON.stringify(body)
                            });
                            if(res.ok){
                            input.value='';
                            if(article._loadComments) await article._loadComments();
                            }
                          }catch(e){}
                          })(this)">
                      G·ª≠i
                      </button>
                    </div>
                    </div>
                  </div>
                  </div>
                </div>
                

                <script>
                (function(){
                  try{
                  var script = document.currentScript;
                  var article = script;
                  while(article && article.tagName !== 'ARTICLE'){ article = article.parentElement; }
                  if(!article) return;

                  var modal = article.querySelector('.comments-modal');
                  if(!modal) return;

                  var listEl = modal.querySelector('.comments-list');

                  // cache user details per-article to avoid refetching
                  var userCache = article._userCache || new Map();
                  article._userCache = userCache;

                  function normName(u){
                    return (u && (u.full_name || u.fullName || u.name || u.username)) || '·∫®n danh';
                  }
                  function normAvatar(u){
                    return (u && (u.avatar_url || u.avatarUrl || u.avatar)) || '/img/image1.png';
                  }
                  function normEmail(u){
                    return (u && (u.email || u.emailAddress)) || '';
                  }

                  function getUserIdFromComment(c){
                    return (c.authorId) || null;
                  }

                  async function fetchUserOnce(id){
                    if(!id) return null;
                    if(userCache.has(id)){
                    const cached = userCache.get(id);
                    return cached && typeof cached.then === 'function' ? await cached : cached;
                    }
                    const pending = (async () => {
                    try{
                      // Use same-origin relative API; JSESSIONID is sent via credentials: 'include'
                      const res = await fetch('/api/users/' + encodeURIComponent(id), { credentials:'include' });
                      if(!res.ok) return null;
                      const u = await res.json();
                      return u || null;
                    }catch(e){ return null; }
                    })();
                    userCache.set(id, pending);
                    const resolved = await pending;
                    userCache.set(id, resolved);
                    return resolved;
                  }

                  async function copyToClipboard(text){
                    try{
                    if(navigator.clipboard && window.isSecureContext){
                      await navigator.clipboard.writeText(text);
                    }else{
                      const ta=document.createElement('textarea');
                      ta.value=text;
                      ta.style.position='fixed';
                      ta.style.top='-9999px';
                      document.body.appendChild(ta);
                      ta.focus(); ta.select();
                      document.execCommand('copy');
                      ta.remove();
                    }
                    return true;
                    }catch(e){ return false; }
                  }

                  function formatRelativeTime(ts){
                    if(!ts) return '';
                    var d=new Date(ts);
                    if(isNaN(d)) return '';
                    var diff=(Date.now()-d.getTime())/1000;
                    if(diff<60) return 'V·ª´a xong';
                    if(diff<3600) return Math.floor(diff/60)+' ph√∫t';
                    if(diff<86400) return Math.floor(diff/3600)+' gi·ªù';
                    if(diff<172800) return 'H√¥m qua';
                    return d.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'});
                  }

                    async function renderComments(arr){
                    listEl.innerHTML = '';
                    if(!arr || arr.length===0){
                      listEl.innerHTML = '<div class="text-muted small text-center py-2">Ch∆∞a c√≥ b√¨nh lu·∫≠n.</div>';
                      return;
                    }

                    // Prefetch unique user details using /api/users/{id}
                    const uniqueIds = Array.from(new Set(arr.map(getUserIdFromComment).filter(Boolean)));
                    if(uniqueIds.length){
                      await Promise.all(uniqueIds.map(id => fetchUserOnce(id)));
                    }

                    // Sort comments by time (oldest -> newest) for natural reading flow
                    const ts = c => new Date(c.created_at || c.createdAt || c.created || 0).getTime();
                    arr = arr.slice().sort((a,b)=> ts(a) - ts(b));

                    arr.forEach(function(c){
                      const fallbackUser = c.user || c.author || {};
                      const uid = getUserIdFromComment(c);
                      const u = (uid && userCache.get(uid)) || fallbackUser;

                      const name = normName(u);
                      const avatar = normAvatar(u);
                      const email = normEmail(u);
                      const content = c.content || c.text || '';
                      const created = c.created_at || c.createdAt || c.created || null;

                      // Item wrapper (no default list-group borders/paddings)
                      const item = document.createElement('div');
                      item.className = 'list-group-item border-0 bg-transparent p-0';
                      item.style.marginBottom = '6px';

                      // Row layout
                      const row = document.createElement('div');
                      row.className = 'd-flex align-items-start gap-2 py-2';

                      // Avatar
                      const img = document.createElement('img');
                      img.src = avatar; img.alt=''; img.className='rounded-circle';
                      img.style.width='40px'; img.style.height='40px'; img.style.objectFit='cover';
                      img.style.boxShadow='0 2px 6px rgba(0,0,0,.15)';
                      if(email) img.title = email;

                      // Bubble
                      const bubble = document.createElement('div');
                      bubble.className = 'flex-fill';
                      bubble.style.background = '#f7f9fc';
                      bubble.style.border = '1px solid rgba(120,150,190,.30)';
                      bubble.style.borderRadius = '12px';
                      bubble.style.padding = '.5rem .75rem';
                      bubble.style.minWidth = '0';

                      // Header (name + email on left, time on right)
                      const header = document.createElement('div');
                      header.className = 'd-flex align-items-center justify-content-between gap-2 flex-wrap';

                      const left = document.createElement('div');
                      left.className = 'd-flex align-items-center gap-2 flex-wrap';

                      const nameSpan = document.createElement('span');
                      nameSpan.textContent = name;
                      nameSpan.style.fontWeight = '600';
                      nameSpan.style.color = '#2a3542';
                      left.appendChild(nameSpan);

                      if(email){
                      const emailWrap = document.createElement('span');
                      emailWrap.className = 'text-muted small d-inline-flex align-items-center gap-1';
                      emailWrap.style.whiteSpace = 'nowrap';

                      const emailSpan = document.createElement('span');
                      emailSpan.textContent = email;
                      emailSpan.style.maxWidth = '220px';
                      emailSpan.style.overflow = 'hidden';
                      emailSpan.style.textOverflow = 'ellipsis';

                      const copyBtn = document.createElement('button');
                      copyBtn.type='button';
                      copyBtn.className='btn btn-sm btn-outline-secondary py-0 px-2';
                      copyBtn.title='Sao ch√©p email';
                      copyBtn.innerHTML = "<i class='bi bi-clipboard'></i>";
                      copyBtn.addEventListener('click', async function(ev){
                        ev.stopPropagation();
                        const ok = await copyToClipboard(email);
                        const prev = copyBtn.innerHTML;
                        copyBtn.innerHTML = ok ? "<i class='bi bi-clipboard-check'></i>" : "<i class='bi bi-clipboard-x'></i>";
                        copyBtn.disabled = true;
                        setTimeout(function(){
                        copyBtn.innerHTML = prev;
                        copyBtn.disabled = false;
                        }, 1200);
                      });

                      emailWrap.appendChild(emailSpan);
                      emailWrap.appendChild(copyBtn);
                      left.appendChild(emailWrap);
                      }

                      const timeEl = document.createElement('small');
                      timeEl.className = 'text-muted';
                      timeEl.textContent = formatRelativeTime(created);

                      header.appendChild(left);
                      header.appendChild(timeEl);

                      // Content
                      const contentRow = document.createElement('div');
                      contentRow.textContent = content;
                      contentRow.style.whiteSpace = 'pre-wrap';
                      contentRow.style.marginTop = '4px';
                      contentRow.style.lineHeight = '1.45';
                      contentRow.style.color = '#2a3542';

                      // Mount
                      bubble.appendChild(header);
                      bubble.appendChild(contentRow);
                      row.appendChild(img);
                      row.appendChild(bubble);
                      item.appendChild(row);
                      listEl.appendChild(item);
                    });
                    }

                  async function loadComments(){
                    var postId = article.dataset.postId;
                    if(!postId) return;
                    try{
                    listEl.innerHTML = '<div class="text-center text-muted small py-2">ƒêang t·∫£i b√¨nh lu·∫≠n...</div>';
                    var res = await fetch('/api/posts/'+encodeURIComponent(postId)+'/comments', { credentials:'include' });
                    var arr = res.ok ? await res.json() : [];
                    if(!Array.isArray(arr)) arr = [];
                    await renderComments(arr);
                    var count = arr.length;
                    article.querySelectorAll('.comment-count').forEach(function(el){ el.textContent = count; });
                    }catch(e){
                    listEl.innerHTML = '<div class="text-muted small text-center py-2">T·∫£i b√¨nh lu·∫≠n th·∫•t b·∫°i.</div>';
                    }
                  }

                  // expose to inline "G·ª≠i" handler
                  article._loadComments = loadComments;

                  // load when modal is shown
                  modal.addEventListener('shown.bs.modal', function(){ loadComments(); });

                  // optional: submit on Enter in input
                  var input = article.querySelector('.modal-comment-input');
                  if(input){
                    input.addEventListener('keydown', function(e){
                    if(e.key === 'Enter'){
                      e.preventDefault();
                      var btn = article.querySelector('.btn.btn-primary');
                      if(btn) btn.click();
                    }
                    });
                  }
                  }catch(e){}
                })();
                </script>
                <!-- Comments Modal:END -->

          </article>
      </template>

      <style>
      .post-feed{display:flex;flex-direction:column;gap:20px;}
      .post-card{
          position:relative;
          background:linear-gradient(150deg,#ffffff,#f4f7fa 55%,#ebf2fa);
          border:1px solid rgba(120,150,190,.35);
          border-radius:22px;
          padding:1rem 1rem .5rem;
          box-shadow:0 8px 26px -10px rgba(30,70,140,.25),0 3px 8px -4px rgba(30,70,140,.18),inset 0 1px 0 rgba(255,255,255,.9);
          overflow:hidden;
          /* animation:pcFade .45s cubic-bezier(.4,.65,.25,1); */
          /* height limit */
          --pc-max-h:600px;
          display:flex;
          flex-direction:column;
          max-height:var(--pc-max-h);
      }
      /* Scrollable body (header + actions + footer stay visible) */
      .post-card .pc-body{
          flex:1 1 auto;
          /* allow the body itself to scroll while keeping header/actions fixed */
          overflow:auto;
          scrollbar-width:thin;
          scrollbar-color:#b8c6d6 transparent;
          padding-right:.35rem;
      }

      /* KEEP MEDIA RATIO (no cropping / stretching) */
      .post-card .pc-body .post-media figure{
          position:relative;
          margin:0;
      }
      .post-card .pc-body .post-media img,
      .post-card .pc-body .post-media video{
          object-fit:contain;   /* show whole media without cropping */
          display:block;
          background:#000;      /* letterbox background for videos / wide images */
          border-radius:14px;
      }

      /* If a grid cell had a forced height from previous rules, let media inside adapt */
      .post-card .pc-body .post-media figure > *{
          max-height:100%;
      }
      .post-card .pc-body::-webkit-scrollbar{width:8px;}
      .post-card .pc-body::-webkit-scrollbar-track{background:transparent;}
      .post-card .pc-body::-webkit-scrollbar-thumb{
          background:linear-gradient(#9fb6cc,#6d8fb2);
          border-radius:20px;
      }
      .post-card .pc-body:after{
          content:"";
          position:sticky;
          bottom:0;left:0;right:0;
          height:28px;
          pointer-events:none;
          background:linear-gradient(to bottom,rgba(255,255,255,0),#fff 70%);
          display:block;
          margin-top:-28px;
      }
      @media (prefers-color-scheme:dark){
          .post-card .pc-body:after{
              background:linear-gradient(to bottom,rgba(34,42,52,0),#1b222c 70%);
          }
      }
      /* @keyframes pcFade{0%{transform:translateY(10px);opacity:0}100%{transform:translateY(0);opacity:1}} */
      .post-card:before{
          content:"";
          position:absolute;inset:0;
          background:
            radial-gradient(circle at 85% 15%,rgba(27,116,228,.12),transparent 60%),
            radial-gradient(circle at 12% 85%,rgba(90,162,255,.12),transparent 65%);
          pointer-events:none;
          mix-blend-mode:overlay;
      }
      /* .post-card:hover{transform:translateY(-3px);box-shadow:0 14px 40px -12px rgba(30,70,140,.35),0 6px 16px -6px rgba(30,70,140,.25),inset 0 1px 0 rgba(255,255,255,.9);} */
      .pc-head{display:flex;align-items:center;margin-bottom:.65rem;flex:0 0 auto;}
      .pc-author{display:flex;align-items:center;gap:.75rem;}
      .pc-av-wrap{position:relative;width:52px;height:52px;border-radius:18px;padding:2px;background:linear-gradient(135deg,#1b74e4,#6aa8ff);}
      .pc-avatar{width:100%;height:100%;border-radius:16px;object-fit:cover;display:block;box-shadow:0 4px 10px -4px rgba(0,0,0,.35);}
      .pc-author-text{line-height:1.15;}
      .pc-name{font-weight:600;font-size:.95rem;}
      .pc-meta{font-size:.65rem;letter-spacing:.5px;display:flex;align-items:center;text-transform:uppercase;font-weight:600;opacity:.65;}
      .pc-dot{width:4px;height:4px;border-radius:50%;background:currentColor;margin:0 6px;}
      .pc-menu{
          margin-left:auto;
          background:linear-gradient(135deg,#f2f7ff,#e5eefb);
          border:1px solid rgba(120,150,190,.35);
          width:38px;height:38px;border-radius:14px;
          display:flex;align-items:center;justify-content:center;
          color:#365372;box-shadow:0 3px 8px -4px rgba(30,70,140,.25),inset 0 1px 0 rgba(255,255,255,.9);
          transition:.35s;
      }
      /* .pc-menu:hover{transform:translateY(-3px);color:#1b74e4;border-color:rgba(27,116,228,.55);} */
      .pc-body{font-size:.95rem;color:#2a3542;padding:0 .15rem;}
      .post-content{white-space:pre-wrap;margin-bottom:.75rem;line-height:1.45;font-weight:500;}
      .post-media{border-radius:18px;overflow:hidden;display:grid;gap:6px;margin-bottom:.6rem;}
      .pm-grid{--c:1;}
      .pm-grid.img-2{--c:2;}
      .pm-grid.img-3{--c:2;}
      .pm-grid.img-4{--c:2;}
      .pm-grid>figure,.pm-grid img,.pm-grid video{width:100%;height:100%;object-fit:cover;display:block;}
      .pm-grid{grid-template-columns:repeat(var(--c),1fr);}
      .pm-grid img,.pm-grid video{border-radius:14px;box-shadow:0 4px 12px -4px rgba(0,0,0,.25);}
      .pm-grid.img-3> :first-child{grid-column:span 2;height:320px;}
      .pm-grid.img-4> :nth-child(1){grid-row:span 2;}
      .pm-grid.img-4> :nth-child(1){height:100%;}
      .pc-actions{
          display:flex;gap:8px;
          padding:.55rem .35rem .35rem;
          border-top:1px solid rgba(120,150,190,.25);
          margin:0 -.15rem;
          flex:0 0 auto;
      }
      .act-btn{
          flex:1;
          position:relative;
          border:1px solid rgba(120,150,190,.35);
          background:linear-gradient(135deg,#f2f7ff,#e5eefb);
          color:#2a3542;
          font-weight:600;font-size:.7rem;letter-spacing:.6px;
          padding:.55rem .55rem;
          text-transform:uppercase;
          border-radius:14px;
          display:flex;align-items:center;justify-content:center;
          gap:6px;
          box-shadow:0 2px 6px -3px rgba(30,70,140,.35),inset 0 1px 0 rgba(255,255,255,.9);
          transition:.45s cubic-bezier(.6,.2,.2,1);
          overflow:hidden;
      }
      .act-btn .ico{display:flex;}
      .act-btn .count{
          background:#1b74e4;
          color:#fff;
          padding:0 6px;
          border-radius:10px;
          font-size:.6rem;
          font-weight:600;
          letter-spacing:0;
      }
      /* .act-btn:hover{transform:translateY(-3px);border-color:rgba(27,116,228,.55);color:#1b74e4;} */
      /* .act-btn:active{transform:translateY(-1px) scale(.95);} */
      .act-btn[data-active="1"]{
          background:linear-gradient(135deg,#1b74e4,#559dff);
          color:#fff;
          border-color:#1b74e4;
      }
      .act-btn[data-active="1"] .count{background:rgba(255,255,255,.25);}
      .pc-footer{padding:.55rem 0 0;flex:0 0 auto;}
      .comment-box{position:relative;}
      .cm-input{
          background:#f0f4f9;
          border:1px solid rgba(120,150,190,.35);
          border-radius:18px;
          padding:.55rem .9rem;
          font-size:.75rem;
      }
      .cm-input:focus{background:#e8eef5;box-shadow:none;border-color:#1b74e4;}
      /* Skeleton */
      .post-skeleton{
          height:180px;
          border-radius:22px;
          background:
            linear-gradient(100deg,rgba(220,230,240,.6) 8%,rgba(255,255,255,.9) 18%,rgba(220,230,240,.6) 28%) #e2e8ef;
          background-size:200% 100%;
          /* animation:shimmer 1.4s linear infinite; */
          border:1px solid rgba(120,150,190,.25);
      }
      /* @keyframes shimmer{to{background-position:-200% 0}} */
      /* @media (prefers-color-scheme:dark){
          .post-card{background:linear-gradient(150deg,#222a34,#1b222c 60%,#161d25);border-color:rgba(140,170,210,.25);color:#d9e2ec;}
          .post-card:before{background:
              radial-gradient(circle at 85% 15%,rgba(90,162,255,.18),transparent 60%),
              radial-gradient(circle at 12% 85%,rgba(27,116,228,.18),transparent 65%);
          }
          .pc-meta{opacity:.75;}
          .pc-menu, .act-btn{background:linear-gradient(135deg,#2b3440,#242c36);color:#d3dbe6;border-color:rgba(140,170,210,.28);}
          .act-btn:hover{color:#7eb6ff;}
          .cm-input{background:#2a313b;color:#d9e2ec;border-color:rgba(140,170,210,.28);}
          .cm-input:focus{background:#323a45;border-color:#4c95ff;}
          .post-skeleton{
              background:
                linear-gradient(100deg,rgba(60,70,82,.55) 8%,rgba(90,100,112,.6) 18%,rgba(60,70,82,.55) 28%) #2a313b;
          }
      } */
      </style>

      <script>
      (function(){
          const listEl = document.getElementById('postList');
          const tpl = document.getElementById('postCardTemplate');

          function showSkeleton(count=3){
              listEl.innerHTML='';
              for(let i=0;i<count;i++){
                  const sk=document.createElement('div');
                  sk.className='post-skeleton';
                  listEl.appendChild(sk);
              }
          }

          async function loadPosts(){
              showSkeleton();
              try{
                  const res = await fetch(fetchUrl, { credentials:'include' });
                  if(!res.ok) throw new Error(res.status);
                  const data = await res.json();
                  const posts = Array.isArray(data) ? data : (Array.isArray(data.content) ? data.content : []);
                  posts.sort((a, b) => {
                      const ta = new Date(a.createdAt || a.created_at || a.created || 0).getTime();
                      const tb = new Date(b.createdAt || b.created_at || b.created || 0).getTime();
                      return tb - ta; // newest first
                  });
                  render(posts);
              }catch(err){
                  listEl.innerHTML = '<div class="text-center text-muted small">Kh√¥ng t·∫£i ƒë∆∞·ª£c b√†i vi·∫øt.</div>';
              }
          }

          function render(posts){
              listEl.innerHTML='';
              if(posts.length===0){
                  listEl.innerHTML='<div class="text-center text-muted small">Ch∆∞a c√≥ b√†i vi·∫øt.</div>';
                  return;
              }
              posts.forEach(p=>{
                  const node = tpl.content.firstElementChild.cloneNode(true);

                  const postId = p.post_id || p.id || '';
                  const author = p.author || {};
                  const name = author.fullName || author.full_name || author.name || '·∫®n danh';
                  const avatar = author.avatarUrl || author.avatar || '/img/image1.png';
                  const created = p.created_at || p.createdAt || p.created || null;
                  const content = (p.content || '').trim();

                  node.dataset.postId = postId;
                  node.querySelector('.pc-name').textContent = name;
                  node.querySelector('.pc-avatar').src = avatar;
                  node.querySelector('.post-time').textContent = formatRelativeTime(created);

                  // pc-visibility
                  (function(){
                      const visEl = node.querySelector('.pc-visibility');
                      if(!visEl) return;
                      const raw = p.visibility ?? p.privacy ?? p.scope ?? p.access ?? '';
                      const norm = (typeof raw === 'number' ? String(raw) : String(raw)).trim().toLowerCase();
                      let label = 'B·∫°n b√®';
                      if (p.isPublic === true) label = 'C√¥ng khai';
                      else if (p.isPrivate === true) label = 'Ch·ªâ m√¨nh t√¥i';
                      else if (p.friendsOnly === true || p.friendOnly === true) label = 'B·∫°n b√®';
                      else {
                          switch(norm){
                              case '0':
                              case 'public':
                              case 'everyone':
                                  label = 'C√¥ng khai'; break;
                              case '1':
                              case 'friends':
                              case 'friend':
                                  label = 'B·∫°n b√®'; break;
                              case '2':
                              case 'private':
                              case 'only_me':
                              case 'onlyme':
                                  label = 'Ch·ªâ m√¨nh t√¥i'; break;
                              case '3':
                              case 'friends_of_friends':
                              case 'fof':
                                  label = 'B·∫°n c·ªßa b·∫°n b√®'; break;
                              case 'custom':
                              case 'restricted':
                                  label = 'T√πy ch·ªânh'; break;
                              default:
                                  label = 'B·∫°n b√®';
                          }
                      }
                      // Important postType
                      const type = (p.postType || p.type || '').toLowerCase();
                      if(type==='important' || type==='notice' || type==='thongbao'){
                          label = 'Th√¥ng b√°o ƒê·∫∑c bi·ªát';
                      }

                      visEl.textContent = label;
                      visEl.title = label;
                  })();



                  const contentEl = node.querySelector('.post-content');
                  contentEl.textContent = content;
                  if(!content) contentEl.style.display='none';

                  const mediaWrap = node.querySelector('.post-media');
                  const mediaArr = Array.isArray(p.media)?p.media:[];
                  if(mediaArr.length===0){
                      mediaWrap.style.display='none';
                  }else{
                      const total = mediaArr.length;
                      const classMap = total<=4?('img-'+total):'img-4';
                      mediaWrap.classList.add(classMap);
                      mediaArr.slice(0,4).forEach((m,idx)=>{
                          const t = (m.mediaType||m.media_type)||'image';
                          const u = m.mediaUrl || m.media_url;
                          if(!u) return;
                          let el;
                          if(t==='video'){
                              el=document.createElement('video');
                              el.style.width='100%';
                              el.style.height='100%';
                              el.style.objectFit='contain';
                              el.style.display='block';
                              el.style.background='#000';
                              el.src=u;
                              el.controls=true;
                              el.playsInline=true;
                          }else{
                              el=document.createElement('img');
                              el.src=u;
                              el.loading='lazy';
                              el.alt='';
                          }
                          const fig=document.createElement('figure');
                          fig.style.margin='0';
                          fig.appendChild(el);
                          if(idx===3 && total>4){
                              const overlay=document.createElement('div');
                              overlay.textContent='+'+(total-4);
                              overlay.style.position='absolute';
                              overlay.style.inset='0';
                              overlay.style.display='flex';
                              overlay.style.alignItems='center';
                              overlay.style.justifyContent='center';
                              overlay.style.fontSize='2rem';
                              overlay.style.fontWeight='700';
                              overlay.style.color='#fff';
                              overlay.style.background='rgba(0,0,0,.45)';
                              overlay.style.backdropFilter='blur(2px)';
                              fig.style.position='relative';
                              fig.style.maxHeight="400px";
                              fig.appendChild(overlay);
                          }
                          mediaWrap.appendChild(fig);
                      });
                  }

                  const likeBtn = node.querySelector('.btn-like');
                  const likeCount = node.querySelector('.like-count');
                  let liked=false;
                  likeBtn.addEventListener('click',()=>{
                      liked=!liked;
                      likeBtn.dataset.active = liked? '1':'0';
                      const current=Number(likeCount.textContent||'0');
                      likeCount.textContent = liked ? current+1 : Math.max(0,current-1);
                  });

                  node.querySelector('.btn-comment').addEventListener('click',()=>{
                      node.querySelector('.pc-footer').classList.toggle('d-none');
                      node.querySelector('.cm-input')?.focus();
                  });

                  node.addEventListener('keydown',e=>{
                      if(e.target.classList.contains('cm-input') && e.key==='Enter'){
                          e.preventDefault();
                          e.target.value='';
                      }
                  });

                  listEl.appendChild(node);
              });
          }

          function formatRelativeTime(ts){
              if(!ts) return '';
              const d=new Date(ts);
              if(isNaN(d)) return '';
              const diff = (Date.now()-d.getTime())/1000;
              if(diff<60) return 'V·ª´a xong';
              if(diff<3600) return Math.floor(diff/60)+' ph√∫t';
              if(diff<86400) return Math.floor(diff/3600)+' gi·ªù';
              if(diff<172800) return 'H√¥m qua';
              return d.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'});
          }

          loadPosts();
      })();
      </script>
      <!-- Post Segment:END -->
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
