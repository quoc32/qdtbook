<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>QDTBook - Administrator Manager</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/qdtFavicon.png">
</head>

<body>
    <!-- Nhúng fragment navbar -->
    <div th:replace="fragments/navbar :: navbar"></div>

    <!-- Main content:BEGIN -->
    <main class="container py-4">
      <h1 class="h4 mb-4">Administrator Manager</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Đổi vai trò sang "special"</div>
            <div class="card-body">
              <div class="mb-3">
                <label for="userEmailSpecial" class="form-label">Email</label>
                <input type="email" class="form-control" id="userEmailSpecial" value="example-user@gmail.com">
              </div>
              <button id="btnSpecial" class="btn btn-primary w-100">Upgrade to special</button>
              <div id="statusSpecial" class="small mt-3"></div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Đổi vai trò sang "student"</div>
            <div class="card-body">
              <div class="mb-3">
                <label for="userEmailStudent" class="form-label">Email</label>
                <input type="email" class="form-control" id="userEmailStudent" value="example-user@gmail.com">
              </div>
              <button id="btnStudent" class="btn btn-success w-100">Upgrade to student</button>
              <div id="statusStudent" class="small mt-3"></div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      (function () {
        async function findUserByEmail(email) {
          const res = await fetch(`/api/users/find/by-email?email=${encodeURIComponent(email)}`, {
            credentials: 'include'
          });
          const contentType = res.headers.get('content-type') || '';
          const data = contentType.includes('application/json')
            ? await res.json().catch(() => null)
            : await res.text();
          if (!res.ok) {
            throw new Error(typeof data === 'string' ? data : (data?.message || `HTTP ${res.status}`));
          }
          if (!data || !data.id) {
            throw new Error('User not found by email');
          }
          return data;
        }

        async function upgradeRole(userId, toRole) {
          const res = await fetch(`/api/users/${encodeURIComponent(userId)}/upgrade`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ toRole })
          });
          const contentType = res.headers.get('content-type') || '';
          const data = contentType.includes('application/json')
            ? await res.json().catch(() => ({}))
            : await res.text();
          if (!res.ok) {
            throw new Error(typeof data === 'string' ? data : (data.message || `HTTP ${res.status}`));
          }
          return data;
        }

        function setStatus(el, msg, ok) {
          el.textContent = msg;
          el.className = 'small mt-3 ' + (ok ? 'text-success' : 'text-danger');
        }

        document.getElementById('btnSpecial').addEventListener('click', async () => {
          const email = document.getElementById('userEmailSpecial').value.trim();
          const statusEl = document.getElementById('statusSpecial');
          if (!email) return setStatus(statusEl, 'Vui lòng nhập email', false);
          setStatus(statusEl, 'Đang tìm người dùng...', true);
          try {
            const user = await findUserByEmail(email);
            setStatus(statusEl, `Tìm thấy #${user.id} (role: ${user.role || 'unknown'}). Đang nâng cấp...`, true);
            const data = await upgradeRole(user.id, 'special');
            setStatus(statusEl, typeof data === 'string' ? data : `Đã đổi vai trò #${user.id} sang special`, true);
          } catch (e) {
            setStatus(statusEl, e.message, false);
          }
        });

        document.getElementById('btnStudent').addEventListener('click', async () => {
          const email = document.getElementById('userEmailStudent').value.trim();
          const statusEl = document.getElementById('statusStudent');
          if (!email) return setStatus(statusEl, 'Vui lòng nhập email', false);
          setStatus(statusEl, 'Đang tìm người dùng...', true);
          try {
            const user = await findUserByEmail(email);
            setStatus(statusEl, `Tìm thấy #${user.id} (role: ${user.role || 'unknown'}). Đang nâng cấp...`, true);
            const data = await upgradeRole(user.id, 'student');
            setStatus(statusEl, typeof data === 'string' ? data : `Đã đổi vai trò #${user.id} sang student`, true);
          } catch (e) {
            setStatus(statusEl, e.message, false);
          }
        });
      })();
    </script>
    <!-- Main content:END -->

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>