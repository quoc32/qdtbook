<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>User Management</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/qdtFavicon.png">
    <style>
        body { background:#f0f2f5; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
        .navbar-brand { font-weight:700; color:#1365ff !important; }
        .search-box { background:#f0f2f5; border:none; border-radius:20px; padding:6px 14px; width:230px; }
        .search-box:focus { outline:0; box-shadow:none; background:#e4e6eb; }
        .sidebar-sticky { position:sticky; top:70px; }
        .story-card { height:160px; border-radius:12px; background:#fff; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; font-weight:600; color:#555; }
        .composer, .post-card { background:#fff; border-radius:8px; border:1px solid #ddd; }
        .composer textarea { resize:none; border:none; box-shadow:none; }
        .composer textarea:focus { outline:0; }
        .btn-primary { background:#1b74e4; border-color:#1b74e4; }
        .btn-primary:hover { background:#155ec0; }
        .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; }
        .post-img { border-radius:8px; max-height:480px; object-fit:cover; width:100%; }
        .action-btn { background:transparent; border:none; padding:6px 8px; border-radius:6px; font-weight:500; color:#555; }
        .action-btn:hover { background:#f0f2f5; }
        .right-card { background:#fff; border:1px solid #ddd; border-radius:8px; }
        @media (max-width: 992px){
            .left-col, .right-col { display:none; }
            .search-box { width:140px; }
        }
    </style>
</head>
<body>
  <!-- Nhúng fragment navbar -->
  <div th:replace="fragments/navbar :: navbar"></div>


  <main class="container-fluid mt-4">
    <div class="row justify-content-center">
      
      <!-- Profile top header:BEGIN -->
      <section class="col-12 mb-4">
        <style>
          /* Profile Header Enhancements */
          .profile-card{
        border:0;
        border-radius:22px;
        overflow:hidden;
        box-shadow:0 4px 18px -4px rgba(0,0,0,.15);
        position:relative;
        background:#fff;
          }
          .profile-cover{
        position:relative;
        height:230px;
        background:
          radial-gradient(circle at 20% 20%,rgba(255,255,255,.25),transparent 60%),
          linear-gradient(135deg,#0d5ef4,#6aa9ff);
        display:flex;
        align-items:center;
        justify-content:center;
        isolation:isolate;
          }
          .profile-cover::after{
        content:"";
        position:absolute;
        inset:0;
        background:
          linear-gradient(to bottom,rgba(0,0,0,.15),rgba(0,0,0,.45));
        opacity:.55;
        pointer-events:none;
        mix-blend-mode:multiply;
          }
          #user-cover{
        object-fit:cover;
        filter:brightness(.9);
        transition:opacity .5s ease;
          }
          .profile-avatar-wrap{
        position:absolute;
        left:38px;
        bottom:-64px;
        display:flex;
        align-items:end;
        z-index:10;
          }
          #user-avatar{
        width:150px;
        height:150px;
        border-radius:50%;
        object-fit:cover;
        border:5px solid #fff;
        box-shadow:0 6px 18px -4px rgba(0,0,0,.35);
        background:#fff;
        transition:transform .4s cubic-bezier(.4,.14,.18,1),box-shadow .4s;
          }
          #user-avatar:hover{
        transform:translateY(-4px);
        box-shadow:0 10px 28px -6px rgba(0,0,0,.4);
          }
          .profile-body{
        padding:92px 2.2rem 1.2rem;
          }
          .profile-body h4{
        font-weight:700;
        letter-spacing:.3px;
          }
        .profile-stats li{
          position:relative;
          padding-left:20px;
        }
        .profile-stats li::before{
          content:"";
          position:absolute;
          top:50%;
          left:0;
          width:10px;
          height:10px;
          border-radius:50%;
          background:linear-gradient(135deg,#1b74e4,#6aa9ff);
          transform:translateY(-50%);
          opacity:.7;
        }
          .profile-actions .btn{
        font-weight:500;
        backdrop-filter:blur(6px);
          }
          .profile-actions .btn-outline-primary{
        border-color:#1b74e4;
          }
          .profile-tabs-bar{
        background:#ffffffd9;
        backdrop-filter:blur(8px);
        padding:.35rem 1.8rem 0;
        border-top:1px solid #e4e6eb;
          }
          #profile-tabs{
        position:relative;
        gap:.25rem;
          }
          #profile-tabs .nav-link{
        position:relative;
        border:0;
        background:transparent;
        color:#59626d;
        font-weight:500;
        border-radius:10px 10px 0 0;
        padding:.65rem 1.05rem;
        transition:color .25s, background .25s;
          }
          #profile-tabs .nav-link:hover{
        background:#f0f4f9;
        color:#1b74e4;
          }
          #profile-tabs .nav-link.active{
        color:#0d5ef4;
        font-weight:600;
          }
          #profile-tabs .nav-link.active::after{
        content:"";
        position:absolute;
        left:12%;
        right:12%;
        bottom:2px;
        height:3px;
        border-radius:3px;
        background:linear-gradient(90deg,#0d5ef4,#6aa9ff);
        box-shadow:0 0 0 1px #ffffff;
          }
          /* Responsive tweaks */
          @media (max-width: 992px){
        .profile-cover{height:180px;}
        #user-avatar{width:110px;height:110px;bottom:-48px;}
        .profile-body{padding:72px 1.25rem 1rem;}
          }
          @media (max-width: 576px){
        .profile-body h4{font-size:1.15rem;}
        .profile-stats li{margin-right:.75rem !important;}
        #profile-tabs .nav-link{padding:.55rem .75rem;font-size:.85rem;}
          }
        </style>

        <div class="profile-card">
          
          <div class="profile-cover">
            <!-- Cover image (hidden until set) -->
            <img id="user-cover" src="" alt="cover" class="w-100 h-100 position-absolute top-0 start-0 d-none">
            <div class="profile-avatar-wrap">
              <img
                id="user-avatar"
                src="/img/image1.png"
                alt="avatar">
              <script>
                (function(){
                  try{
                    const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                    const url = auth?.avatar_url || auth?.avatar;
                    if(url){
                        const img = document.getElementById('user-avatar');
                        if(img) img.src = url;
                    }
                    const coverUrl = auth?.cover_photo_url || auth?.cover_photo;
                    console.log('Cover URL:', coverUrl);
                    if(coverUrl){
                        const coverImg = document.getElementById('user-cover');
                        if(coverImg){
                          coverImg.src = coverUrl;
                          coverImg.classList.remove('d-none');
                        }
                    }
                  }catch(_){}
                })();
              </script>
            </div>
          </div>

          <!-- Phần thân Profile Header:BEGIN -->
          <div class="profile-body">
            <div class="d-flex flex-column flex-md-row align-items-md-end align-items-start">
              <div class="me-md-auto">
                <h4 class="mb-1" id="user-full-name">User Name</h4>
                <p class="text-muted small mb-2" id="user-username">@bio</p>
                <script>
                (function(){
                  const el = document.getElementById('user-full-name');
                  if(!el) return;
                  try{
                  const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                  el.textContent = auth?.full_name?.trim() || 'Trang cá nhân';
                  }catch(_){
                  el.textContent = 'Trang cá nhân';
                  }
                  const el2 = document.getElementById('user-username');
                  if(!el2) return;
                  try{
                  const auth = JSON.parse(localStorage.getItem('auth')||'{}');
                  el2.textContent = auth?.bio?.trim() || 'Bio ngắn về người dùng ở đây.';
                  }catch(_){
                  el2.textContent = 'Bio ngắn về người dùng ở đây.';
                  }
                })();
                </script>

                <p class="mb-2 small text-secondary d-none" id="user-bio">Short bio about the user goes here.</p>
                <ul class="list-inline small text-muted mb-0 profile-stats">
                  <li class="list-inline-item me-4">
                    <span class="fw-semibold" id="user-post-count">0</span> Posts
                  </li>
                  <li class="list-inline-item me-4">
                    <span class="fw-semibold" id="user-friend-count">0</span> Friends
                  </li>
                  <li class="list-inline-item d-none" id="user-location-wrap">
                    <span id="user-location">Location</span>
                  </li>
                </ul>
              </div>

              <div class="mt-3 mt-md-0 d-flex gap-2 flex-wrap profile-actions">
                <!-- New: open modal to change avatar / cover / bio -->
                <button class="btn btn-sm btn-outline-primary" id="btn-open-profile-modal"
                  data-bs-toggle="modal" data-bs-target="#profileEditModal">
                  <i class="bi bi-pencil me-1"></i>Edit Profile
                </button>
                <button class="btn btn-sm btn-primary d-none" id="btn-add-friend" data-action="add-friend">
                  <i class="bi bi-person-plus me-1"></i>Add Friend
                </button>
                <button class="btn btn-sm btn-secondary d-none" id="btn-request-sent" disabled>
                  <i class="bi bi-hourglass-split me-1"></i>Request Sent
                </button>
                <button class="btn btn-sm btn-outline-danger d-none" id="btn-unfriend" data-action="unfriend">
                  <i class="bi bi-person-dash me-1"></i>Unfriend
                </button>
                <button class="btn btn-sm btn-outline-secondary d-none" id="btn-message" data-action="message">
                  <i class="bi bi-chat-dots me-1"></i>Message
                </button>
              </div>

            </div>
          </div>
          <!-- Phần thân Profile Header:END -->
          
          <!-- Phần NavBar con:BEGIN -->
          <div class="profile-tabs-bar">
            <nav class="nav nav-tabs border-0" id="profile-tabs">
              <a class="nav-link active" href="#posts" data-tab="posts">Posts</a>
              <a class="nav-link" href="#about" data-tab="about">About</a>
              <a class="nav-link" href="#friends" data-tab="friends">Friends</a>
              <a class="nav-link" href="#photos" data-tab="photos">Photos</a>
            </nav>
          </div>
          <!-- >> Script xử lý ẩn hiện các section tương ứng với mỗi tab -->
          <script defer>
            document.addEventListener("DOMContentLoaded", function(){
              const tabs = document.querySelectorAll('#profile-tabs .nav-link');
              console.log('Tabs found:', tabs);
              const sections = {
                posts: document.getElementById('posts-section'),
                about: document.getElementById('about-section'),
                friends: document.getElementById('friends-section'),
                photos: document.getElementById('photos-section')
              };
              console.log('Sections:', sections);
              function showSection(tab){
                Object.keys(sections).forEach(key=>{
                  if(sections[key]){
                    if(key === tab){
                      sections[key].classList.remove('d-none');
                    }else{
                      sections[key].classList.add('d-none');
                    }
                  }
                });
              }
              tabs.forEach(tabEl=>{
                tabEl.addEventListener('click', (e)=>{
                  e.preventDefault();
                  const selectedTab = tabEl.dataset.tab;
                  tabs.forEach(t=>t.classList.remove('active'));
                  tabEl.classList.add('active');
                  showSection(selectedTab);
                });
              });
              // Show posts tab by default
              showSection('posts');
            });
          </script>
          <!-- Phần NavBar con:END -->

          <!-- Modal: Edit avatar / cover / bio -->
          <div class="modal fade" id="profileEditModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <form id="profile-edit-form">
                <div class="modal-content">

                  <div class="modal-header">
                    <h5 class="modal-title">Customize Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>

                  <div class="modal-body">
                    <div class="row g-3">
                    <!-- Thay Avatar -->
                    <div class="col-12">
                      <label class="form-label fw-semibold small mb-1">Avatar</label>
                      <div class="d-flex align-items-center gap-3">
                        <img id="preview-avatar" src="/img/image1.png" style="width:90px;height:90px;border-radius:50%;object-fit:cover;border:2px solid #e5e5e5;">
                        <div>
                          <input type="file" accept="image/*" id="input-avatar" class="form-control form-control-sm">
                          <div class="form-text">Square image recommended (>= 256x256)</div>
                        </div>
                      </div>
                    </div>
                    <!-- Thay cover image -->
                    <div class="col-12">
                      <label class="form-label fw-semibold small mb-1">Cover Image</label>
                      <div class="border rounded p-2 position-relative"></div>
                        <img id="preview-cover" class="w-100" style="max-height:180px;object-fit:cover;border-radius:6px;" src="" alt="">
                        <div class="mt-2">
                          <input type="file" accept="image/*" id="input-cover" class="form-control form-control-sm">
                        <div class="form-text">Recommended size >= 1200x400</div>
                      </div>
                    </div>
                    <!-- Thay Bio -->
                  </div>
                      <div class="col-12">
                      <label for="input-bio" class="form-label fw-semibold small mb-1">Bio</label>
                      <textarea id="input-bio" class="form-control" rows="3" maxlength="300" placeholder="Write a short bio..."></textarea>
                      <div class="form-text"><span id="bio-count">0</span>/300</div>
                    </div>

                  </div>

                  <div class="alert alert-danger py-2 px-3 small d-none mt-3" id="profile-edit-error"></div>
                  <div class="alert alert-success py-2 px-3 small d-none mt-3" id="profile-edit-success">Saved.</div>
                
                  <!-- footer -->
                  <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-sm btn-primary" id="btn-save-profile">
                      <span class="save-text">Save Changes</span>
                      <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                  </div>

                </div>
              </form> 
            </div>
          </div>

        </div>
        
        <script>
          // Force showing edit buttons immediately
        (function(){
          document.getElementById('btn-open-profile-modal')?.classList.remove('d-none');
          document.getElementById('btn-edit-profile')?.classList.remove('d-none');

          const auth = (()=>{try{return JSON.parse(localStorage.getItem('auth')||'{}')}catch(_){return {}}})();
          const avatarImg = document.getElementById('user-avatar');
          const coverImg = document.getElementById('user-cover');

          if(avatarImg) document.getElementById('preview-avatar').src = avatarImg.src;
          if(coverImg && coverImg.src) {
            document.getElementById('preview-cover').src = coverImg.src;
          }

          const inputAvatar = document.getElementById('input-avatar');
          const inputCover = document.getElementById('input-cover');
          const inputBio = document.getElementById('input-bio');
          const bioCount = document.getElementById('bio-count');
          const errorBox = document.getElementById('profile-edit-error');
          const successBox = document.getElementById('profile-edit-success');
          const form = document.getElementById('profile-edit-form');
          const saveBtn = document.getElementById('btn-save-profile');
          const spinner = saveBtn?.querySelector('.spinner-border');
          const saveText = saveBtn?.querySelector('.save-text');

          if(inputBio){
            inputBio.value = auth?.bio || '';
            bioCount.textContent = inputBio.value.length;
            inputBio.addEventListener('input', ()=> bioCount.textContent = inputBio.value.length);
          }

          function previewFile(input, imgEl){
            if(!input?.files?.[0]) return;
            const f = input.files[0];
            const url = URL.createObjectURL(f);
            imgEl.src = url;
          }

          inputAvatar?.addEventListener('change', ()=> previewFile(inputAvatar, document.getElementById('preview-avatar')));
          inputCover?.addEventListener('change', ()=> {
          const el = document.getElementById('preview-cover');
          previewFile(inputCover, el);
          if(el.src && coverImg){
            coverImg.classList.remove('d-none');
            coverImg.src = el.src;
          }
          });

          form?.addEventListener('submit', async (e)=>{
            e.preventDefault();
            errorBox.classList.add('d-none');
            successBox.classList.add('d-none');
            saveBtn.disabled = true;
            spinner.classList.remove('d-none');
            saveText.classList.add('d-none');

            try {
              // 1. Upload selected files (avatar first, then cover) to /api/media/upload
              const uploadFd = new FormData();
              const avatarFile = inputAvatar?.files?.[0] || null;
              const coverFile  = inputCover?.files?.[0]  || null;

              if (avatarFile) uploadFd.append('files', avatarFile);
              if (coverFile)  uploadFd.append('files', coverFile);

              let uploadedAvatarUrl, uploadedCoverUrl;

              if (uploadFd.has('files')) {
              const uploadResp = await fetch('/api/media/upload', {
                method: 'POST',
                body: uploadFd
              });
              if (!uploadResp.ok) throw new Error('Upload failed: ' + uploadResp.status);
              const uploadData = await uploadResp.json().catch(()=> ({}));
              const urls = Array.isArray(uploadData.urls) ? uploadData.urls : [];

              // Map returned urls to avatar / cover in the same order we appended
              if (avatarFile && coverFile && urls.length >= 2) {
                uploadedAvatarUrl = "http://localhost:8080" + urls[0];
                uploadedCoverUrl  = "http://localhost:8080" + urls[1];
              } else if (avatarFile && urls.length >= 1) {
                uploadedAvatarUrl = "http://localhost:8080" + urls[0];
              } else if (coverFile && urls.length >= 1) {
                uploadedCoverUrl = "http://localhost:8080" + urls[0];
              }
              }

              // 2. Build partial update payload
              const payload = {};
              if (inputBio) {
              const bioVal = inputBio.value.trim();
              if (bioVal.length) payload.bio = bioVal;
              }
              if (uploadedAvatarUrl) payload.avatar_url = uploadedAvatarUrl;
              if (uploadedCoverUrl) payload.cover_photo_url = uploadedCoverUrl;

              // If nothing to update, just finish gracefully
              if (Object.keys(payload).length === 0) {
              successBox.classList.remove('d-none');
              } else {
                
              const userId = auth?.id || auth?.user_id || 1; // fallback id
              const updateResp = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              if (!updateResp.ok) throw new Error('Update failed: ' + updateResp.status);
              await updateResp.json().catch(()=> ({}));

              // 3. Update UI
              if (uploadedAvatarUrl && avatarImg) {
                avatarImg.src = uploadedAvatarUrl;
                const pvA = document.getElementById('preview-avatar');
                if (pvA) pvA.src = uploadedAvatarUrl;
              }
              if (uploadedCoverUrl && coverImg) {
                coverImg.src = uploadedCoverUrl;
                coverImg.classList.remove('d-none');
                const pvC = document.getElementById('preview-cover');
                if (pvC) pvC.src = uploadedCoverUrl;
              }
              if (payload.bio) {
                const bioInline = document.getElementById('user-username');
                if (bioInline) bioInline.textContent = payload.bio;
              }

              // 4. Persist to localStorage auth
              if (payload.bio) auth.bio = payload.bio;
              if (uploadedAvatarUrl) auth.avatar_url = uploadedAvatarUrl;
              if (uploadedCoverUrl) auth.cover_photo_url = uploadedCoverUrl;
              localStorage.setItem('auth', JSON.stringify(auth));

              successBox.classList.remove('d-none');

              setTimeout(()=>{
                const modalEl = document.getElementById('profileEditModal');
                if (window.bootstrap) {
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal && modal.hide();
                }
              }, 900);
              }

            } catch(err) {
              errorBox.textContent = err.message || 'Error';
              errorBox.classList.remove('d-none');
            } finally {
              saveBtn.disabled = false;
              spinner.classList.add('d-none');
              saveText.classList.remove('d-none');
            }

          });

        })();
        </script>
      </section>
      <!-- Profile top header:END -->

      <!-- Feed:BEGIN -->
       <!-- Cho Tab Posts -->
      <section class="col-12 col-lg-8 mb-4" id="posts-section">

        <!-- Nhúng fragment postComposer -->
        <div th:replace="fragments/postComposer :: postComposer"></div>
          <!-- Nhúng fragment postComposerModal -->
        <div th:replace="fragments/postComposer :: postComposerModal"></div>
        <!-- Nhúng fragment postSegment -->
        <div th:replace="~{fragments/postSegment :: postSegment(
          fetchUrl=@{/api/posts/user/{id}(id=${viewingUserId})},
          isSelfProfile=${'true'}
        )}"></div>

        <!-- Infinite scroll sentinel -->
        <div id="feed-end" class="text-center text-muted py-3 small" aria-live="polite">Loading...</div>
      </section>
      <!-- Feed:END -->

      <!-- About:BEGIN -->
      <section class="col-12 col-lg-11 mb-4 d-none" id="about-section">

        <div class="right-card about-card">

          <!-- Navbar của About -->
          <nav class="nav nav-tabs small px-3 pt-3 about-tabs flex-nowrap" id="aboutTabs" role="tablist">
            <a class="nav-link active" id="about-overview-tab" data-bs-toggle="tab" href="#about-overview" role="tab" aria-controls="about-overview" aria-selected="true">
              <i class="bi bi-grid-1x2 me-1"></i> Tổng quan
            </a>
            <a class="nav-link" id="about-work-tab" data-bs-toggle="tab" href="#about-work" role="tab" aria-controls="about-work" aria-selected="false">
              <i class="bi bi-briefcase me-1"></i> Công việc & Học vấn
            </a>
            <a class="nav-link" id="about-places-tab" data-bs-toggle="tab" href="#about-places" role="tab" aria-controls="about-places" aria-selected="false">
              <i class="bi bi-geo-alt me-1"></i> Nơi từng sống
            </a>
            <a class="nav-link" id="about-contact-tab" data-bs-toggle="tab" href="#about-contact" role="tab" aria-controls="about-contact" aria-selected="false">
              <i class="bi bi-envelope me-1"></i> Liên hệ
            </a>
            <a class="nav-link" id="about-details-tab" data-bs-toggle="tab" href="#about-details" role="tab" aria-controls="about-details" aria-selected="false">
              <i class="bi bi-card-text me-1"></i> Chi tiết
            </a>
            <a class="nav-link" id="about-links-tab" data-bs-toggle="tab" href="#about-links" role="tab" aria-controls="about-links" aria-selected="false">
              <i class="bi bi-link-45deg me-1"></i> Liên kết
            </a>
          </nav>

          <div class="tab-content p-3 pb-4">
            <!-- Tổng quan -->
            <div class="tab-pane fade show active" id="about-overview" role="tabpanel" aria-labelledby="about-overview-tab">
              <h6 class="about-section-title mb-3">Tổng quan</h6>
              <ul class="about-list small mb-0">
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-chat-square-text"></i></span>
                  <span class="about-label">Bio</span>
                  <span class="about-value flex-fill" id="about-bio" data-field="bio" data-type="textarea">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-building"></i></span>
                  <span class="about-label">Nơi làm việc</span>
                  <span class="about-value flex-fill" id="about-workplace" data-field="workplace">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-mortarboard"></i></span>
                  <span class="about-label">Học vấn</span>
                  <span class="about-value flex-fill" id="about-education" data-field="education">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-buildings"></i></span>
                  <span class="about-label">Thành phố</span>
                  <span class="about-value flex-fill" id="about-city" data-field="city">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-globe-asia-australia"></i></span>
                  <span class="about-label">Quốc gia</span>
                  <span class="about-value flex-fill" id="about-country" data-field="country">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-globe2"></i></span>
                  <span class="about-label">Website</span>
                  <a class="about-value flex-fill" id="about-website" data-field="website" data-type="url" href="#" target="_blank" rel="noopener noreferrer">—</a>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-calendar3"></i></span>
                  <span class="about-label">Tham gia</span>
                  <span class="about-value flex-fill" id="about-joined">—</span>
                </li>
              </ul>
            </div>

            <!-- Công việc & Học vấn -->
            <div class="tab-pane fade" id="about-work" role="tabpanel" aria-labelledby="about-work-tab">
              <h6 class="about-section-title mb-3">Công việc & Học vấn</h6>
              <ul class="about-list small mb-0">
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-briefcase"></i></span>
                  <span class="about-label">Nơi làm việc</span>
                  <span class="about-value flex-fill" id="about-workplace-2" data-field="workplace">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-mortarboard"></i></span>
                  <span class="about-label">Trường/Ngành</span>
                  <span class="about-value flex-fill" id="about-education-2" data-field="education">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-person-badge"></i></span>
                  <span class="about-label">Mã sinh viên</span>
                  <span class="about-value flex-fill" id="about-school-id" data-field="school_id">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-calendar-week"></i></span>
                  <span class="about-label">Niên khóa</span>
                  <span class="about-value flex-fill" id="about-academic-year" data-field="academic_year">—</span>
                </li>
              </ul>
            </div>

            <!-- Nơi từng sống -->
            <div class="tab-pane fade" id="about-places" role="tabpanel" aria-labelledby="about-places-tab">
              <h6 class="about-section-title mb-3">Nơi từng sống</h6>
              <ul class="about-list small mb-0">
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-geo-alt"></i></span>
                  <span class="about-label">Thành phố hiện tại</span>
                  <span class="about-value flex-fill" id="about-city-2" data-field="city">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-globe-americas"></i></span>
                  <span class="about-label">Quốc gia</span>
                  <span class="about-value flex-fill" id="about-country-2" data-field="country">—</span>
                </li>
              </ul>
            </div>

            <!-- Liên hệ -->
            <div class="tab-pane fade" id="about-contact" role="tabpanel" aria-labelledby="about-contact-tab">
              <h6 class="about-section-title mb-3">Thông tin liên hệ</h6>
              <ul class="about-list small mb-0">
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-envelope"></i></span>
                  <span class="about-label">Email</span>
                  <a class="about-value flex-fill" id="about-email" data-field="email" data-type="email" href="#">—</a>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-telephone"></i></span>
                  <span class="about-label">Điện thoại</span>
                  <a class="about-value flex-fill" id="about-phone" data-field="phone" data-type="tel" href="#">—</a>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-globe2"></i></span>
                  <span class="about-label">Website</span>
                  <a class="about-value flex-fill" id="about-website-2" data-field="website" data-type="url" href="#" target="_blank" rel="noopener noreferrer">—</a>
                </li>
              </ul>
            </div>

            <!-- Chi tiết -->
            <div class="tab-pane fade" id="about-details" role="tabpanel" aria-labelledby="about-details-tab">
              <h6 class="about-section-title mb-3">Chi tiết</h6>
              <ul class="about-list small mb-0">
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-person-circle"></i></span>
                  <span class="about-label">Họ tên</span>
                  <span class="about-value flex-fill" id="about-full-name" data-field="full_name">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-gender-ambiguous"></i></span>
                  <span class="about-label">Giới tính</span>
                  <span class="about-value flex-fill" id="about-gender" data-field="gender">—</span>
                  <!-- >> Bind dữ liệu cho Giới tính -->
                  <script>
                    (function(){
                      const valEl = document.getElementById('about-gender');
                      if(!valEl) return;
                      const row = valEl.closest('.about-row');

                      function enhanceToSelect(){
                        if(valEl.dataset.editing !== '1') return;
                        const input = row.querySelector('input.form-control');
                        if(!input || input.dataset.enhanced==='1') return;

                        const select = document.createElement('select');
                        select.className = 'form-select form-select-sm d-inline-block';
                        select.style.minWidth = '220px';
                        ['Male','Female','Other'].forEach(v=>{
                          const o=document.createElement('option'); o.value=v; o.textContent=v; select.appendChild(o);
                        });

                        const cur = (input.value||'').trim();
                        select.value = ['Male','Female','Other'].includes(cur) ? cur : 'Other';

                        input.style.display='none';
                        input.dataset.enhanced='1';
                        input.value = select.value;
                        select.addEventListener('change', ()=>{ input.value = select.value; });

                        const saveBtn = row.querySelector('button.btn.btn-primary');
                        row.insertBefore(select, saveBtn || input.nextSibling);
                      }

                      function cleanupSelectIfAny(){
                        if(valEl.dataset.editing === '1') return;
                        const sel = row.querySelector('select.form-select');
                        if(sel) sel.remove();
                      }

                      const mo = new MutationObserver(()=>{
                        enhanceToSelect();
                        cleanupSelectIfAny();
                      });
                      mo.observe(row, { childList:true, subtree:true });
                      mo.observe(valEl, { attributes:true, attributeFilter:['data-editing'] });
                    })();
                  </script>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-calendar-event"></i></span>
                  <span class="about-label">Ngày sinh</span>
                  <span class="about-value flex-fill" id="about-dob" data-field="date_of_birth" data-type="date">—</span>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-shield-check"></i></span>
                  <span class="about-label">Vai trò</span>
                  <span class="about-value flex-fill" id="about-role">—</span>
                </li>
              </ul>
            </div>

            <!-- Liên kết -->
            <div class="tab-pane fade" id="about-links" role="tabpanel" aria-labelledby="about-links-tab">
              <h6 class="about-section-title mb-3">Liên kết</h6>
              <ul class="about-list small mb-0">
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-facebook"></i></span>
                  <span class="about-label">Facebook</span>
                  <a class="about-value flex-fill text-decoration-none" id="about-facebook" data-field="facebook_url" data-type="url" href="#" target="_blank" rel="noopener noreferrer">—</a>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-instagram"></i></span>
                  <span class="about-label">Instagram</span>
                  <a class="about-value flex-fill text-decoration-none" id="about-instagram" data-field="instagram_url" data-type="url" href="#" target="_blank" rel="noopener noreferrer">—</a>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-linkedin"></i></span>
                  <span class="about-label">LinkedIn</span>
                  <a class="about-value flex-fill text-decoration-none" id="about-linkedin" data-field="linkedin_url" data-type="url" href="#" target="_blank" rel="noopener noreferrer">—</a>
                </li>
                <li class="about-row">
                  <span class="about-ic"><i class="bi bi-twitter"></i></span>
                  <span class="about-label">Twitter/X</span>
                  <a class="about-value flex-fill text-decoration-none" id="about-twitter" data-field="twitter_url" data-type="url" href="#" target="_blank" rel="noopener noreferrer">—</a>
                </li>
              </ul>
            </div>

          </div>

        </div>

        <!-- >> Script xử lý cho Component About:Update thông tin -->
        <script>
          // Inline edit handlers for About section. Sends PUT /users/{id} with { field: value }
          (function(){
            let auth = {};
            try{ auth = JSON.parse(localStorage.getItem('auth')||'{}')||{}; }catch(_){ auth = {}; }
            const userId = auth?.id || auth?.user_id || 1; // fallback
            const UPDATE_URL_BASE = '/api/users/'; // as requested

            const editable = document.querySelectorAll('#about-section .about-value[data-field]');
            editable.forEach(el=>{
              const btn = document.createElement('button');
              btn.type='button';
              btn.className='edit-inline-btn btn btn-link btn-sm p-0 ms-2 text-secondary';
              btn.innerHTML='<i class="bi bi-pencil-square"></i>';
              btn.title='Chỉnh sửa';
              btn.addEventListener('click', ()=> openEditor(el, btn));
              el.insertAdjacentElement('afterend', btn);
            });

            function openEditor(valEl, btnEl){
              if(valEl.dataset.editing==='1') return;
              valEl.dataset.editing='1';

              const field = valEl.dataset.field;
              const type = valEl.dataset.type || inferType(field, valEl.tagName);
              const currentText = valEl.tagName==='A'
                ? (['mailto:','tel:'].some(p=> (valEl.getAttribute('href')||'').startsWith(p)) ? (valEl.textContent||'').trim() : (valEl.getAttribute('href')||'').trim())
                : (valEl.textContent||'').trim();
              const input = (type==='textarea') ? document.createElement('textarea') : document.createElement('input');
              input.className='form-control form-control-sm d-inline-block';
              if (field === 'gender') {
                input.readOnly = true;
              }
              if(type==='textarea'){ input.rows=3; }
              input.style.minWidth = '220px';
              if(type==='date'){ input.type='date'; input.value = toDateInputValue(currentText); }
              else if(type==='email'){ input.type='email'; input.value = currentText==='—' ? '' : currentText; }
              else if(type==='tel'){ input.type='tel'; input.value = currentText==='—' ? '' : currentText; }
              else if(type==='url'){ input.type='url'; input.value = currentText==='—' ? '' : currentText; }
              else { input.type='text'; input.value = currentText==='—' ? '' : currentText; }

              const save = document.createElement('button');
              save.type='button';
              save.className='btn btn-primary btn-sm ms-2';
              save.textContent='Lưu';

              const cancel = document.createElement('button');
              cancel.type='button';
              cancel.className='btn btn-outline-secondary btn-sm ms-1';
              cancel.textContent='Hủy';

              valEl.classList.add('d-none');
              btnEl.classList.add('d-none');
              valEl.parentElement.appendChild(input);
              valEl.parentElement.appendChild(save);
              valEl.parentElement.appendChild(cancel);
              input.focus();

              cancel.addEventListener('click', cleanup);
              save.addEventListener('click', async ()=>{
                const newVal = (input.value||'').trim();
                const payload = {}; payload[field] = newVal;
                save.disabled = cancel.disabled = true;
                try {
                  const r = await fetch(UPDATE_URL_BASE + encodeURIComponent(userId), {
                    method:'PUT',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                  });
                  if(!r.ok) throw new Error('Cập nhật thất bại: ' + r.status);
                  // Update UI in all mirrored places
                  document.querySelectorAll('#about-section .about-value[data-field="'+field+'"]').forEach(node=>applyValue(node, field, newVal));
                  // Persist
                  try{
                    const a = JSON.parse(localStorage.getItem('auth')||'{}')||{};
                    a[field] = newVal;
                    localStorage.setItem('auth', JSON.stringify(a));
                  }catch(_){}
                  cleanup();
                } catch(err) {
                  alert(err?.message || 'Lỗi');
                  save.disabled = cancel.disabled = false;
                }
              });

            function cleanup(){
              input.remove(); save.remove(); cancel.remove();
              valEl.classList.remove('d-none');
              btnEl.classList.remove('d-none');
              delete valEl.dataset.editing;
            }
          }

            function applyValue(el, field, val){
              if(el.tagName==='A'){
                if(field==='email'){ el.href = val ? ('mailto:'+val) : '#'; el.textContent = val || '—'; }
                else if(field==='phone'){ el.href = val ? ('tel:'+val) : '#'; el.textContent = val || '—'; }
                else { el.href = val || '#'; el.textContent = val || '—'; }
              }else{
                el.textContent = val || '—';
              }
            }

            function inferType(field){
              if(field==='bio') return 'textarea';
              if(field==='date_of_birth') return 'date';
              if(field==='email') return 'email';
              if(field==='phone') return 'tel';
              if(field==='website' || field.endsWith('_url')) return 'url';
              return 'text';
            }
            function toDateInputValue(v){
              if(!v || v==='—') return '';
              const d = new Date(v);
              if(Number.isNaN(d.getTime())) return '';
              const yyyy = d.getFullYear();
              const mm = String(d.getMonth()+1).padStart(2,'0');
              const dd = String(d.getDate()).padStart(2,'0');
              return `${yyyy}-${mm}-${dd}`;
            }
          })();
        </script>

        <style>
            .about-card{border-radius:14px;overflow:hidden;border:1px solid #e8edf3;box-shadow:0 10px 28px -16px rgba(13,110,253,.45)}
            .about-tabs{background:linear-gradient(135deg,#f7faff,#eef4ff);border-bottom:1px solid #e8edf3;gap:.35rem}
            .about-tabs .nav-link{position:relative;border:0;border-radius:10px;color:#59626d;font-weight:600;padding:.55rem .8rem;white-space:nowrap}
            .about-tabs .nav-link:hover{background:#f1f6ff;color:#0d5ef4}
            .about-tabs .nav-link.active{background:rgba(13,110,253,.08);color:#0d5ef4}
            .about-tabs .nav-link.active::after{content:"";position:absolute;left:12px;right:12px;bottom:-9px;height:3px;border-radius:3px;background:linear-gradient(90deg,#0d5ef4,#6aa9ff)}
            .about-card .tab-content{background:linear-gradient(180deg,#fff,#fafcff)}
            .about-section-title{font-weight:700;color:#2f3d53}
            .about-list{list-style:none;margin:0;padding:0}
            .about-row{display:flex;align-items:flex-start;gap:.75rem;padding:.5rem .65rem;border-radius:10px;transition:background .2s,transform .2s}
            .about-row:hover{background:#f5f8ff}
            .about-ic{flex:0 0 28px;width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;color:#0d5ef4;background:rgba(13,110,253,.08)}
            .about-label{min-width:120px;font-weight:600;color:#445169}
            .about-value{color:#59626d}
            .about-value a{text-decoration:none}
            @media (max-width:576px){.about-label{min-width:92px;font-size:.86rem}}
            .decor-spacer{position:relative;height:56px;margin-top:12px}
            .decor-spacer svg{position:absolute;inset:0;display:block;width:100%;height:100%}
            /* Inline edit icon */
            #about-section .edit-inline-btn{opacity:.5;transition:opacity .15s}
            #about-section .about-row:hover .edit-inline-btn{opacity:1}
        </style>

        <!-- >> Script xử lý cho Component About:Load thông tin -->
        <script>
          (function(){
            function setText(id, val, placeholder='—'){
              const el = document.getElementById(id);
              if(!el) return;
              el.textContent = (val && String(val).trim()) ? val : placeholder;
            }
            function setLink(id, url, text){
              const el = document.getElementById(id);
              if(!el) return;
              if(url && String(url).trim()){
                el.href = url;
                el.textContent = text || url;
              }else{
                el.removeAttribute('href');
                el.textContent = '—';
              }
            }
            function fmtDate(iso){
              if(!iso) return '—';
              try{
                const d = new Date(iso);
                if(Number.isNaN(d.getTime())) return iso;
                return d.toLocaleDateString();
              }catch(_){ return iso; }
            }
            function fillAbout(data){
              if(!data || typeof data!=='object') return;

              // Tổng quan
              setText('about-bio', data.bio);
              setText('about-workplace', data.workplace);
              setText('about-education', data.education);
              setText('about-city', data.city);
              setText('about-country', data.country);
              setLink('about-website', data.website, data.website);
              setText('about-joined', fmtDate(data.created_at || data.joined_at));

              // Công việc & Học vấn
              setText('about-workplace-2', data.workplace);
              setText('about-education-2', data.education);
              setText('about-school-id', data.school_id);
              setText('about-academic-year', data.academic_year);

              // Nơi từng sống
              setText('about-city-2', data.city);
              setText('about-country-2', data.country);

              // Liên hệ
              setLink('about-email', data.email ? 'mailto:'+data.email : '', data.email || '—');
              setLink('about-phone', data.phone ? 'tel:'+data.phone : '', data.phone || '—');
              setLink('about-website-2', data.website, data.website);

              // Chi tiết
              setText('about-full-name', data.full_name || [data.first_name, data.last_name].filter(Boolean).join(' '));
              setText('about-gender', data.gender);
              setText('about-dob', fmtDate(data.date_of_birth));
              setText('about-role', data.role);

              // Liên kết
              setLink('about-facebook', data.facebook_url, 'Facebook');
              setLink('about-instagram', data.instagram_url, 'Instagram');
              setLink('about-linkedin', data.linkedin_url, 'LinkedIn');
              setLink('about-twitter', data.twitter_url, 'Twitter');
            }

            // 1) Load từ localStorage trước
            let auth = {};
            try{ auth = JSON.parse(localStorage.getItem('auth') || '{}') || {}; }catch(_){ auth = {}; }
            fillAbout(auth);

            // 2) Cố gắng fetch từ server để đồng bộ mới nhất
            const userId = auth?.id || auth?.user_id;
            if(userId){
              fetch('/api/users/' + encodeURIComponent(userId), {
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'include'
              }).then(r => r.ok ? r.json() : null)
                .then(data => data && fillAbout(data))
                .catch(()=>{});
            }

            // Equalize About tab heights to the tallest one
            (function(){
              const aboutSection = document.getElementById('about-section');
              const panesSelector = '#about-section .tab-pane';
              const debounce = (fn, wait=120) => {
                let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(null,a), wait); };
              };
              const isVisible = el => !!el && getComputedStyle(el).display !== 'none' && getComputedStyle(el).visibility !== 'hidden';
              function measurePane(pane){
                const wasActive = pane.classList.contains('active') && getComputedStyle(pane).display !== 'none';
                if (wasActive) return pane.scrollHeight;

                const prev = { position: pane.style.position, visibility: pane.style.visibility, display: pane.style.display };
                pane.style.position = 'absolute';
                pane.style.visibility = 'hidden';
                pane.style.display = 'block';
                const h = pane.scrollHeight;
                pane.style.position = prev.position;
                pane.style.visibility = prev.visibility;
                pane.style.display = prev.display;
                return h;
              }
              const recalc = debounce(function(){
                if (!isVisible(aboutSection)) return;
                const panes = document.querySelectorAll(panesSelector);
                if (!panes.length) return;
                let maxH = 0;
                panes.forEach(p => { maxH = Math.max(maxH, measurePane(p)); });
                if (maxH > 0) panes.forEach(p => { p.style.minHeight = maxH + 'px'; });
              }, 80);
              document.querySelector('#profile-tabs .nav-link[data-tab="about"]')?.addEventListener('click', ()=> setTimeout(recalc, 0));
              if (aboutSection) {
                new MutationObserver(()=> setTimeout(recalc, 0))
                  .observe(aboutSection, { attributes: true, attributeFilter: ['class'] });
                new MutationObserver(recalc)
                  .observe(aboutSection, { childList: true, subtree: true, characterData: true });
                document.getElementById('aboutTabs')?.addEventListener('shown.bs.tab', recalc);
                aboutSection.querySelectorAll('img').forEach(img => { if (!img.complete) img.addEventListener('load', recalc, { once: true }); });
              }
              window.addEventListener('resize', recalc);
              setTimeout(recalc, 0);
            })();
          })();
        </script>

        <div class="decor-spacer" aria-hidden="true">
          <svg viewBox="0 0 1440 80" preserveAspectRatio="none" role="img" focusable="false">
            <defs>
              <linearGradient id="decorWaveGradient_about" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#ffffff"/>
                <stop offset="100%" stop-color="#f0f2f5"/>
              </linearGradient>
            </defs>
            <path d="M0,32 C240,64 480,0 720,24 C960,48 1200,80 1440,48 L1440,80 L0,80 Z" fill="url(#decorWaveGradient_about)"></path>
          </svg>
        </div>

      </section>
      <!-- About:END -->

      <!-- Friends:BEGIN -->
      <section class="col-12 col-lg-11 mb-4 d-none" id="friends-section" th:attr="data-user-id=${viewingUserId}">

        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">Bạn bè</h5>
          <div class="small text-muted"><span id="friends-result-count">0</span>/<span id="friends-count">0</span></div>
        </div>

        <div class="friends-toolbar mb-3">
          <div class="row g-2 align-items-center">
        <div class="col-12 col-md-8">
          <div class="search-wrap">
            <i class="bi bi-search"></i>
            <input id="friends-search" class="form-control search-input" type="search" placeholder="Tìm bạn bè theo tên...">
            <button id="friends-clear" class="clear-btn d-none" aria-label="Xóa tìm kiếm"><i class="bi bi-x-circle"></i></button>
          </div>
        </div>
        <div class="col-12 col-md-4 text-md-end">
          <select id="friends-sort" class="form-select form-select-sm w-auto ms-md-auto">
            <option value="name-asc">Tên (A→Z)</option>
            <option value="name-desc">Tên (Z→A)</option>
            <option value="recent">Mới thêm</option>
          </select>
        </div>
          </div>
        </div>

        <div id="friends-grid" class="row g-3"></div>
        <div id="friends-empty" class="text-center text-muted py-4 d-none">Không tìm thấy bạn bè phù hợp.</div>

      </section>
      <style>
          #friends-section .friends-toolbar{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.6rem .8rem}
          #friends-section .search-input{background:#f5f7fb;border:none;border-radius:20px;padding:.5rem 2.2rem .5rem 2.2rem;width:100%}
          #friends-section .search-wrap{position:relative}
          #friends-section .search-wrap .bi-search{position:absolute;left:.75rem;top:50%;transform:translateY(-50%);color:#6b7280}
          #friends-section .search-wrap .clear-btn{position:absolute;right:.5rem;top:50%;transform:translateY(-50%);border:0;background:transparent;color:#6b7280}
          #friends-section .friend-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;transition:all .18s}
          #friends-section .friend-card:hover{border-color:#cfe2ff;box-shadow:0 8px 20px -12px rgba(13,110,253,.5);transform:translateY(-2px)}
          #friends-section .friend-avatar{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}
          #friends-section .friend-name{font-weight:600;color:#111827}
          #friends-section .friend-meta{color:#6b7280;font-size:.875rem}
          #friends-section .placeholder-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
          #friends-section .ph-img{background:#e5e7eb;width:100%;aspect-ratio:1/1}
          #friends-section .ph-line{height:10px;background:#e5e7eb;border-radius:8px}
      </style>
      <!-- >> Script xử lý Friends -->
      <script>
        (function(){
            const section = document.getElementById('friends-section');
            if(!section) return;

            const userId = section.dataset.userId || (function(){try{return JSON.parse(localStorage.getItem('auth')||'{}')?.id}catch(_){return ''}})();
            console.log('Friends Section for User ID:', userId);
            const grid   = document.getElementById('friends-grid');
            const empty  = document.getElementById('friends-empty');
            const search = document.getElementById('friends-search');
            const clear  = document.getElementById('friends-clear');
            const sortEl = document.getElementById('friends-sort');
            const totalEl= document.getElementById('friends-count');
            const resultEl=document.getElementById('friends-result-count');

            let fullList = [];
            let filtered = [];

            const norm = (s)=> (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
            const safeHtml = (s)=> (s||'').toString()
              .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
              .replace(/"/g,'&quot;').replace(/'/g,'&#39;');

            function renderSkeleton(n=8){
              grid.innerHTML='';
              for(let i=0;i<n;i++){
                const col = document.createElement('div');
                col.className='col-6 col-md-4 col-lg-3';
                col.innerHTML=`
              <div class="placeholder-card">
                <div class="ph-img"></div>
                <div class="p-2">
                  <div class="ph-line mb-2" style="width:70%"></div>
                  <div class="ph-line" style="width:45%"></div>
                </div>
              </div>`;
                grid.appendChild(col);
              }
            }

            const pickUser = (item)=> item?.friend_info || item || {};
            function pickName(item){
              const u = pickUser(item);
              return u.full_name || u.fullName || [u.first_name,u.last_name].filter(Boolean).join(' ') || u.name || u.username || 'Người dùng';
            }
            function pickAvatar(item){
              const u = pickUser(item);
              return u.avatar_url || u.avatarUrl || u.avatar || '/img/image1.png';
            }
            function pickId(item){
              const u = pickUser(item);
              return u.id ?? u.user_id ?? u.uid ?? '';
            }
            function pickAddedAt(item){
              // prefer relation created_at
              return item?.created_at || pickUser(item)?.created_at || '';
            }

            function render(list){
              grid.innerHTML='';
              if(!list.length){
                empty.classList.remove('d-none');
                resultEl.textContent='0';
                return;
              }
              empty.classList.add('d-none');
              resultEl.textContent=String(list.length);

              const frag = document.createDocumentFragment();
              list.forEach(item=>{
                const id   = pickId(item);
                const name = pickName(item);
                const ava  = pickAvatar(item);
                const mutual = 0;

                const col = document.createElement('div');
                col.className='col-6 col-md-4 col-lg-3';
                col.innerHTML = `
                  <div class="friend-card h-100">
                    <a class="text-decoration-none d-block" data-user-id="${safeHtml(id)}">
                      <img class="friend-avatar" src="${safeHtml(ava)}" alt="${safeHtml(name)}">
                      <div class="p-2">
                    <div class="friend-name text-truncate">${safeHtml(name)}</div>
                    <div class="friend-meta text-truncate">${mutual? safeHtml(mutual)+' bạn chung' : '&nbsp;'}</div>
                      </div>
                    </a>
                  </div>`;
                const a = col.querySelector('a');
                a.addEventListener('click', (e)=>{
                e.preventDefault();
                if(!id) return;
                window.location.href = '/user/' + encodeURIComponent(id);
                  });
                  frag.appendChild(col);
              });
              grid.appendChild(frag);
            }

            function applyFilters(){
              const q = norm(search.value);
              const sortBy = (sortEl.value||'name-asc');

              filtered = !q ? [...fullList] : fullList.filter(item=>{
                const name = norm(pickName(item));
                const uname = norm(pickUser(item).username||'');
                return name.includes(q) || uname.includes(q);
              });

              if(sortBy === 'name-asc' || sortBy === 'name-desc'){
                filtered.sort((a,b)=>{
              const an = norm(pickName(a));
              const bn = norm(pickName(b));
              return sortBy==='name-asc' ? an.localeCompare(bn) : bn.localeCompare(an);
                });
              }else if(sortBy === 'recent'){
                filtered.sort((a,b)=> new Date(pickAddedAt(b)) - new Date(pickAddedAt(a)));
              }

              render(filtered);
            }

            function setCounts(total){
              totalEl.textContent = String(total);
              resultEl.textContent= String(filtered.length || total);
              document.getElementById('user-friend-count')?.textContent = String(total);
            }

            const debounce = (fn, wait=200)=>{
              let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), wait); };
            };

            const debouncedFilter = debounce(applyFilters, 180);

            search.addEventListener('input', ()=>{
              clear.classList.toggle('d-none', !search.value);
              debouncedFilter();
            });
            clear.addEventListener('click', ()=>{
              search.value='';
              clear.classList.add('d-none');
              applyFilters();
            });
            sortEl.addEventListener('change', applyFilters);

            async function load(){
              renderSkeleton();
              try{
                const uid = userId || '';
                if(!uid){ throw new Error('Thiếu userId.'); }
                const url = `/api/friends/${encodeURIComponent(uid)}`;
                const r = await fetch(url, {
                  headers:{ 'X-Requested-With':'XMLHttpRequest', 'Accept':'application/json' },
                  credentials:'include'
                });
                if(!r.ok) throw new Error('Không tải được danh sách bạn bè.');
                const data = await r.json();
                const items = Array.isArray(data) ? data : [];
                fullList = items;
                setCounts(items.length);
                applyFilters();
              }catch(e){
                grid.innerHTML = `<div class="col-12"><div class="alert alert-warning mb-0">${e?.message||'Có lỗi xảy ra.'}</div></div>`;
                setCounts(0);
                empty.classList.add('d-none');
              }
            }

            // Load when Friends tab is shown
            const friendsTab = document.querySelector('#profile-tabs .nav-link[data-tab="friends"]');
            let loaded = false;
            friendsTab?.addEventListener('click', ()=>{
              if(!loaded){ loaded = true; load(); }
            });
            if(friendsTab?.classList.contains('active')){
              loaded = true; load();
            }
          })();
        </script>
      <!-- Friends:END -->

      <!-- Photos:BEGIN -->
      <section class="col-12 col-lg-11 mb-4 d-none" id="photos-section">
        <h1>Photos</h1>
      </section>
      <!-- Photos:END -->

      <!-- Right sidebar:END -->
      <!-- <aside class="col-12 col-lg-3 mb-4 right-col">

        
      </aside> -->
      <!-- Right sidebar:END -->

    </div>
  </main>

  <script>
    // Script load thêm bài viết khi cuộn đến cuối trang
    // ? Mặc dù load toàn bộ bài viết luôn ngay lúc đầu rồi, nhưng giữ lại đoạn này để tham khảo sau
    (function(){
      const ta=document.querySelector('.composer textarea');
      if(ta){
        ta.addEventListener('input',()=>{ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';});
      }
      const sentinel=document.getElementById('feed-end');
      if(!sentinel) return;
      let loading=false;
      async function loadMore(){
        if(loading) return;
        loading=true;
        try{
          const lastId=[...document.querySelectorAll('article[data-id]')].pop()?.dataset.id||'';
          const r=await fetch('/posts?after='+encodeURIComponent(lastId), {headers:{'X-Requested-With':'XMLHttpRequest'}});
          if(r.ok){
            const html=await r.text();
            if(html.trim()){
              sentinel.insertAdjacentHTML('beforebegin', html);
            }else{
              sentinel.textContent='No more posts';
              observer.disconnect();
            }
          }
        }catch(e){console.error(e);}
        loading=false;
      }
      const observer=new IntersectionObserver(entries=>{
        if(entries.some(e=>e.isIntersecting)) loadMore();
      },{rootMargin:'400px'});
      observer.observe(sentinel);
    })();
  </script>
  

  <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>